<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{SYSTEM_NAME}}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <style>
    :root {
        --primary-color: {{THEME_COLOR}};
        --secondary-color: #4CAF50;
        --blue-color: #2196F3;
        --red-color: #F44336;
        --yellow-color: #FFC107;
        --orange-color: #FF9800;
        --gray-color: #9E9E9E;
        --pastel-blue: #BFDBFE;
        --pastel-pink: #FBCFE8;
        --pastel-green: #BBF7D0;
        --pastel-red: #FECACA;
        --pastel-yellow: #FEF3C7;
        --light-gray: #E5E7EB;
        --table-header-gray: #F3F4F6;
        /* New colors for modern dashboard */
        --card-bg: #FFFFFF;
        --text-primary: #1F2937;
        --text-secondary: #6B7280;
        --icon-blue: #3B82F6;
        --icon-green: #10B981;
        --icon-red: #EF4444;
        --icon-yellow: #F59E0B;
        --icon-pink: #EC4899;
    }
    body {
        font-family: 'Sarabun', sans-serif;
        background-color: #f8f9fa;
    }
.version-display {
    color: #4B5563;
    font-weight: 600;
    font-size: 0.9rem; /* ขนาดตัวอักษรพื้นฐาน */
    text-align: right; /* ชิดขวา */
}

/* ปรับแต่งตามขนาดหน้าจอ */
@media (max-width: 640px) { /* Breakpoint สำหรับมือถือ */
    .version-display {
        font-size: 0.75rem; /* ขนาดตัวอักษรเล็กลงสำหรับมือถือ */
        text-align: right; /* คงชิดขวาในมือถือ */
        padding-right: 0.5rem; /* ระยะห่างจากขอบขวา */
    }
}

@media (min-width: 641px) { /* หน้าจอใหญ่กว่ามือถือ */
    .version-display {
        font-size: 0.9rem; /* ขนาดตัวอักษรปกติ */
        padding-right: 1rem; /* ระยะห่างจากขอบขวา */
    }
}
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .nav-tab {
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
    }
    .nav-tab.active {
        border-bottom: 3px solid var(--primary-color);
        background-color: var(--primary-color);
        color: white;
        font-weight: bold;
        border-radius: 12px;
        padding: 8px 16px;
    }
    .nav-tab:hover:not(.active) {
        border-bottom: 3px solid var(--secondary-color);
        color: var(--secondary-color);
    }

/* --- START: ADDED FOR STUDENT VIEW TABS --- */
.login-tab {
    cursor: pointer;
    padding: 0.75rem 1rem;
    border-bottom: 3px solid transparent;
    color: #6B7280;
}
.login-tab.active {
    border-bottom-color: var(--primary-color);
    color: var(--primary-color);
    font-weight: 700;
}
/* --- END: ADDED FOR STUDENT VIEW TABS --- */

    /* --- NEW DASHBOARD STYLES START --- */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .stat-card-new {
        background-color: var(--card-bg);
        border-radius: 1rem; /* 16px */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        padding: 1.5rem; /* 24px */
        display: flex;
        align-items: center;
        gap: 1rem; /* 16px */
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0; /* Start hidden for animation */
    }
    .stat-card-new:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .stat-card-new .stat-icon {
        flex-shrink: 0;
        width: 3.5rem; /* 56px */
        height: 3.5rem; /* 56px */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .stat-card-new:nth-child(1) .stat-icon { background-color: #DBEAFE; color: var(--icon-blue); }
    .stat-card-new:nth-child(2) .stat-icon { background-color: #D1FAE5; color: var(--icon-green); }
    .stat-card-new:nth-child(3) .stat-icon { background-color: #FEE2E2; color: var(--icon-red); }
    .stat-card-new:nth-child(4) .stat-icon { background-color: #FEF3C7; color: var(--icon-yellow); }
    .stat-card-new:nth-child(5) .stat-icon { background-color: #FCE7F3; color: var(--icon-pink); }
    .stat-card-new .stat-icon svg {
        width: 1.75rem; /* 28px */
        height: 1.75rem; /* 28px */
    }
    .stat-card-new .stat-info h3 {
        color: var(--text-secondary);
        font-size: 0.875rem; /* 14px */
        font-weight: 500;
        margin-bottom: 0.25rem; /* 4px */
    }
    .stat-card-new .stat-info p {
        color: var(--text-primary);
        font-size: 2.25rem; /* 36px */
        font-weight: 700;
        line-height: 1;
    }
    .chart-container {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0; /* Start hidden */
    }
    .chart-container:nth-child(1) { animation-delay: 0.35s; } /* Delay for charts */
    .chart-container:nth-child(2) { animation-delay: 0.4s; }
    /* Staggered animation for stat cards */
    .stat-card-new:nth-child(1) { animation-delay: 0.1s; }
    .stat-card-new:nth-child(2) { animation-delay: 0.15s; }
    .stat-card-new:nth-child(3) { animation-delay: 0.2s; }
    .stat-card-new:nth-child(4) { animation-delay: 0.25s; }
    .stat-card-new:nth-child(5) { animation-delay: 0.3s; }
    /* --- NEW DASHBOARD STYLES END --- */
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { filter: brightness(90%); }
    .btn-secondary { background-color: var(--secondary-color); color: white; }
    .btn-secondary:hover { background-color: #3d8b40; }
    .btn-danger { background-color: var(--red-color); color: white; }
    .btn-danger:hover { background-color: #d32f2f; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
    table { width: 100%; border-collapse: collapse; border: 1px solid var(--light-gray); }
    th, td { padding: 12px; text-align: left; border: 1px solid var(--light-gray); }
    th { background-color: #f2f2f2; }
    tr:hover { background-color: #f5f5f5; }
    #report-table th:nth-child(1),
    #report-table th.date-column,
    #classroom-report-table th:not(.present-column):not(.absent-column):not(.leave-column):not(.late-column),
    #school-report-table th:not(.present-column):not(.absent-column):not(.leave-column):not(.late-column) { background-color: var(--table-header-gray); }
    .present-column { background-color: var(--pastel-green); }
    .absent-column { background-color: var(--pastel-red); }
    .leave-column { background-color: var(--pastel-yellow); }
    .late-column { background-color: var(--pastel-pink); }
    .attendance-present { background-color: var(--secondary-color); color: white; }
    .attendance-absent { background-color: var(--red-color); color: white; }
    .attendance-leave { background-color: var(--yellow-color); color: black; }
    .attendance-late { background-color: #FF69B4; color: white; }
    .attendance-none { background-color: var(--gray-color); color: white; }
    .mark-late { background-color: #FF69B4 !important; color: white; }
    .mark-late:hover { filter: brightness(90%) !important; }
    .loading { display: none; position: fixed; z-index: 1100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); }
    .loading-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .loading-content p {
    color: var(--primary-color);
}
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error { color: var(--red-color); font-size: 0.8rem; margin-top: 5px; }
    .select2-container--default .select2-selection--multiple { border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; }
    .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: var(--primary-color); color: white; border: none; }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: white; }
    .remark-input { width: 100%; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; }
    .summary-report { background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 16px; margin-top: 16px; }
    .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; }
    .pagination button { background-color: var(--primary-color); color: white; border: none; padding: 8px 12px; margin: 0 5px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
    .pagination button:hover { filter: brightness(90%); }
    .pagination button.active { background-color: var(--secondary-color); }
    .pagination button:disabled { background-color: var(--gray-color); cursor: not-allowed; }
    .pagination span { margin: 0 10px; font-size: 1rem; color: #333333; }
    
    /* Theme Selector Styles */
    .theme-selector .theme-button {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.3s;
    }
    .theme-selector .theme-button.active {
        border-color: #333;
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }

/* --- ส่วนหัวของรายงาน (จะไม่ถูกเลื่อน) --- */
#monthly-report-header {
    background-color: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    text-align: center;
}

/* --- Container ที่คลุมตารางและทำให้เกิด Scrollbar --- */
#monthly-report-results .overflow-x-auto {
    max-height: 70vh; /* ปรับค่าลงเล็กน้อยเพื่อเพิ่มพื้นที่ให้ footer */
    overflow: auto;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    position: relative; /* เพิ่มบรรทัดนี้ เพื่อสร้าง "กรอบ" */
    z-index: 0;         /* เพิ่มบรรทัดนี้ เพื่อควบคุมการซ้อนทับกับส่วนอื่น */
}

/* --- สไตล์ของตาราง --- */
#monthly-report-table {
    border-collapse: separate;
    border-spacing: 0;
}

#monthly-report-table th,
#monthly-report-table td {
    padding: 8px 12px;
    white-space: nowrap;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
    vertical-align: middle;
}
#monthly-report-table td:nth-child(3) {
    text-align: left; /* ทำให้ชื่อ-สกุล ชิดซ้าย */
}

/* =====================================
    หัวใจหลักของการทำให้ Sticky ทำงาน
  =====================================
*/

/* 1. กำหนดให้ Thead ทั้งหมดเป็นแถบที่ตรึงอยู่ด้านบน และมี z-index สูงสุด */
#monthly-report-table > thead {
    position: sticky;
    top: 0;
    z-index: 2; 
}

/* 2. กำหนดให้คอลัมน์ที่ต้องการ ตรึงซ้าย/ขวา และกำหนดขนาดที่แน่นอน */
/* คอลัมน์ซ้าย */
#monthly-report-table tr > *:nth-child(1)  { position: sticky; left: 0; width: 60px; min-width: 60px; }
#monthly-report-table tr > *:nth-child(2)  { position: sticky; left: 60px; width: 120px; min-width: 120px; }
#monthly-report-table tr > *:nth-child(3)  { position: sticky; left: 180px; width: 180px; min-width: 180px; }
/* คอลัมน์ขวา */
#monthly-report-table tr > *:nth-last-child(-n+4) { position: sticky; width: 60px; min-width: 60px; }
#monthly-report-table tr > *:nth-last-child(4) { right: 180px; }
#monthly-report-table tr > *:nth-last-child(3) { right: 120px; }
#monthly-report-table tr > *:nth-last-child(2) { right: 60px; }
#monthly-report-table tr > *:nth-last-child(1) { right: 0; }

/* 3. กำหนดสีพื้นหลังและ z-index ของแต่ละส่วน */
/* หัวตารางทั้งหมด */
#monthly-report-table thead th {
    background-color: #F3F4F6;
}
/* คอลัมน์ข้อมูล (td) ที่ถูกตรึงด้านซ้าย ให้มีพื้นหลังสีขาว */
#monthly-report-table tbody td:nth-child(-n+3) {
    background-color: white;
}
/* สำหรับ TD ด้านขวา จะใช้สีจากคลาส .present-column อยู่แล้ว */

/* จัดการ z-index เพื่อแก้ปัญหาการซ้อนทับ */
/* ให้คอลัมน์ที่ตรึงด้านข้าง มี z-index สูงกว่าเนื้อหาปกติ */
#monthly-report-table tr > *:nth-child(-n+3),      /* 3 คอลัมน์ซ้าย (ทั้ง th, td) */
#monthly-report-table tr > *:nth-last-child(-n+4)  /* 4 คอลัมน์ขวา (ทั้ง th, td) */
{
    z-index: 1;
}

/* --- Report Header (Non-sticky) --- */
.report-header {
    background-color: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    text-align: center;
}

/* --- Report Table Container (for Scrolling) --- */
.report-table-container {
    max-height: 70vh;
    overflow: auto;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    position: relative;
    z-index: 0;
}

/* --- Report Table Base Styles --- */
.report-table {
    border-collapse: separate;
    border-spacing: 0;
}

.report-table th,
.report-table td {
    padding: 8px 12px;
    white-space: nowrap;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
    vertical-align: middle;
}
.report-table td:nth-child(3) {
    text-align: left;
}

/* =====================================
    STICKY HEADER/COLUMN LOGIC
   ===================================== */
.report-table > thead {
    position: sticky;
    top: 0;
    z-index: 2; 
}

.report-table thead th {
    background-color: #F3F4F6;
}

.report-table tr > *:nth-child(-n+3),
.report-table tr > th:nth-last-child(-n+2), /* Score Report: last 2 TH sticky */
.report-table tr > td:nth-last-child(-n+2)  { /* Score Report: last 2 TD sticky */
    position: sticky;
    z-index: 1;
}

/* Left Sticky Columns */
.report-table tr > *:nth-child(1) { left: 0; }
.report-table tr > *:nth-child(2) { left: 60px; }
.report-table tr > *:nth-child(3) { left: 180px; }
.report-table tbody td:nth-child(-n+3) { background-color: white; }


/* Right Sticky Columns (for monthly report) */
#monthly-report-table tr > *:nth-last-child(4) { right: 180px; }
#monthly-report-table tr > *:nth-last-child(3) { right: 120px; }
#monthly-report-table tr > *:nth-last-child(2) { right: 60px; }
#monthly-report-table tr > *:nth-last-child(1) { right: 0; }



/* Right Sticky Columns (for score report) */
#score-report-table tr > *:nth-last-child(2) { right: 80px; } /* Total Score Column */
#score-report-table tr > *:nth-last-child(1) { right: 0; } /* Grade Column */
#score-report-table tr > td:nth-last-child(-n+2) { background-color: #fdfdfd; font-weight: bold; } /* Add light bg to sticky right columns */

.vertical-header {
    height: 180px; /* กำหนดความสูงของหัวข้อแนวตั้ง */
    white-space: nowrap;
    text-align: center;
    vertical-align: bottom; /* จัดเนื้อหาในเซลล์ให้อยู่ด้านล่าง */
    padding: 4px;
    padding-bottom: 8px; /* เพิ่ม padding ด้านล่างเล็กน้อยเพื่อให้สวยงาม */
}

.vertical-header > div {
    transform: rotate(-90deg);
    /* เปลี่ยน transform-origin เพื่อให้จุดหมุนอยู่ที่ด้านล่าง ทำให้ข้อความชิดขอบล่างเมื่อหมุน */
    transform-origin: bottom center;
    /* กำหนดความกว้างให้สัมพันธ์กับความสูงของ parent เพื่อให้ข้อความไม่ล้น */
    width: 40px; 
    position: relative;
    bottom: -55px; /* ปรับตำแหน่งเล็กน้อยเพื่อความสวยงาม */
}

</style>
</head>
<body>
<div id="pre-choice-overlay" class="fixed top-0 left-0 w-full h-full bg-white z-20" style="display: none;"></div>
<header class="bg-pink-200 py-2 shadow-md">
    <div class="container mx-auto px-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <img src="{{LOGO_URL}}" alt="โลโก้โรงเรียน" class="h-12 w-auto">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800 hidden sm:block">{{HEADER_TEXT}}</h1>
        </div>

        <div class="flex items-center space-x-4">
            <div class="version-display">Version 1.0</div>
            <button id="back-to-choice-btn" title="กลับไปหน้าเลือกเมนูหลัก" class="hidden bg-white text-gray-600 hover:bg-gray-200 rounded-full p-2 focus:outline-none focus:ring-2 focus:ring-offset-2" style="--tw-ring-color: var(--primary-color);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9.95 2.05a1 1 0 00-1.414 0L1.293 9.293a1 1 0 001.414 1.414L9 4.414V17a1 1 0 102 0V4.414l6.293 6.293a1 1 0 001.414-1.414l-8-8z" clip-rule="evenodd" />
                </svg>
            </button>
            <span id="user-info" class="text-gray-700 hidden md:inline"></span>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">ออกจากระบบ</button>
        </div>
    </div>
</header>
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4">
            <div id="nav-tabs" class="flex flex-wrap justify-center md:justify-start space-x-1 md:space-x-6 py-4">
                <div class="nav-tab active px-3 py-2" data-tab="dashboard">แดชบอร์ด</div>
            </div>
        </div>
    </nav>
    <main class="container mx-auto px-4 py-6 pb-20">
       <div id="dashboard" class="tab-content active">
    
    <div id="attendance-dashboard-view">
        <h2 class="text-3xl font-bold mb-6 text-gray-800" style="animation: fadeInUp 0.5s ease-out forwards; opacity: 0;">ภาพรวมการเข้าเรียนวันนี้</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 1 1 7.5 0 3.75 3.75 0 0 1-7.5 0ZM15.75 9.75a3 3 0 1 1 6 0 3 3 0 0 1-6 0ZM2.25 9.75a3 3 0 1 1 6 0 3 3 0 0 1-6 0ZM6.31 15.117A6.745 6.745 0 0 1 12 12a6.745 6.745 0 0 1 6.709 7.498.75.75 0 0 1-.372.568A12.696 12.696 0 0 1 12 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 0 1-.372-.568 6.787 6.787 0 0 1 1.019-4.38Z" clip-rule="evenodd" />
  <path d="M5.082 14.254a8.287 8.287 0 0 0-1.308 5.135 9.687 9.687 0 0 1-1.764-.44l-.115-.04a.563.563 0 0 1-.373-.487l-.01-.121a3.75 3.75 0 0 1 3.57-4.047ZM20.226 19.389a8.287 8.287 0 0 0-1.308-5.135 3.75 3.75 0 0 1 3.57 4.047l-.01.121a.563.563 0 0 1-.373.486l-.115.04c-.567.2-1.156.349-1.764.441Z" />
</svg></div>
                <div class="stat-info"><h3>นักเรียนทั้งหมด</h3><p id="total-students">0</p></div>
            </div>
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div class="stat-info"><h3>มาเรียนวันนี้</h3><p id="present-students">0</p></div>
            </div>
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div class="stat-info"><h3>ขาดเรียนวันนี้</h3><p id="absent-students">0</p></div>
            </div>
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg></div>
                <div class="stat-info"><h3>ลาวันนี้</h3><p id="leave-students">0</p></div>
            </div>
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div class="stat-info"><h3>มาสายวันนี้</h3><p id="late-students">0</p></div>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
            <div class="lg:col-span-2 chart-container">
                <h3 class="text-xl font-bold mb-4 text-gray-700">สถิติการมาเรียนวันนี้</h3>
                <div class="relative" style="height: 300px;"><canvas id="attendance-pie-chart"></canvas></div>
            </div>
            <div class="lg:col-span-3 chart-container">
                <h3 class="text-xl font-bold mb-4 text-gray-700">5 อันดับนักเรียนที่มาเรียนสูงสุด</h3>
                <div class="relative" style="height: 300px;"><canvas id="top-present-bar-chart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="scoring-dashboard-view" class="hidden">
        <h2 class="text-3xl font-bold mb-6 text-gray-800" style="animation: fadeInUp 0.5s ease-out forwards; opacity: 0;">ภาพรวมผลการเรียน</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z" clip-rule="evenodd" />
  <path fill-rule="evenodd" d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375ZM6 12a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V12Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 15a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V15Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 18a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V18Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
</svg></div>
                <div class="stat-info"><h3>คะแนนเฉลี่ยรวม</h3><p id="score-avg">0.00</p></div>
            </div>
             <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M2.25 4.5A.75.75 0 0 1 3 3.75h14.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Zm14.47 3.97a.75.75 0 0 1 1.06 0l3.75 3.75a.75.75 0 1 1-1.06 1.06L18 10.81V21a.75.75 0 0 1-1.5 0V10.81l-2.47 2.47a.75.75 0 1 1-1.06-1.06l3.75-3.75ZM2.25 9A.75.75 0 0 1 3 8.25h9.75a.75.75 0 0 1 0 1.5H3A.75.75 0 0 1 2.25 9Zm0 4.5a.75.75 0 0 1 .75-.75h5.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
</svg>
</div>
                <div class="stat-info"><h3>คะแนนสูงสุด</h3><p id="score-max">0</p></div>
            </div>
             <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M2.25 4.5A.75.75 0 0 1 3 3.75h14.25a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Zm0 4.5A.75.75 0 0 1 3 8.25h9.75a.75.75 0 0 1 0 1.5H3A.75.75 0 0 1 2.25 9Zm15-.75A.75.75 0 0 1 18 9v10.19l2.47-2.47a.75.75 0 1 1 1.06 1.06l-3.75 3.75a.75.75 0 0 1-1.06 0l-3.75-3.75a.75.75 0 1 1 1.06-1.06l2.47 2.47V9a.75.75 0 0 1 .75-.75Zm-15 5.25a.75.75 0 0 1 .75-.75h9.75a.75.75 0 0 1 0 1.5H3a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
</svg>
</div>
                <div class="stat-info"><h3>คะแนนต่ำสุด</h3><p id="score-min">0</p></div>
            </div>
            <div class="stat-card-new">
                <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg></div>
                <div class="stat-info"><h3>นักเรียนที่ประเมิน</h3><p id="score-graded-students">0</p></div>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
            <div class="lg:col-span-2 chart-container">
                <h3 class="text-xl font-bold mb-4 text-gray-700">การกระจายของเกรด</h3>
                <div class="relative" style="height: 300px;"><canvas id="grade-distribution-pie-chart"></canvas></div>
            </div>
            <div class="lg:col-span-3 chart-container">
                <h3 class="text-xl font-bold mb-4 text-gray-700">คะแนนเฉลี่ยแต่ละองค์ประกอบ</h3>
                <div class="relative" style="height: 300px;"><canvas id="component-average-bar-chart"></canvas></div>
            </div>
        </div>
    </div>
</div>

        <div id="subjects" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">จัดการรายวิชา</h2>
                <div class="space-x-2">
                    <button id="download-subjects-template" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        ดาวน์โหลดเทมเพลต (.CSV)
                    </button>
                    <button id="import-subjects-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        นำเข้ารายวิชา
                    </button>
                    <button id="add-subject-btn" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg">
                        เพิ่มรายวิชา
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <table id="subjects-table">
    <thead>
        <tr>
            <th>ลำดับ</th>
            <th>รหัสวิชา</th>
            <th>ชื่อรายวิชา</th>
            <th>หน่วยกิต</th>
            <th>จัดการ</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
            </div>
        </div>
        <div id="teachers" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">จัดการครูผู้สอน</h2>
                <button id="add-teacher-btn" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg">
                    เพิ่มครู
                </button>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <table id="teachers-table">
    <thead>
        <tr>
            <th>ลำดับ</th>
            <th>ชื่อ-นามสกุล</th>
            <th>ชื่อผู้ใช้</th>
            <th>รายวิชา</th>
            <th>ระดับชั้น</th>
            <th>ห้องเรียน</th>
            <th>สถานะ</th>
            <th>จัดการ</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
            </div>
        </div>
        <div id="students" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">จัดการนักเรียน</h2>
                <div class="space-x-2" id="student-actions">
                    <button id="download-students-template" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg" style="display: none;">
                        ดาวน์โหลดเทมเพลต (.CSV)
                    </button>
                    <button id="import-students-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg" style="display: none;">
                        นำเข้านักเรียน
                    </button>
                    <button id="add-student-btn" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg" style="display: none;">
                        เพิ่มนักเรียน
                    </button>
                </div>
            </div>
            <div id="student-filters" class="bg-white rounded-lg shadow p-6 mb-6" style="display: none;">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
        <div class="lg:col-span-2">
            <label class="block text-gray-700 mb-2">ค้นหานักเรียน</label>
            <input type="text" id="student-search" class="w-full px-3 py-2 border rounded-lg" placeholder="รหัสหรือชื่อนักเรียน">
        </div>
        <div>
            <label class="block text-gray-700 mb-2">ระดับชั้น</label>
            <select id="student-filter-class" class="w-full px-3 py-2 border rounded-lg">
                <option value="all">ทุกระดับชั้น</option>
            </select>
        </div>
        <div>
            <label class="block text-gray-700 mb-2">ห้องเรียน</label>
            <select id="student-filter-classroom" class="w-full px-3 py-2 border rounded-lg">
                <option value="">ทุกห้องเรียน</option>
            </select>
        </div>
        <button id="filter-students" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg w-full mt-2 lg:mt-0">
            ค้นหา
        </button>
    </div>
</div>
            <div id="students-table-container" class="bg-white rounded-lg shadow p-4">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th>ลำดับ</th>
                            <th>รหัสนักเรียน</th>
                            <th>ชื่อ-นามสกุล</th>
                            <th>ระดับชั้น</th>
                            <th>ห้อง</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div id="attendance" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">จัดการเช็คเวลาเรียน</h2>
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">วันที่</label>
                        <input type="date" id="attendance-date" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">รายวิชา</label>
                        <select id="attendance-subject" class="w-full px-3 py-2 border rounded-lg">
                            <option value="all">ทุกรายวิชา</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                        <select id="attendance-class" class="w-full px-3 py-2 border rounded-lg">
                            <option value="all">ทุกระดับชั้น</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                        <select id="attendance-classroom" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกห้องเรียน</option>
                        </select>
                    </div>
                </div>
                <div class="text-center">
                    <button id="start-attendance" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">
                        เริ่มเช็คเวลาเรียน
                    </button>
                </div>
            </div>
            <div id="attendance-list" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">รายชื่อนักเรียน</h3>
                    <div>
                        <button id="mark-all-present" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg mr-2">
                            มาเรียนทั้งหมด
                        </button>
                        <button id="reset-attendance" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            ยกเลิกทั้งหมด
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <table id="attendance-table">
                        <thead>
                            <tr>
                                <th>ลำดับ</th>
                                <th>รหัสนักเรียน</th>
                                <th>ชื่อ-นามสกุล</th>
                                <th>ระดับชั้น</th>
                                <th>ห้อง</th>
                                <th>รหัสวิชา</th>
                                <th>รายวิชา</th>
                                <th>สถานะ</th>
                                <th>หมายเหตุ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="text-center">
                    <button id="save-attendance" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">
                        บันทึกเวลาเรียน
                    </button>
                </div>
            </div>
        </div>
      <div id="reports" class="tab-content">
    <h2 class="text-2xl font-bold mb-6">รายงานรายบุคคล</h2>
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
            <div>
                <label class="block text-gray-700 mb-2">วันที่เริ่มต้น</label>
                <input type="date" id="report-start-date" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-gray-700 mb-2">วันที่สิ้นสุด</label>
                <input type="date" id="report-end-date" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                <select id="report-class" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">ทุกระดับชั้น</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                <select id="report-classroom" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">ทุกห้องเรียน</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">รายวิชา</label>
                <select id="report-subject" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">ทุกรายวิชา</option>
                </select>
            </div>
            <!-- เพิ่ม dropdown สำหรับสถานะ -->
            <div>
                <label class="block text-gray-700 mb-2">สถานะ</label>
                <select id="report-status" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">ทุกสถานะ</option>
                    <option value="present">มาเรียน</option>
                    <option value="absent">ขาดเรียน</option>
                    <option value="leave">ลา</option>
                    <option value="late">มาสาย</option>
                </select>
            </div>
        </div>
        <div class="text-center">
            <button id="generate-report" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">
                ดูรายงาน
            </button>
        </div>
    </div>
            <div id="report-results" class="hidden">
               <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-6">
  <!-- นักเรียนทั้งหมด -->
  <div class="stat-card-new">
    <div class="stat-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
  <path fill-rule="evenodd" d="M8.25 6.75a3.75 3.75 0 1 1 7.5 0 3.75 3.75 0 0 1-7.5 0ZM15.75 9.75a3 3 0 1 1 6 0 3 3 0 0 1-6 0ZM2.25 9.75a3 3 0 1 1 6 0 3 3 0 0 1-6 0ZM6.31 15.117A6.745 6.745 0 0 1 12 12a6.745 6.745 0 0 1 6.709 7.498.75.75 0 0 1-.372.568A12.696 12.696 0 0 1 12 21.75c-2.305 0-4.47-.612-6.337-1.684a.75.75 0 0 1-.372-.568 6.787 6.787 0 0 1 1.019-4.38Z" clip-rule="evenodd" />
  <path d="M5.082 14.254a8.287 8.287 0 0 0-1.308 5.135 9.687 9.687 0 0 1-1.764-.44l-.115-.04a.563.563 0 0 1-.373-.487l-.01-.121a3.75 3.75 0 0 1 3.57-4.047ZM20.226 19.389a8.287 8.287 0 0 0-1.308-5.135 3.75 3.75 0 0 1 3.57 4.047l-.01.121a.563.563 0 0 1-.373.486l-.115.04c-.567.2-1.156.349-1.764.441Z" />
</svg>
    </div>
    <div class="stat-info">
      <h3>นักเรียนทั้งหมด</h3>
      <p id="report-total-students">0</p>
    </div>
  </div>

  <!-- มาเรียน -->
  <div class="stat-card-new">
    <div class="stat-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <div class="stat-info">
      <h3>มาเรียน</h3>
      <p id="report-present-students">0</p>
    </div>
  </div>

  <!-- ขาดเรียน -->
  <div class="stat-card-new">
    <div class="stat-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <div class="stat-info">
      <h3>ขาดเรียน</h3>
      <p id="report-absent-students">0</p>
    </div>
  </div>

  <!-- ลา -->
  <div class="stat-card-new">
    <div class="stat-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" />
      </svg>
    </div>
    <div class="stat-info">
      <h3>ลา</h3>
      <p id="report-leave-students">0</p>
    </div>
  </div>

  <!-- สาย -->
  <div class="stat-card-new">
    <div class="stat-icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <div class="stat-info">
      <h3>มาสาย</h3>
      <p id="report-late-students">0</p>
    </div>
  </div>
</div>

                <div class="text-center mb-4 space-x-2">
                    <button id="export-csv" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        ดาวน์โหลดรายงาน (.CSV)
                    </button>
                    <button id="export-xlsx" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                        ดาวน์โหลดรายงาน (.XLSX)
                    </button>
                    <button id="export-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
                        ดาวน์โหลดรายงาน (.PDF)
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="overflow-x-auto">
                        <table id="report-table" class="w-full">
                            <thead id="report-table-head"></thead>
                            <tbody id="report-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="classroom-reports" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">รายงานตามห้องเรียน</h2>
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">วันที่เริ่มต้น</label>
                        <input type="date" id="classroom-report-start-date" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">วันที่สิ้นสุด</label>
                        <input type="date" id="classroom-report-end-date" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                        <select id="classroom-report-class" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกระดับชั้น</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                        <select id="classroom-report-classroom" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกห้องเรียน</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">รายวิชา</label>
                        <select id="classroom-report-subject" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกรายวิชา</option>
                        </select>
                    </div>
                </div>
                <div class="text-center">
                    <button id="generate-classroom-report" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">
                        ดูรายงาน
                    </button>
                </div>
            </div>
            <div id="classroom-report-results" class="hidden">
                <div class="text-center mb-4 space-x-2">
                    <button id="classroom-export-csv" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        ดาวน์โหลดรายงาน (.CSV)
                    </button>
                    <button id="classroom-export-xlsx" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                        ดาวน์โหลดรายงาน (.XLSX)
                    </button>
                    <button id="classroom-export-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
                        ดาวน์โหลดรายงาน (.PDF)
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="overflow-x-auto">
                        <table id="classroom-report-table" class="w-full">
                            <thead>
                                <tr>
                                    <th>ลำดับ</th>
                                    <th>วันที่</th>
                                    <th>ระดับชั้น</th>
                                    <th>ห้องเรียน</th>
                                    <th>รหัสวิชา</th>
                                    <th>ชื่อวิชา</th>
                                    <th>จำนวนนักเรียนทั้งหมด</th>
                                    <th class="present-column">มาเรียน</th>
                                    <th class="absent-column">ขาดเรียน</th>
                                    <th class="leave-column">ลา</th>
                                    <th class="late-column">มาสาย</th>
                                </tr>
                            </thead>
                            <tbody id="classroom-report-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="summary-report">
                    <h3 class="text-xl font-bold mb-4">ผลรวมทั้งหมดในช่วงวันที่เลือก</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <h4 class="text-lg font-semibold">มาเรียนทั้งหมด</h4>
                            <p class="text-2xl font-bold" id="summary-present">0</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <h4 class="text-lg font-semibold">ขาดเรียนทั้งหมด</h4>
                            <p class="text-2xl font-bold" id="summary-absent">0</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <h4 class="text-lg font-semibold">ลาทั้งหมด</h4>
                            <p class="text-2xl font-bold" id="summary-leave">0</p>
                        </div>
                        <div class="p-4 bg-gray-100 rounded-lg">
                            <h4 class="text-lg font-semibold">มาสายทั้งหมด</h4>
                            <p class="text-2xl font-bold" id="summary-late">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="monthly-report" class="tab-content">
    <h2 class="text-2xl font-bold mb-6">รายงานประจำเดือน</h2>
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
            <div>
                <label class="block text-gray-700 mb-2">เลือกปี</label>
                <select id="monthly-report-year" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">เลือกเดือน</label>
                <select id="monthly-report-month" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">รายวิชา</label>
                <select id="monthly-report-subject" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                <select id="monthly-report-class" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                <select id="monthly-report-classroom" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
        </div>
        <div class="text-center mt-6">
            <button id="generate-monthly-report" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">
                ดูรายงาน
            </button>
        </div>
    </div>
    <div id="monthly-report-results" class="hidden">
        <div class="text-center mb-4">
            <button id="export-monthly-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
                ดาวน์โหลดรายงาน (.PDF)
            </button>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="overflow-x-auto">
                <table id="monthly-report-table" class="w-full">
                    <thead id="monthly-report-table-head"></thead>
                    <tbody id="monthly-report-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        <div id="school-report" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">รายงานภาพรวมโรงเรียน</h2>
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-2">วันที่เริ่มต้น</label>
                        <input type="date" id="school-report-start-date" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">วันที่สิ้นสุด</label>
                        <input type="date" id="school-report-end-date" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                        <select id="school-report-class" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกระดับชั้น</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                        <select id="school-report-classroom" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกห้องเรียน</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">รายวิชา</label>
                        <select id="school-report-subject" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">ทุกรายวิชา</option>
                        </select>
                    </div>
                </div>
                <div class="text-center">
                    <button id="generate-school-report" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">
                        ดูรายงาน
                    </button>
                </div>
            </div>
            <div id="school-report-results" class="hidden">
                <div class="school-report-content">
                    <div class="school-report-actions text-center mb-4 space-x-2">
                        <button id="school-export-csv" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                            ดาวน์โหลดรายงาน (.CSV)
                        </button>
                        <button id="school-export-xlsx" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg">
                            ดาวน์โหลดรายงาน (.XLSX)
                        </button>
                        <button id="school-export-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
                            ดาวน์โหลดรายงาน (.PDF)
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg p-4 rounded-lg shadow">
                    <div class="overflow-x-auto">
                        <table id="school-report-table" class="w-full">
                            <thead>
                                <tr>
                                    <th>ลำดับ</th>
                                    <th>วันที่</th>
                                    <th>รหัสวิชา</th>
                                    <th>รายวิชา</th>
                                    <th>ระดับชั้น</th>
                                    <th>ห้องเรียน</th>
                                    <th>จำนวนนักเรียนทั้งหมด</th>
                                    <th class="present-column">มาเรียน</th>
                                    <th class="absent-column">ขาดเรียน</th>
                                    <th class="leave-column">ลา</th>
                                    <th class="late-column">มาสาย</th>
                                </tr>
                            </thead>
                            <tbody id="school-report-table-body"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-right font-bold">รวมทั้งหมด</td>
                                    <td class="font-bold" id="school-total-students">0</td>
                                    <td class="present-column font-bold" id="school-total-present">0</td>
                                    <td class="absent-column font-bold" id="school-total-absent">0</td>
                                    <td class="leave-column font-bold" id="school-total-leave">0</td>
                                    <td class="late-column font-bold" id="school-total-late">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="settings" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">ตั้งค่าระบบ</h2>
            <div class="bg-white rounded-lg shadow p-6">

<form id="settings-form">
    <input type="hidden" id="theme-color" name="theme-color">
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">ชื่อระบบ</label>
        <input type="text" id="system-name" name="system-name" class="w-full px-3 py-2 border rounded-lg" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">URL โลโก้</label>
        <input type="url" id="logo-url" name="logo-url" class="w-full px-3 py-2 border rounded-lg" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">ข้อความ Header</label>
        <input type="text" id="header-text" name="header-text" class="w-full px-3 py-2 border rounded-lg" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">ข้อความ Footer</label>
        <input type="text" id="footer-text" name="footer-text" class="w-full px-3 py-2 border rounded-lg" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">ชื่อโรงเรียน (สำหรับหน้าปกรายงาน)</label>
        <input type="text" id="school-name" name="school-name" class="w-full px-3 py-2 border rounded-lg" placeholder="กรอกชื่อโรงเรียนเต็ม" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">เขตพื้นที่การศึกษา</label>
        <input type="text" id="school-area" name="school-area" class="w-full px-3 py-2 border rounded-lg" placeholder="เช่น สำนักงานเขตพื้นที่การศึกษาประถมศึกษาขอนแก่น เขต 5" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">ชื่อ-นามสกุล ผู้อำนวยการ</label>
        <input type="text" id="director-name" name="director-name" class="w-full px-3 py-2 border rounded-lg" placeholder="กรอกชื่อ-นามสกุลเต็ม" required>
    </div>
    <div class="mb-4">
        <label class="block text-gray-700 mb-2">สีธีม</label>
        <div id="theme-selector" class="flex space-x-2 theme-selector">
            <button type="button" class="theme-button" data-color="#FF69B4" style="background-color: #FF69B4;"></button>
            <button type="button" class="theme-button" data-color="#2196F3" style="background-color: #2196F3;"></button>
            <button type="button" class="theme-button" data-color="#3F51B5" style="background-color: #3F51B5;"></button>
            <button type="button" class="theme-button" data-color="#4CAF50" style="background-color: #4CAF50;"></button>
            <button type="button" class="theme-button" data-color="#FFC107" style="background-color: #FFC107;"></button>
            <button type="button" class="theme-button" data-color="#9C27B0" style="background-color: #9C27B0;"></button>
            <button type="button" class="theme-button" data-color="#FF9800" style="background-color: #FF9800;"></button>
            <button type="button" class="theme-button" data-color="#F44336" style="background-color: #F44336;"></button>
        </div>
    </div>
    <div class="text-center">
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
            บันทึกการตั้งค่า
        </button>
    </div>
</form>

            </div>
        </div>
        <div id="settings" class="tab-content">
            </div>
        
        <div id="class-levels" class="tab-content"></div>
        <div id="student-view" class="tab-content"></div>
        <div id="scoring" class="tab-content"></div>
        <div id="characteristics" class="tab-content"></div>
        <div id="characteristics-report" class="tab-content"></div>
        <div id="activities" class="tab-content"></div>
        <div id="activities-report" class="tab-content"></div>
        <div id="values-competencies" class="tab-content"></div>
        <div id="values-competencies-report" class="tab-content"></div>
        <div id="p5-cover" class="tab-content"></div>
        <div id="score-report" class="tab-content">

    <h2 class="text-2xl font-bold mb-6">รายงานสรุปคะแนน</h2>
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
                <label class="block text-gray-700 mb-2">รายวิชา</label>
                <select id="score-report-subject" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                <select id="score-report-class" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                <select id="score-report-classroom" class="w-full px-3 py-2 border rounded-lg"></select>
            </div>
        </div>
        <div class="text-center mt-4">
            <button id="generate-score-report" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-lg">สร้างรายงาน</button>
        </div>
    </div>
    <div id="score-report-results" class="hidden">
        <div id="score-report-header" class="report-header"></div>
        <div class="text-center mb-4">
            <button id="export-score-report-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
                ดาวน์โหลดรายงาน (.PDF)
            </button>
        </div>
        <div class="report-table-container">
            <table id="score-report-table" class="w-full report-table">
                <thead id="score-report-table-head"></thead>
                <tbody id="score-report-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

    </main>
    <footer class="bg-pink-200 py-4 border-t fixed bottom-0 left-0 w-full">
        <div class="container mx-auto px-4 text-center text-gray-600">
            <p>{{FOOTER_TEXT}}</p>
        </div>
    </footer>
<div id="subject-modal" class="modal">
    <div class="modal-content">
        <span class="close">×</span>
        <h2 class="modal-title" id="subject-modal-title">เพิ่มรายวิชา</h2>
        <form id="subject-form">
            <input type="hidden" id="subject-id">
            <div class="mb-4">
                <label class="subject-code-label block text-gray-700 mb-2">รหัสวิชา</label>
                <input type="text" id="subject-code" name="code" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">ชื่อรายวิชา</label>
                <input type="text" id="subject-name" name="subject-name" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">หน่วยกิต</label>
                <input type="number" id="subject-credits" name="subject-credits" class="w-full px-3 py-2 border rounded-lg" placeholder="เช่น 1.0, 1.5" step="0.5" min="0">
            </div>
            <div class="text-right">
                <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">
                    ยกเลิก
                </button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    บันทึก
                </button>
            </div>
        </form>
    </div>
</div>
    <div id="teacher-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2 class="modal-title" id="teacher-modal-title">เพิ่มครูผู้สอน</h2>
            <form id="teacher-form">
                <input type="hidden" id="teacher-id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                    <input type="text" id="teacher-name" name="teacher-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ชื่อผู้ใช้</label>
                    <input type="text" id="teacher-username" name="teacher-username" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">รหัสผ่าน</label>
                    <input type="password" id="teacher-password" name="teacher-password" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">วิชา ระดับชั้น และห้องเรียน</label>
                    <table id="subject-class-table" class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="border p-2">วิชา</th>
                                <th class="border p-2">ระดับชั้น</th>
                                <th class="border p-2">ห้องเรียน</th>
                                <th class="border p-2">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" id="add-subject-class-row" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg mt-2">เพิ่มวิชา ระดับชั้น และห้องเรียน</button>
                </div>
                <div class="text-right">
                    <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">ยกเลิก</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2 class="modal-title" id="student-modal-title">เพิ่มนักเรียน</h2>
            <form id="student-form">
                <input type="hidden" id="student-id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">รหัสนักเรียน</label>
                    <input type="text" id="student-code" name="student-code" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                    <input type="text" id="student-name" name="student-name" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                    <select id="student-class" name="student-class" class="w-full px-3 py-2 border rounded-lg" required>
                        <option value="">เลือก</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                    <input type="text" id="student-classroom" name="student-classroom" class="w-full px-3 py-2 border rounded-lg" placeholder="เช่น 3/1, A, ห้อง 1" required>
                </div>
                <div class="text-right">
                    <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="teacher-student-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2 class="modal-title" id="teacher-student-modal-title">แก้ไขข้อมูลนักเรียน</h2>
            <form id="teacher-student-form">
                <input type="hidden" id="teacher-student-id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">รหัสนักเรียน</label>
                    <input type="text" id="teacher-student-code" name="student-code" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                    <input type="text" id="teacher-student-name" name="student-name" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="text-right">
                    <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="import-subjects-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>นำเข้ารายวิชาจากไฟล์ CSV</h2>
            <form id="import-subjects-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">เลือกไฟล์ CSV</label>
                    <input type="file" id="subjects-csv-file" name="csv-file" accept=".csv" class="w-full px-3 py-2 border rounded-lg" required>
                    <p class="text-sm text-gray-600 mt-2">กรุณาใช้เทมเพลตที่ดาวน์โหลดจากระบบ</p>
                </div>
                <div class="text-right">
                    <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        นำเข้า
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="import-students-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>นำเข้านักเรียนจากไฟล์ CSV</h2>
            <form id="import-students-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">เลือกไฟล์ CSV</label>
                    <input type="file" id="students-csv-file" name="csv-file" accept=".csv" class="w-full px-3 py-2 border rounded-lg" required>
                    <p class="text-sm text-gray-600 mt-2">กรุณาใช้เทมเพลตที่ดาวน์โหลดจากระบบ</p>
                </div>
                <div class="text-right">
                    <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        นำเข้า
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2 class="modal-title">ยืนยันการบันทึกการตั้งค่า</h2>
            <form id="settings-confirm-form">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">รหัสผ่านผู้ดูแลระบบ</label>
                    <input type="password" id="admin-password" name="admin-password" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="text-right">
                    <button type="button" class="close-modal bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        ยืนยัน
                    </button>
                </div>
            </form>
        </div>
    </div>

<div id="teacher-choice-modal" class="modal non-dismissible">
    <div class="modal-content max-w-md">
       <h2 class="text-2xl font-bold text-center mb-6">ยินดีต้อนรับ, คุณครู!</h2>
       <p class="text-center text-gray-600 mb-8">กรุณาเลือกเมนูที่ต้องการทำรายการ</p>
       <div class="flex flex-col space-y-4">
           <button id="choice-go-to-attendance" class="w-full text-white px-6 py-3 rounded-lg text-lg font-semibold" style="background-color: var(--primary-color);">
               จัดการเวลาเรียน
           </button>
           <button id="choice-go-to-scoring" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold">
               จัดการคะแนน
           </button>
           <button id="choice-go-to-characteristics" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold">
               จัดการคุณลักษณะฯ
           </button>
            <button id="choice-go-to-values-competencies" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-lg text-lg font-semibold">
                จัดการค่านิยมและสมรรถนะ
            </button>
           <button id="choice-go-to-activities" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg text-lg font-semibold">
               จัดการกิจกรรมพัฒนาผู้เรียน
           </button>
           <button id="choice-go-to-p5-cover" class="w-full bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg text-lg font-semibold">
               พิมพ์ปก ปพ.5
           </button>
       </div>
    </div>
</div>

   <div id="loading-overlay" class="loading">
    <div class="loading-content">
        <div class="spinner"></div>
        <p class="mt-2">กำลังประมวลผล...</p>
    </div>
</div>

<script>
if (!window.themeMap) {
    window.themeMap = {
        '#FF69B4': { light: '#fbcfe8' }, // Pink
        '#2196F3': { light: '#bbdefb' }, // Blue
        '#3F51B5': { light: '#c5cae9' }, // Navy
        '#4CAF50': { light: '#c8e6c9' }, // Green
        '#FFC107': { light: '#fff9c4' }, // Yellow
        '#9C27B0': { light: '#e1bee7' }, // Purple
        '#FF9800': { light: '#ffe0b2' }, // Orange
        '#F44336': { light: '#ffcdd2' }  // Red
    };
}

var pieChart = null;
var barChart = null;
var isLoading = false;
var GLOBAL_ENABLED_LEVELS = [];
var pendingAttendanceRecords = [];
// ประกาศตัวแปรสำหรับกราฟใหม่นอกฟังก์ชัน
var gradeDistChart = null;
var componentAvgChart = null;

var appState = {
    user: null,
    settings: {},
    classLevelSettings: { enabledLevels: [] },
    subjects: [],
    students: [],
    teachers: [],
    attendance: [],
    scoreComponents: [], 
    scores: [],
    characteristicsItems: [],
    characteristicsScores: [],
    activityComponents: [],
    activityScores: [],
    // --- START: เพิ่มส่วนนี้ ---
    valuesCompetenciesItems: [],
    valuesCompetenciesScores: [],
    // --- END: เพิ่มส่วนนี้ ---
    isDataLoaded: false
};

window.allReportRows = window.allReportRows || [];
window.allClassroomReportRows = window.allClassroomReportRows || [];

function getCharacteristicGradeStyle(percentage) {
    if (percentage >= 80) return { text: 'ดีเยี่ยม', class: 'text-green-600' };
    if (percentage >= 70) return { text: 'ดี', class: 'text-blue-600' };
    if (percentage >= 50) return { text: 'ผ่าน', class: 'text-yellow-600' };
    return { text: 'ไม่ผ่าน', class: 'text-red-600' };
}

// วางทับฟังก์ชัน loadApplicationData เดิมทั้งหมด
function loadApplicationData(isRefresh = false, callback = null) {
    if (isLoading) return;
    showLoading();
    const timeout = setTimeout(() => {
        hideLoading();
        Swal.fire({
            icon: 'error',
            title: 'การโหลดข้อมูลล่าช้า',
            text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
            confirmButtonColor: 'var(--primary-color)'
        });
    }, 30000);

    google.script.run
        .withSuccessHandler(dataBundle => {
            clearTimeout(timeout);
            initializeAppState(dataBundle);
            appState.isDataLoaded = true;

            // --- ส่วนที่แก้ไข ---
            // ทำให้ฟังก์ชันนี้รับผิดชอบแค่การดึงข้อมูลและอัปเดต state
            // ส่วนการแสดงผลจะถูกจัดการโดย callback ที่ส่งเข้ามาเท่านั้น
            if (callback) {
                callback();
            }

            hideLoading();
            if (isRefresh) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'ข้อมูลอัพเดทแล้ว',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        })
        .withFailureHandler(error => {
            clearTimeout(timeout);
            handleError(error);
            console.error("Critical error loading application data. Forcing logout.");
            // setTimeout(() => $('#logout-btn').click(), 2000); // อาจจะรุนแรงไป เอาออกก่อน
        })
        .getInitialDataForUser(JSON.parse(sessionStorage.getItem('user')));
}

function initializeAppState(dataBundle) {
    if (!dataBundle) {
        throw new Error("Data bundle is null or undefined.");
    }
    appState.user = JSON.parse(sessionStorage.getItem('user'));
    appState.settings = dataBundle.settings || {};
    appState.classLevelSettings = dataBundle.classLevelSettings || { enabledLevels: [] };
    appState.subjects = dataBundle.subjects || [];
    appState.students = dataBundle.students || [];
    appState.teachers = dataBundle.teachers || [];
    appState.attendance = (dataBundle.attendance || []).map(r => ({...r, date: normalizeDate(r.date)}));
    
    appState.scoreComponents = dataBundle.scoreComponents || [];
    appState.scores = dataBundle.scores || [];
    appState.characteristicsItems = dataBundle.characteristicsItems || [];
    appState.characteristicsScores = dataBundle.characteristicsScores || [];
    appState.activityComponents = dataBundle.activityComponents || [];
    appState.activityScores = dataBundle.activityScores || [];

    // --- START: ส่วนที่แก้ไข ---
    // เพิ่มการดึงข้อมูลสำหรับ "ค่านิยมและสมรรถนะ" มาเก็บใน State ของโปรแกรม
    appState.valuesCompetenciesItems = dataBundle.valuesCompetenciesItems || [];
    appState.valuesCompetenciesScores = dataBundle.valuesCompetenciesScores || [];
    // --- END: ส่วนที่แก้ไข ---

    if (appState.settings.theme_color) {
        applyTheme(appState.settings.theme_color);
    }
    
    GLOBAL_ENABLED_LEVELS = appState.classLevelSettings.enabledLevels || [];
    console.log("Global enabled levels set:", GLOBAL_ENABLED_LEVELS);
}
function populateAllDropdowns() {
    populateClassLevelDropdowns(GLOBAL_ENABLED_LEVELS);
    populateSubjectDropdowns(appState.subjects);
    populateClassroomDropdowns(appState.students);
}

function populateSubjectDropdowns(subjectsData) {
    const selects = [
        document.getElementById('attendance-subject'),
        document.getElementById('report-subject'),
        document.getElementById('classroom-report-subject'),
        document.getElementById('school-report-subject')
    ];

    let filteredSubjects = subjectsData;
    if (appState.user.role === 'teacher') {
        let pairs = [];
        try { pairs = JSON.parse(appState.user.subjectClassPairs || '[]'); } catch (e) {}
        const validSubjectIds = pairs.map(p => p.subjectId);
        filteredSubjects = subjectsData.filter(s => validSubjectIds.includes(s.id));
    }

    let optionsHtmlAttendance = '<option value="all" selected>ทุกรายวิชา</option>';
    let optionsHtmlReport = '<option value="" selected>ทุกรายวิชา</option>';
    filteredSubjects.forEach(subject => {
        const displayText = `${subject.code} - ${subject.name}`;
        optionsHtmlAttendance += `<option value="${subject.id}">${displayText}</option>`;
        optionsHtmlReport += `<option value="${subject.id}">${displayText}</option>`;
    });

    selects.forEach(select => {
        if (!select) return;
        if (select.id === 'attendance-subject') {
            select.innerHTML = optionsHtmlAttendance;
        } else {
            select.innerHTML = optionsHtmlReport;
        }
        $(select).trigger('change');
    });
}

function applyTheme(primaryColor) {
    if (!primaryColor || !window.themeMap[primaryColor]) {
        console.warn('Invalid or unknown theme color:', primaryColor, 'Falling back to default.');
        primaryColor = '#FF69B4'; 
    }

    const lightColor = window.themeMap[primaryColor].light;
    document.documentElement.style.setProperty('--primary-color', primaryColor);
    $('header, footer').css('background-color', lightColor);
}

function animateCountUp(elementId, endValue, duration = 1500) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let startValue = 0;
    const startTime = performance.now();

    function update(currentTime) {
        const elapsedTime = currentTime - startTime;
        if (elapsedTime > duration) {
            element.textContent = endValue.toLocaleString();
            return;
        }
        const progress = elapsedTime / duration;
        const currentValue = Math.floor(endValue * progress);
        element.textContent = currentValue.toLocaleString();
        requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}

function normalizeDate(dateStr) {
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
            return '';
        }
        return date.toISOString().split('T')[0];
    } catch (e) {
        return '';
    }
}

function formatThaiDate(dateStr) {
    try {
        const dt = new Date(dateStr);
        const monthsShort = [ 'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.' ];
        const day = dt.getDate();
        const monthAbbr = monthsShort[dt.getMonth()];
        const yearBuddhist = dt.getFullYear() + 543;
        return `${day} ${monthAbbr} ${yearBuddhist}`;
    } catch (e) {
        return dateStr;
    }
}

function calculateGrade(score, maxScore, remark) { // เพิ่ม remark เป็นพารามิเตอร์
    // --- START: ส่วนที่แก้ไข ---
    // ถ้ามี remark (ที่ไม่ใช่ค่าว่างหรือ '-') ให้คืนค่า remark กลับไปเลย
    if (remark && remark !== '-') {
        return remark;
    }
    // --- END: ส่วนที่แก้ไข ---

    if (typeof score !== 'number' && isNaN(parseFloat(score))) {
        return score;
    }
    if (maxScore === 0) return '-';
    const percentage = (score / maxScore) * 100;
    if (percentage >= 80) return '4';
    if (percentage >= 75) return '3.5';
    if (percentage >= 70) return '3';
    if (percentage >= 65) return '2.5';
    if (percentage >= 60) return '2';
    if (percentage >= 55) return '1.5';
    if (percentage >= 50) return '1';
    return '0';
}


function handleError(error) {
    hideLoading();
    isLoading = false;
    console.error('Error:', error);

    // --- START: ส่วนที่แก้ไข ---
    // เพิ่มการตรวจสอบ error message เพื่อแนะนำให้ผู้ใช้รีเฟรชหน้า
    let errorMessage = error.message || 'ไม่สามารถดำเนินการได้ กรุณาลองใหม่';
    if (errorMessage.includes("Authorization is required") || errorMessage.includes("You do not have permission")) {
        errorMessage = 'การเชื่อมต่อหมดอายุ กรุณารีเฟรชหน้าแล้วลองอีกครั้ง';
    }
    // --- END: ส่วนที่แก้ไข ---

    Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด',
        text: errorMessage, // ใช้ errorMessage ที่ปรับปรุงแล้ว
        confirmButtonColor: 'var(--primary-color)'
    });
}

function isWebAppContext() {
    return window.google && google.script && google.script.run;
}

function waitForGoogleScriptRun(callback) {
    if (isWebAppContext()) {
        callback();
    } else {
        console.error("google.script.run is not available. Ensure you are in the Web App environment.");
        Swal.fire({
            icon: 'error',
            title: 'ข้อผิดพลาดในการเชื่อมต่อ',
            text: 'ไม่สามารถเรียกใช้งานฟังก์ชันของเซิร์ฟเวอร์ได้ กรุณาตรวจสอบว่าคุณกำลังใช้งานผ่านลิงก์ Web App ที่ถูกต้อง',
            confirmButtonColor: 'var(--primary-color)'
        });
    }
}

function checkLogin() {
    const user = appState.user;
    if (!user) {
        return false;
    }

    let roleDisplay = '';
    let prefix = 'ผู้ใช้:'; 

    if (user.role === 'admin') {
        roleDisplay = 'ผู้ดูแลระบบ';
        $('#back-to-choice-btn').addClass('hidden'); // ซ่อนปุ่มสำหรับ Admin
    } else if (user.role === 'teacher') {
        roleDisplay = 'ครู';
        $('#back-to-choice-btn').removeClass('hidden'); // แสดงปุ่มสำหรับครู
    } else if (user.role === 'student') {
        roleDisplay = 'นักเรียน';
        prefix = 'นักเรียน:'; 
        $('#back-to-choice-btn').addClass('hidden'); // ซ่อนปุ่มสำหรับนักเรียน
    }

    $('#user-info').html(`${prefix} ${user.name} (${roleDisplay})`);
    
    return true;
}

document.getElementById('logout-btn').addEventListener('click', function() {
    sessionStorage.removeItem('user');
    sessionStorage.removeItem('initialData');
    sessionStorage.removeItem('hasShownLoginAlert');
    waitForGoogleScriptRun(() => {
        showLoading();
        google.script.run
            .withSuccessHandler(function(html) {
                hideLoading();
                document.open();
                document.write(html);
                document.close();
                Swal.fire({
                    icon: 'success',
                    title: 'ออกจากระบบสำเร็จ',
                    text: 'คุณได้ออกจากระบบเรียบร้อยแล้ว',
                    confirmButtonColor: 'var(--primary-color)',
                    timer: 1500,
                    timerProgressBar: true
                });
            })
            .withFailureHandler(function(error) {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถโหลดหน้า login ได้: ' + (error.message || 'ไม่ทราบสาเหตุ'),
                    confirmButtonColor: 'var(--primary-color)'
                });
                console.error('Failed to redirect to login:', error);
            })
            .loadLoginPage();
    });
});

function initializeNavigation() {
    const navTabs = $('#nav-tabs');
    navTabs.empty();
    let tabsHtml = '';
    const user = appState.user;

    $('.tab-content').removeClass('active');

    if (!user) {
        console.error("initializeNavigation called before user was set in appState.");
        return;
    }
    checkLogin();

    if (user.role === 'admin') {
        tabsHtml = `
            <div class="nav-tab active px-3 py-2" data-tab="dashboard">แดชบอร์ด</div>
            <div class="nav-tab px-3 py-2" data-tab="class-levels">จัดการระดับชั้น</div>
            <div class="nav-tab px-3 py-2" data-tab="subjects">จัดการรายวิชา</div>
            <div class="nav-tab px-3 py-2" data-tab="students">จัดการนักเรียน</div>
            <div class="nav-tab px-3 py-2" data-tab="teachers">จัดการครูผู้สอน</div>
            <div class="nav-tab px-3 py-2" data-tab="school-report">รายงานภาพรวมโรงเรียน</div>
            <div class="nav-tab px-3 py-2" data-tab="settings">ตั้งค่าระบบ</div>
        `;
    } else if (user.role === 'teacher') {
        const mode = sessionStorage.getItem('teacherChoiceMode');
        
        if (mode === 'scoring') {
            tabsHtml = `
                <div class="nav-tab active px-3 py-2" data-tab="dashboard">แดชบอร์ด</div>
                <div class="nav-tab px-3 py-2" data-tab="students">ดูข้อมูลนักเรียน</div>
                <div class="nav-tab px-3 py-2" data-tab="scoring">จัดการคะแนน</div>
                <div class="nav-tab px-3 py-2" data-tab="score-report">รายงานสรุปคะแนน</div>
            `;
        } else if (mode === 'characteristics') {
            tabsHtml = `
                <div class="nav-tab active px-3 py-2" data-tab="characteristics">ประเมินคุณลักษณะฯ</div>
                <div class="nav-tab px-3 py-2" data-tab="characteristics-report">รายงานคุณลักษณะฯ</div>
            `;
        } else if (mode === 'values-competencies') {
             tabsHtml = `
                <div class="nav-tab active px-3 py-2" data-tab="values-competencies">ประเมินค่านิยมฯ</div>
                <div class="nav-tab px-3 py-2" data-tab="values-competencies-report">รายงานค่านิยมฯ</div>
            `;
        } else if (mode === 'p5-cover') {
            tabsHtml = `<div class="nav-tab active px-3 py-2" data-tab="p5-cover">พิมพ์ปก ปพ.5</div>`;
        } else if (mode === 'activities') {
            tabsHtml = `
                <div class="nav-tab active px-3 py-2" data-tab="activities">ประเมินกิจกรรมฯ</div>
                <div class="nav-tab px-3 py-2" data-tab="activities-report">รายงานกิจกรรมฯ</div>
            `;
        } else { // default to 'attendance'
            tabsHtml = `
                <div class="nav-tab active px-3 py-2" data-tab="dashboard">แดชบอร์ด</div>
                <div class="nav-tab px-3 py-2" data-tab="students">ดูข้อมูลนักเรียน</div>
                <div class="nav-tab px-3 py-2" data-tab="attendance">จัดการเช็คเวลาเรียน</div>
                <div class="nav-tab px-3 py-2" data-tab="reports">รายงานรายบุคคล</div>
                <div class="nav-tab px-3 py-2" data-tab="classroom-reports">รายงานห้องเรียน</div>
                <div class="nav-tab px-3 py-2" data-tab="monthly-report">รายงานประจำเดือน</div>
            `;
        }
    } else if (user.role === 'student') {
        navTabs.hide();
        $('#student-view').addClass('active');
        renderStudentView(appState);
        return;
    }
    
    const activeTabId = sessionStorage.getItem('teacherChoiceMode') || 'dashboard';
    if (['characteristics', 'activities', 'values-competencies', 'p5-cover'].includes(activeTabId)) {
        $('#' + activeTabId).addClass('active');
    } else {
        $('#dashboard').addClass('active');
    }

    navTabs.html(tabsHtml);
    initializeTabs();
}

function renderStudentView(state) {
    const student = state.user;
    const viewContainer = $('#student-view');
    viewContainer.empty();

    const headerHtml = `
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4" style="border-color: var(--primary-color);">
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="flex-grow text-center sm:text-left">
                    <h2 class="text-2xl font-bold text-gray-800">${student.name}</h2>
                    <p class="text-gray-600">รหัสนักเรียน: ${student.code}</p>
                </div>
                <div class="text-center sm:text-right">
                    <p class="text-md text-gray-700 font-semibold">ระดับชั้น: ${student.class}</p>
                    <p class="text-md text-gray-700 font-semibold">ห้องเรียน: ${student.classroom}</p>
                </div>
            </div>
        </div>
    `;
    viewContainer.append(headerHtml);

    const tabsHtml = `
        <div class="flex border-b mb-6 flex-wrap">
            <div id="student-attendance-tab" class="login-tab active flex-auto text-center font-semibold">ข้อมูลเวลาเรียน</div>
            <div id="student-scores-tab" class="login-tab flex-auto text-center font-semibold">ผลการเรียน</div>
            <div id="student-characteristics-tab" class="login-tab flex-auto text-center font-semibold">คุณลักษณะฯ</div>
            <div id="student-values-competencies-tab" class="login-tab flex-auto text-center font-semibold">ค่านิยมและสมรรถนะ</div>
            <div id="student-activities-tab" class="login-tab flex-auto text-center font-semibold">กิจกรรมฯ</div>
        </div>
        <div id="student-attendance-content" class="student-view-content active"></div>
        <div id="student-scores-content" class="student-view-content" style="display: none;"></div>
        <div id="student-characteristics-content" class="student-view-content" style="display: none;"></div>
        <div id="student-values-competencies-content" class="student-view-content" style="display: none;"></div>
        <div id="student-activities-content" class="student-view-content" style="display: none;"></div>
    `;
    viewContainer.append(tabsHtml);

    renderStudentAttendanceView(state);
    renderStudentScoreView(state);
    renderStudentCharacteristicsView(state);
    renderStudentValuesCompetenciesView(state); // <-- เพิ่มการเรียกฟังก์ชันใหม่
    renderStudentActivitiesView(state);

    $('#student-attendance-tab, #student-scores-tab, #student-characteristics-tab, #student-activities-tab, #student-values-competencies-tab').off('click').on('click', function() {
        if ($(this).hasClass('active')) return;
        $('#student-view .login-tab').removeClass('active');
        $(this).addClass('active');

        $('.student-view-content').hide();
        const tabId = $(this).attr('id');
        if (tabId === 'student-scores-tab') {
            $('#student-scores-content').show();
        } else if (tabId === 'student-characteristics-tab') {
            $('#student-characteristics-content').show();
        } else if (tabId === 'student-values-competencies-tab') {
             $('#student-values-competencies-content').show();
        } else if (tabId === 'student-activities-tab') {
            $('#student-activities-content').show();
        } else {
            $('#student-attendance-content').show();
        }
    });
}

function renderStudentCharacteristicsView(state) {
    const viewContainer = $('#student-characteristics-content');
    viewContainer.empty();

    const student = state.user;
    const { characteristicsItems, characteristicsScores } = state;

    if (!characteristicsItems || characteristicsItems.length === 0) {
        viewContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ไม่พบรายการประเมินคุณลักษณะในระบบ</p></div>');
        return;
    }

    const characteristicItems = characteristicsItems.filter(i => i.itemGroup === 'คุณลักษณะอันพึงประสงค์');
    const readingItems = characteristicsItems.filter(i => i.itemGroup === 'การอ่าน คิดวิเคราะห์ และเขียน');

    // คำนวณผลสรุป
    let characteristicSum = 0, characteristicCount = 0;
    let readingSum = 0, readingCount = 0;

    characteristicItems.forEach(item => {
        const scoreRecord = characteristicsScores.find(s => s.studentId === student.id && s.itemId === item.id);
        if (scoreRecord && scoreRecord.score) {
            characteristicSum += parseInt(scoreRecord.score);
            characteristicCount++;
        }
    });

    readingItems.forEach(item => {
        const scoreRecord = characteristicsScores.find(s => s.studentId === student.id && s.itemId === item.id);
        if (scoreRecord && scoreRecord.score) {
            readingSum += parseInt(scoreRecord.score);
            readingCount++;
        }
    });

    // ใช้ฟังก์ชัน getCharacteristicGradeStyle เพื่อคำนวณผลลัพธ์
    let characteristicResultText = '-';
    let characteristicResultClass = 'text-gray-500';
    if (characteristicCount > 0) {
        const percentage = (characteristicSum / (characteristicCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        characteristicResultText = style.text;
        characteristicResultClass = style.class;
    }

    let readingResultText = '-';
    let readingResultClass = 'text-gray-500';
    if (readingCount > 0) {
        const percentage = (readingSum / (readingCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        readingResultText = style.text;
        readingResultClass = style.class;
    }

    // สร้าง Summary Cards
    const summaryHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div class="stat-card-new !p-4">
                <div class="stat-icon !w-12 !h-12">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="stat-info !gap-0">
                    <h3 class="!text-sm">คุณลักษณะอันพึงประสงค์</h3>
                    <p class="!text-3xl ${characteristicResultClass}">${characteristicResultText}</p>
                </div>
            </div>
            <div class="stat-card-new !p-4">
                <div class="stat-icon !w-12 !h-12">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="stat-info !gap-0">
                    <h3 class="!text-sm">การอ่าน คิดวิเคราะห์ และเขียน</h3>
                    <p class="!text-3xl ${readingResultClass}">${readingResultText}</p>
                </div>
            </div>
        </div>
    `;
    viewContainer.append(summaryHtml);

    // แมปคะแนนเป็นข้อความและสี
    const scoreDisplayMap = {
        '3': { text: 'ดีเยี่ยม', class: 'bg-green-100 text-green-800' },
        '2': { text: 'ดี', class: 'bg-blue-100 text-blue-800' },
        '1': { text: 'ผ่าน', class: 'bg-orange-100 text-orange-800' },
        '0': { text: 'ไม่ผ่าน', class: 'bg-red-100 text-red-800' },
        '-': { text: '-', class: 'bg-gray-100 text-gray-800' }
    };

    // สร้างการ์ดสำหรับแต่ละหมวดหมู่
    const createCardHtml = (items, title) => {
        if (items.length === 0) return '';
        const tableRows = items.map(item => {
            const scoreRecord = characteristicsScores.find(s => s.studentId === student.id && s.itemId === item.id);
            const score = scoreRecord ? scoreRecord.score : '-';
            const display = scoreDisplayMap[score] || scoreDisplayMap['-'];
            return `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${item.itemName}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 font-semibold leading-tight rounded-full ${display.class}">
                            ${display.text}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');

        return `
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="border-b pb-3 mb-4">
                    <h4 class="text-xl font-bold" style="color: var(--primary-color);">${title}</h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">รายการ</th>
                                <th scope="col" class="px-6 py-3 text-center">ผลการประเมิน</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    };

    // เพิ่มการ์ดสำหรับแต่ละหมวดหมู่
    if (characteristicItems.length > 0) {
        viewContainer.append(createCardHtml(characteristicItems, 'คุณลักษณะอันพึงประสงค์'));
    }
    if (readingItems.length > 0) {
        viewContainer.append(createCardHtml(readingItems, 'การอ่าน คิดวิเคราะห์ และเขียน'));
    }

    if (characteristicItems.length === 0 && readingItems.length === 0) {
        viewContainer.append('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ยังไม่มีข้อมูลการประเมินคุณลักษณะ</p></div>');
    }
}

function renderStudentValuesCompetenciesView(state) {
    const viewContainer = $('#student-values-competencies-content');
    viewContainer.empty();

    // 1. ดึงข้อมูลที่จำเป็นจาก state
    const student = state.user;
    const { valuesCompetenciesItems, valuesCompetenciesScores } = state;

    // 2. ตรวจสอบว่ามีรายการประเมินในระบบหรือไม่
    if (!valuesCompetenciesItems || valuesCompetenciesItems.length === 0) {
        viewContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ไม่พบรายการประเมินค่านิยมและสมรรถนะในระบบ</p></div>');
        return;
    }

    // 3. แบ่งรายการประเมินออกเป็น 2 กลุ่ม
    const valuesItems = valuesCompetenciesItems.filter(i => i.itemGroup === 'ค่านิยมหลักของคนไทย 12 ประการ');
    const competenciesItems = valuesCompetenciesItems.filter(i => i.itemGroup === 'สมรรถนะสำคัญของผู้เรียน');

    // 4. คำนวณผลสรุปของแต่ละกลุ่ม
    let valuesSum = 0, valuesCount = 0;
    valuesItems.forEach(item => {
        const scoreRecord = valuesCompetenciesScores.find(s => s.studentId === student.id && s.itemId === item.id);
        if (scoreRecord && scoreRecord.score) {
            valuesSum += parseInt(scoreRecord.score, 10);
            valuesCount++;
        }
    });

    let competenciesSum = 0, competenciesCount = 0;
    competenciesItems.forEach(item => {
        const scoreRecord = valuesCompetenciesScores.find(s => s.studentId === student.id && s.itemId === item.id);
        if (scoreRecord && scoreRecord.score) {
            competenciesSum += parseInt(scoreRecord.score, 10);
            competenciesCount++;
        }
    });
    
    // 5. แปลงผลสรุปเป็นข้อความ (ดีเยี่ยม, ดี, ผ่าน, ไม่ผ่าน)
    let valuesResultText = '-', valuesResultClass = 'text-gray-500';
    if (valuesCount > 0) {
        const percentage = (valuesSum / (valuesCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        valuesResultText = style.text;
        valuesResultClass = style.class;
    }

    let competenciesResultText = '-', competenciesResultClass = 'text-gray-500';
    if (competenciesCount > 0) {
        const percentage = (competenciesSum / (competenciesCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        competenciesResultText = style.text;
        competenciesResultClass = style.class;
    }

    // 6. สร้างการ์ดสรุปผล (Summary Cards)
    const summaryHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div class="stat-card-new !p-4">
                <div class="stat-icon !w-12 !h-12"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6"><path fill-rule="evenodd" d="M9.315 7.584C12.195 3.883 16.695 1.5 21.75 1.5a.75.75 0 0 1 .75.75c0 5.056-2.383 9.555-6.084 12.436A6.75 6.75 0 0 1 9.75 22.5a.75.75 0 0 1-.75-.75v-4.131A15.838 15.838 0 0 1 6.382 15H2.25a.75.75 0 0 1-.75-.75 6.75 6.75 0 0 1 7.815-6.666ZM15 6.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" clip-rule="evenodd" /><path d="M5.26 17.242a.75.75 0 1 0-.897-1.203 5.243 5.243 0 0 0-2.05 5.022.75.75 0 0 0 .625.627 5.243 5.243 0 0 0 5.022-2.051.75.75 0 1 0-1.202-.897 3.744 3.744 0 0 1-3.008 1.51c0-1.23.592-2.323 1.51-3.008Z" /></svg></div>
                <div class="stat-info !gap-0">
                    <h3 class="!text-sm">ค่านิยม 12 ประการ</h3>
                    <p class="!text-3xl ${valuesResultClass}">${valuesResultText}</p>
                </div>
            </div>
            <div class="stat-card-new !p-4">
                <div class="stat-icon !w-12 !h-12"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6"><path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.84 2.84l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.84 2.84l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.84-2.84l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.25 2.25 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.25 2.25 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.558l.52 2.082a1.5 1.5 0 0 0 1.14 1.14l2.082.52a.75.75 0 0 1 0 1.424l-2.082.52a1.5 1.5 0 0 0-1.14 1.14l-.52 2.082a.75.75 0 0 1-1.424 0l-.52-2.082a1.5 1.5 0 0 0-1.14-1.14l-2.082-.52a.75.75 0 0 1 0-1.424l2.082-.52a1.5 1.5 0 0 0 1.14-1.14l.52-2.082A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" /></svg></div>
                <div class="stat-info !gap-0">
                    <h3 class="!text-sm">สมรรถนะสำคัญ</h3>
                    <p class="!text-3xl ${competenciesResultClass}">${competenciesResultText}</p>
                </div>
            </div>
        </div>
    `;
    viewContainer.append(summaryHtml);

    // 7. สร้างตารางแสดงผลรายข้อ
    const scoreDisplayMap = { '3': { text: 'ดีเยี่ยม', class: 'bg-green-100 text-green-800' }, '2': { text: 'ดี', class: 'bg-blue-100 text-blue-800' }, '1': { text: 'ผ่าน', class: 'bg-orange-100 text-orange-800' }, '0': { text: 'ไม่ผ่าน', class: 'bg-red-100 text-red-800' }, '-': { text: '-', class: 'bg-gray-100 text-gray-800' } };

    const createCardHtml = (items, title) => {
        if (items.length === 0) return '';
        const tableRows = items.map(item => {
            const scoreRecord = valuesCompetenciesScores.find(s => s.studentId === student.id && s.itemId === item.id);
            const score = scoreRecord ? scoreRecord.score : '-';
            const display = scoreDisplayMap[score] || scoreDisplayMap['-'];
            return `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${item.itemName}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 font-semibold leading-tight rounded-full ${display.class}">
                            ${display.text}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');

        return `
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="border-b pb-3 mb-4">
                    <h4 class="text-xl font-bold" style="color: var(--primary-color);">${title}</h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">รายการ</th>
                                <th scope="col" class="px-6 py-3 text-center">ผลการประเมิน</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            </div>
        `;
    };

    if (valuesItems.length > 0) {
        viewContainer.append(createCardHtml(valuesItems, 'ค่านิยมหลักของคนไทย 12 ประการ'));
    }
    if (competenciesItems.length > 0) {
        viewContainer.append(createCardHtml(competenciesItems, 'สมรรถนะสำคัญของผู้เรียน'));
    }
    
    if (valuesItems.length === 0 && competenciesItems.length === 0) {
         viewContainer.append('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ยังไม่มีข้อมูลการประเมิน</p></div>');
    }
}

function renderStudentActivitiesView(state) {
    const viewContainer = $('#student-activities-content');
    viewContainer.empty();

    const student = state.user;
    const { activityComponents, activityScores } = state;

    if (!activityComponents || activityComponents.length === 0) {
        viewContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ไม่พบรายการกิจกรรมพัฒนาผู้เรียนในระบบ</p></div>');
        return;
    }

    const studentComponentResults = activityComponents.map(component => {
        const scoreRecord = activityScores.find(s => s.studentId === student.id && s.componentId === component.id);
        return {
            componentName: component.componentName,
            result: scoreRecord ? scoreRecord.result : 'ยังไม่ได้ประเมิน'
        };
    });

    if (studentComponentResults.length === 0) {
        viewContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ยังไม่มีข้อมูลการประเมินกิจกรรมพัฒนาผู้เรียน</p></div>');
        return;
    }
    
    const tableHtml = `
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="border-b pb-3 mb-4">
                <h4 class="text-xl font-bold" style="color: var(--primary-color);">ผลการประเมินกิจกรรมพัฒนาผู้เรียน</h4>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">รายการกิจกรรม</th>
                            <th scope="col" class="px-6 py-3 text-center">ผลการประเมิน</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentComponentResults.map(item => {
                            let displayClass = 'bg-gray-100 text-gray-800';
                            if (item.result === 'ผ่าน') {
                                displayClass = 'bg-green-100 text-green-800';
                            } else if (item.result === 'ไม่ผ่าน') {
                                displayClass = 'bg-red-100 text-red-800';
                            }
                            return `
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 font-medium text-gray-900">${item.componentName}</td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="px-3 py-1 font-semibold leading-tight rounded-full ${displayClass}">
                                            ${item.result}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    viewContainer.html(tableHtml);
}

// 2. ฟังก์ชันแสดงผลเวลาเรียน
function renderStudentAttendanceView(state) {
    const studentAttendance = state.attendance || [];
    const subjects = state.subjects || [];
    const teachers = state.teachers || [];
    const viewContainer = $('#student-attendance-content');
    viewContainer.empty();

    const totalPresent = studentAttendance.filter(r => r.status === 'present').length;
    const totalAbsent = studentAttendance.filter(r => r.status === 'absent').length;
    const totalLeave = studentAttendance.filter(r => r.status === 'leave').length;
    const totalLate = studentAttendance.filter(r => r.status === 'late').length;

    const summaryHtml = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stat-card-new !p-4"><div class="stat-icon !w-12 !h-12"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="stat-info !gap-0"><h3 class="!text-sm">มาเรียน</h3><p class="!text-3xl">${totalPresent}</p></div></div>
            <div class="stat-card-new !p-4"><div class="stat-icon !w-12 !h-12"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="stat-info !gap-0"><h3 class="!text-sm">ขาด</h3><p class="!text-3xl">${totalAbsent}</p></div></div>
            <div class="stat-card-new !p-4"><div class="stat-icon !w-12 !h-12"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg></div><div class="stat-info !gap-0"><h3 class="!text-sm">ลา</h3><p class="!text-3xl">${totalLeave}</p></div></div>
            <div class="stat-card-new !p-4"><div class="stat-icon !w-12 !h-12"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="stat-info !gap-0"><h3 class="!text-sm">สาย</h3><p class="!text-3xl">${totalLate}</p></div></div>
        </div>
    `;
    viewContainer.append(summaryHtml);

    const filterHtml = `
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div><label class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label><input type="date" id="student-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                <div><label class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label><input type="date" id="student-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                <div><label class="block text-sm font-medium text-gray-700">รายวิชา</label><select id="student-subject-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="">ทุกรายวิชา</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700">สถานะ</label><select id="student-status-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="">ทุกสถานะ</option><option value="present">มาเรียน</option><option value="absent">ขาด</option><option value="leave">ลา</option><option value="late">สาย</option></select></div>
                <button id="student-filter-btn" class="btn-primary w-full py-2 px-4 rounded-md shadow-sm text-sm font-medium">ค้นหา</button>
            </div>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8">รายการเข้าเรียน</h3>
    `;
    viewContainer.append(filterHtml);
    
    const subjectSelect = $('#student-subject-filter');
    subjects.forEach(s => {
        subjectSelect.append(`<option value="${s.id}">${s.code} - ${s.name}</option>`);
    });

    viewContainer.append('<div id="student-report-container"></div>');
    displayStudentAttendance(studentAttendance, subjects, teachers);

    $('#student-filter-btn').off('click').on('click', function() {
        const startDate = $('#student-start-date').val();
        const endDate = $('#student-end-date').val();
        const subjectId = $('#student-subject-filter').val();
        const status = $('#student-status-filter').val();
        let filteredRecords = studentAttendance;
        if (startDate) { filteredRecords = filteredRecords.filter(r => r.date >= startDate); }
        if (endDate) { filteredRecords = filteredRecords.filter(r => r.date <= endDate); }
        if (subjectId) { filteredRecords = filteredRecords.filter(r => r.subjectId === subjectId); }
        if (status) { filteredRecords = filteredRecords.filter(r => r.status === status); }
        displayStudentAttendance(filteredRecords, subjects, teachers);
    });
}

// 3. ฟังก์ชันแสดงผลคะแนน (แก้ไขให้แสดงผลเสมอ)
function renderStudentScoreView(state) {
    const viewContainer = $('#student-scores-content');
    viewContainer.empty();

    const { scores, scoreComponents, subjects, teachers } = state;
    
    if (!scoreComponents || scoreComponents.length === 0) {
        viewContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ไม่พบรายวิชาที่มีการเก็บคะแนน</p></div>');
        return;
    }

    const componentsBySubject = scoreComponents.reduce((acc, component) => {
        if (!acc[component.subjectId]) {
            acc[component.subjectId] = [];
        }
        acc[component.subjectId].push(component);
        return acc;
    }, {});
    
    Object.keys(componentsBySubject).forEach(subjectId => {
        const subjectComponents = componentsBySubject[subjectId];
        const subjectInfo = subjects.find(s => s.id === subjectId) || { name: 'ไม่พบชื่อวิชา', code: '' };
        
        const teacherInfo = teachers.find(t => t.id === subjectComponents[0].teacherId);

        let totalScore = 0;
        let totalMaxScore = 0;
        let tableRowsHtml = '';

        // --- START: ส่วนที่แก้ไข ---
        // 1. ค้นหา "หมายเหตุ" ของนักเรียนคนนี้
        const remarkRecord = scores.find(s => s.studentId === state.user.id && s.componentId === 'remark' && s.subjectId === subjectId);
        const studentRemark = remarkRecord ? remarkRecord.remark : '-';
        // --- END: ส่วนที่แก้ไข ---

        subjectComponents.sort((a,b) => a.componentName.localeCompare(b.componentName)).forEach(component => {
            const scoreRecord = scores.find(s => s.componentId === component.id);
            const score = scoreRecord && scoreRecord.score ? parseFloat(scoreRecord.score) : 0;
            const maxScore = parseFloat(component.maxScore);

            totalScore += score;
            totalMaxScore += maxScore;

            tableRowsHtml += `
                <tr class="border-b">
                    <td class="py-2 px-4">${component.componentName}</td>
                    <td class="py-2 px-4 text-center">${score}</td>
                    <td class="py-2 px-4 text-center">${maxScore}</td>
                </tr>
            `;
        });
        
        // --- START: ส่วนที่แก้ไข ---
        // 2. ส่งค่า 'หมายเหตุ' เข้าไปในฟังก์ชัน calculateGrade ด้วย
         const finalGrade = calculateGrade(totalScore, totalMaxScore, studentRemark);
        // --- END: ส่วนที่แก้ไข ---

        const cardHtml = `
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="border-b pb-3 mb-4">
                    <h4 class="text-xl font-bold" style="color: var(--primary-color);">${subjectInfo.code} - ${subjectInfo.name}</h4>
                    <p class="text-sm text-gray-500">ผู้สอน: ${teacherInfo ? teacherInfo.name : 'ไม่ระบุ'}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3">รายการ</th>
                                <th scope="col" class="px-4 py-3 text-center">คะแนนที่ได้</th>
                                <th scope="col" class="px-4 py-3 text-center">คะแนนเต็ม</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRowsHtml}
                        </tbody>
                        <tfoot class="font-bold">
                            <tr class="bg-gray-100">
                                <td class="py-2 px-4 text-right">รวม</td>
                                <td class="py-2 px-4 text-center">${totalScore.toFixed(2)}</td>
                                <td class="py-2 px-4 text-center">${totalMaxScore.toFixed(2)}</td>
                            </tr>
                            <tr class="bg-blue-100 text-blue-800">
                                <td class="py-2 px-4 text-right">เกรด</td>
                                <td class="py-2 px-4 text-center" colspan="2">${finalGrade}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        `;
        viewContainer.append(cardHtml);
    });

    if (viewContainer.is(':empty')) {
        viewContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ยังไม่มีข้อมูลคะแนนในรายวิชาที่ท่านเรียน</p></div>');
    }
}

function displayStudentAttendance(records, allSubjects, allTeachers) {
    const reportContainer = $('#student-report-container');
    reportContainer.empty();

    // จัดกลุ่มข้อมูลตามรายวิชา
    const attendanceBySubject = records.reduce((acc, record) => {
        if (!acc[record.subjectId]) {
            acc[record.subjectId] = [];
        }
        acc[record.subjectId].push(record);
        return acc;
    }, {});

    if (Object.keys(attendanceBySubject).length === 0) {
        reportContainer.html('<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">ไม่พบข้อมูลตามเงื่อนไขที่เลือก</p></div>');
        return;
    }

    // วนลูปสร้างการ์ดสำหรับแต่ละรายวิชา
    allSubjects.forEach(subject => {
        const subjectRecords = attendanceBySubject[subject.id];
        if (!subjectRecords || subjectRecords.length === 0) return;

        const teacherName = subjectRecords[0].teacherName || 'ไม่ระบุ';

        const subjectCardHtml = `
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="border-b pb-3 mb-4">
                    <h4 class="text-xl font-bold" style="color: var(--primary-color);">${subject.code} - ${subject.name}</h4>
                    <p class="text-sm text-gray-500">ผู้สอน: ${teacherName}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">วันที่</th>
                                <th scope="col" class="px-6 py-3">สถานะ</th>
                                <th scope="col" class="px-6 py-3">หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subjectRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => {
                                const statusMap = {
                                    present: { text: 'มาเรียน', class: 'bg-green-100 text-green-800' },
                                    absent: { text: 'ขาดเรียน', class: 'bg-red-100 text-red-800' },
                                    leave: { text: 'ลา', class: 'bg-yellow-100 text-yellow-800' },
                                    late: { text: 'มาสาย', class: 'bg-pink-100 text-pink-800' }
                                };
                                const statusInfo = statusMap[record.status] || { text: record.status, class: 'bg-gray-100 text-gray-800' };
                                return `
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium text-gray-900">${formatThaiDate(record.date)}</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 font-semibold leading-tight rounded-full ${statusInfo.class}">
                                                ${statusInfo.text}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">${record.remark || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        reportContainer.append(subjectCardHtml);
    });
}

function loadClassLevelSettings() {
    if (appState.user.role !== 'admin') return;

    console.log('Rendering class level settings from appState...');
    const classLevelsContainer = $('#class-levels');
    classLevelsContainer.empty();

    // ดึงข้อมูลทั้งหมดจาก appState ที่โหลดมาแล้ว ไม่ต้องเรียกเซิร์ฟเวอร์ใหม่
    const { allSettings, allLevels, enabledLevels } = appState.classLevelSettings;

    const groupOrder = [
        'ระดับปฐมวัย', 'ระดับประถมศึกษาตอนต้น', 'ระดับประถมศึกษาตอนปลาย', 
        'ระดับมัธยมศึกษาตอนต้น', 'ระดับมัธยมศึกษาตอนปลาย', 
        'ระดับอาชีวศึกษา', 'ระดับอุดมศึกษา'
    ];

    let formHtml = `
        <h2 class="text-2xl font-bold mb-6">จัดการระดับชั้น</h2>
        <div class="bg-white rounded-lg shadow p-6">
            <form id="class-levels-form">
                <div class="mb-6">
                    <label for="school-type-name" class="block text-gray-700 mb-2 font-semibold">ชื่อประเภทสถานศึกษา</label>
                    <input type="text" id="school-type-name" name="school-type-name" class="w-full px-3 py-2 border rounded-lg" value="${allSettings.school_type_name || ''}" placeholder="เช่น โรงเรียน, มหาวิทยาลัย" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2 font-semibold">เลือกระดับชั้นที่เปิดสอน</label>
                    <div class="space-y-4">
    `;

    groupOrder.forEach(groupName => {
        if (!allLevels[groupName]) return;
        const levelsInGroup = allLevels[groupName];
        let isGroupChecked = levelsInGroup.every(level => enabledLevels.includes(level));
        formHtml += `<fieldset class="border rounded-lg p-4"><legend class="px-2 font-medium">${groupName}</legend><div class="p-2 space-y-2"><p class="text-sm text-gray-500 mb-3">(${levelsInGroup.join(', ')})</p><div class="flex items-center"><input id="group-checkbox-${groupName.replace(/\s/g, '')}" type="checkbox" class="group-checkbox h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" data-group="${groupName}" ${isGroupChecked ? 'checked' : ''}><label for="group-checkbox-${groupName.replace(/\s/g, '')}" class="ml-3 text-md text-gray-700 select-none cursor-pointer font-semibold">เลือกทั้งหมดในกลุ่ม ${groupName}</label></div>`;
        levelsInGroup.forEach(level => {
            let isChecked = enabledLevels.includes(level);
            formHtml += `<div class="hidden"><input type="checkbox" class="level-checkbox" data-group-name="${groupName}" name="class_level" value="${level}" ${isChecked ? 'checked' : ''}></div>`;
        });
        formHtml += `</div></fieldset>`;
    });

    formHtml += `</div></div><div class="text-center mt-6"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">บันทึกการตั้งค่า</button></div></form></div>`;
    classLevelsContainer.html(formHtml);

    // ตัวแปรเพื่อป้องกัน SweetAlert ซ้ำ
    let isAlertShown = false;

    // ผูก Event Listener ใหม่ทุกครั้งที่วาดหน้าจอ
    $('.group-checkbox').off('change.classLevel').on('change.classLevel', function() {
        var groupName = $(this).data('group');
        var isChecked = $(this).is(':checked');
        $(`input.level-checkbox[data-group-name="${groupName}"]`).prop('checked', isChecked);
    });

    $('#class-levels-form').off('submit.classLevel').on('submit.classLevel', function(e) {
        e.preventDefault();
        if (isLoading) {
            if (!isAlertShown) {
                isAlertShown = true;
                Swal.fire({
                    icon: 'warning',
                    title: 'กำลังประมวลผล',
                    text: 'กรุณารอให้การบันทึกครั้งก่อนเสร็จสิ้น',
                    confirmButtonColor: 'var(--primary-color)'
                }).then(() => { isAlertShown = false; });
            }
            return;
        }
        let enabledLevels = [];
        $('input[name="class_level"]:checked').each(function() { enabledLevels.push($(this).val()); });
        if (enabledLevels.length === 0) {
            if (!isAlertShown) {
                isAlertShown = true;
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบถ้วน',
                    text: 'กรุณาเลือกระดับชั้นอย่างน้อย 1 รายการ',
                    confirmButtonColor: 'var(--primary-color)'
                }).then(() => { isAlertShown = false; });
            }
            return;
        }
        const schoolTypeName = $('#school-type-name').val();
        const completeSettingsData = { 
            school_type_name: schoolTypeName, 
            enabled_class_levels: JSON.stringify(enabledLevels) 
        };
        
        openModal('settings-modal');
        $('#settings-confirm-form').off('submit.classLevel').on('submit.classLevel', function(confirmEvent) {
            confirmEvent.preventDefault();
            const adminPassword = $('#admin-password').val();
            if (!adminPassword) {
                if (!isAlertShown) {
                    isAlertShown = true;
                    Swal.fire({
                        icon: 'error',
                        title: 'ข้อมูลไม่ครบถ้วน',
                        text: 'กรุณากรอกรหัสผ่านผู้ดูแลระบบ',
                        confirmButtonColor: 'var(--primary-color)'
                    }).then(() => { isAlertShown = false; });
                }
                return;
            }
            
            isLoading = true; // ตั้งสถานะเพื่อป้องกันการกดซ้ำ
            completeSettingsData.admin_password = adminPassword;
            
            showLoading(); // เพิ่มการแสดง loading overlay
            
            const timeout = setTimeout(() => {
                isLoading = false;
                hideLoading(); // ปิด loading หาก timeout
                if (!isAlertShown) {
                    isAlertShown = true;
                    Swal.fire({
                        icon: 'error',
                        title: 'การบันทึกล่าช้า',
                        text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                        confirmButtonColor: 'var(--primary-color)'
                    }).then(() => { isAlertShown = false; });
                }
            }, 5000);
            
            google.script.run
                .withSuccessHandler(function(result) {
                    clearTimeout(timeout);
                    hideLoading(); // ปิด loading เมื่อสำเร็จ
                    if (result.success) {
                        closeModal('settings-modal');
                        $('#admin-password').val('');
                        if (!isAlertShown) {
                            isAlertShown = true;
                            Swal.fire({
                                icon: 'success',
                                title: 'สำเร็จ!',
                                text: 'บันทึกการตั้งค่าเรียบร้อยแล้ว',
                                confirmButtonColor: 'var(--primary-color)'
                            }).then(() => {
                                isAlertShown = false;
                                // อัปเดต appState และรีเฟรช
                                appState.classLevelSettings.enabledLevels = enabledLevels;
                                appState.classLevelSettings.allSettings.schoolName = schoolTypeName;
                                populateAllDropdowns();
                                loadClassLevelSettings();
                            });
                        }
                    } else {
                        if (!isAlertShown) {
                            isAlertShown = true;
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: result.message || 'การบันทึกล้มเหลว',
                                confirmButtonColor: 'var(--primary-color)'
                            }).then(() => { isAlertShown = false; });
                        }
                    }
                    isLoading = false;
                })
                .withFailureHandler(function(error) {
                    clearTimeout(timeout);
                    hideLoading(); // ปิด loading เมื่อเกิดข้อผิดพลาด
                    if (!isAlertShown) {
                        isAlertShown = true;
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: error.message || 'การบันทึกล้มเหลว',
                            confirmButtonColor: 'var(--primary-color)'
                        }).then(() => { isAlertShown = false; });
                    }
                    isLoading = false;
                })
                .saveSettings(completeSettingsData);
        });
    });
}

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
    } else {
        console.error(`Modal ${modalId} not found`);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    } else {
        console.error(`Modal ${modalId} not found`);
    }
}

$(document).on('click', '.close, .close-modal', function() {
    const modal = this.closest('.modal');
    if (modal) {
        closeModal(modal.id);
    }
});

// แก้ไขฟังก์ชันนี้เพื่อป้องกันการปิด Modal บางประเภท
window.addEventListener('click', function(event) {
    // เพิ่มเงื่อนไข !event.target.classList.contains('non-dismissible')
    if (event.target.classList.contains('modal') && !event.target.classList.contains('non-dismissible')) {
        closeModal(event.target.id);
    }
});

function showLoading() {
    console.log('Showing loading overlay');
    isLoading = true;
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'block';
    }
}

function hideLoading() {
    console.log('Hiding loading overlay');
    isLoading = false;
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function loadDashboard() {
    if (!appState.isDataLoaded) {
        console.warn("Dashboard is being loaded before initial data is ready.");
        return;
    }
    console.log('Routing dashboard based on user role and mode...');
    const user = appState.user;
    const teacherMode = sessionStorage.getItem('teacherChoiceMode');

    // ซ่อน/แสดง แดชบอร์ดที่ถูกต้อง
    if (user.role === 'teacher' && teacherMode === 'scoring') {
        $('#attendance-dashboard-view').addClass('hidden');
        $('#scoring-dashboard-view').removeClass('hidden');
        renderScoringDashboard();
    } else {
        $('#scoring-dashboard-view').addClass('hidden');
        $('#attendance-dashboard-view').removeClass('hidden');
        renderAttendanceDashboard();
    }
}

// ฟังก์ชันสำหรับแดชบอร์ดการเข้าเรียน (โค้ดเดิม)
function renderAttendanceDashboard() {
    console.log('Loading attendance dashboard from appState...');
    const { students, attendance, user } = appState;
    const today = normalizeDate(new Date());
    let filteredStudents = students;
    let filteredAttendance = attendance;
    if (user.role === 'teacher') {
        let pairs = [];
        try { pairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) { console.warn('Invalid subjectClassPairs for dashboard:', user.subjectClassPairs); }
        const validClasses = pairs.flatMap(p => p.classLevels || []);
        const validClassrooms = pairs.flatMap(p => p.classrooms || []);
        const validSubjects = pairs.map(p => p.subjectId);
        filteredStudents = students.filter(s => validClasses.includes(s.class) && validClassrooms.includes(s.classroom || ''));
        filteredAttendance = attendance.filter(a => validClasses.includes(a.class) && validClassrooms.includes(a.classroom || '') && validSubjects.includes(a.subjectId) && a.teacherName === user.name);
    }
    const totalStudents = filteredStudents.length;
    const todayAttendance = filteredAttendance.filter(a => a.date === today);
    const presentCount = todayAttendance.filter(a => a.status === 'present').length;
    const absentCount = todayAttendance.filter(a => a.status === 'absent').length;
    const leaveCount = todayAttendance.filter(a => a.status === 'leave').length;
    const lateCount = todayAttendance.filter(a => a.status === 'late').length;
    animateCountUp('total-students', totalStudents);
    animateCountUp('present-students', presentCount);
    animateCountUp('absent-students', absentCount);
    animateCountUp('leave-students', leaveCount);
    animateCountUp('late-students', lateCount);
    const presentByStudent = {};
    filteredAttendance.forEach(a => { if (a.status === 'present') { presentByStudent[a.studentId] = (presentByStudent[a.studentId] || 0) + 1; } });
    const topPresent = Object.entries(presentByStudent).map(([studentId, count]) => { const student = filteredStudents.find(s => s.id === studentId); return student ? { student, count } : null; }).filter(Boolean).sort((a, b) => b.count - a.count).slice(0, 5);
    const ctxPie = document.getElementById('attendance-pie-chart').getContext('2d');
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctxPie, { type: 'doughnut', data: { labels: ['มาเรียน', 'ขาดเรียน', 'ลา', 'สาย'], datasets: [{ data: [presentCount, absentCount, leaveCount, lateCount], backgroundColor: ['#10B981', '#EF4444', '#F59E0B', '#EC4899'], borderColor: '#ffffff', borderWidth: 4, hoverOffset: 10 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', animation: { animateScale: true, animateRotate: true }, plugins: { legend: { position: 'bottom', labels: { font: { family: 'Sarabun', size: 14 }, padding: 20 } }, tooltip: { bodyFont: { family: 'Sarabun' }, titleFont: { family: 'Sarabun' }, boxPadding: 5 } } } });
    const ctxBar = document.getElementById('top-present-bar-chart').getContext('2d');
    if (barChart) barChart.destroy();
    const gradient = ctxBar.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
    gradient.addColorStop(1, 'rgba(37, 99, 235, 0.6)');
    barChart = new Chart(ctxBar, { type: 'bar', data: { labels: topPresent.map(item => item.student.name), datasets: [{ label: 'จำนวนวันที่มาเรียน', data: topPresent.map(item => item.count), backgroundColor: gradient, borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 8, hoverBackgroundColor: 'rgba(37, 99, 235, 1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { font: { family: 'Sarabun' } } }, x: { grid: { display: false }, ticks: { font: { family: 'Sarabun' } } } }, plugins: { legend: { display: false }, tooltip: {} } } });
    console.log('Attendance dashboard rendered.');
}

// ฟังก์ชันใหม่สำหรับแดชบอร์ดคะแนน
function renderScoringDashboard() {
    console.log('Loading scoring dashboard from appState...');
    const { students, scores, scoreComponents, user } = appState;

    if (!scoreComponents || scoreComponents.length === 0) {
        $('#scoring-dashboard-view').html('<div class="text-center p-10 bg-white rounded-lg shadow"><p class="text-gray-500">ยังไม่มีข้อมูลคะแนนสำหรับแสดงผลในแดชบอร์ด</p><p class="text-gray-400 text-sm mt-2">กรุณาไปที่หน้า "จัดการคะแนน" เพื่อเพิ่มองค์ประกอบและบันทึกคะแนนก่อน</p></div>');
        return;
    }
    
    // คำนวณข้อมูลนักเรียนแต่ละคน
    const studentScores = students.map(student => {
        const studentData = { id: student.id, name: student.name, totalScore: 0, totalMaxScore: 0 };
        scoreComponents.forEach(comp => {
            const scoreRecord = scores.find(s => s.studentId === student.id && s.componentId === comp.id);
            if (scoreRecord && scoreRecord.score) {
                studentData.totalScore += parseFloat(scoreRecord.score);
                studentData.totalMaxScore += parseFloat(comp.maxScore);
            }
        });
        studentData.grade = studentData.totalMaxScore > 0 ? calculateGrade(studentData.totalScore, studentData.totalMaxScore) : '-';
        return studentData;
    }).filter(s => s.totalMaxScore > 0); // กรองเฉพาะนักเรียนที่มีการให้คะแนน

    // คำนวณ Stat Cards
    const totalGradedStudents = studentScores.length;
    const averageScore = totalGradedStudents > 0 ? studentScores.reduce((acc, s) => acc + s.totalScore, 0) / totalGradedStudents : 0;
    const maxScore = totalGradedStudents > 0 ? Math.max(...studentScores.map(s => s.totalScore)) : 0;
    const minScore = totalGradedStudents > 0 ? Math.min(...studentScores.map(s => s.totalScore)) : 0;

    animateCountUp('score-graded-students', totalGradedStudents);
    document.getElementById('score-avg').textContent = averageScore.toFixed(2);
    animateCountUp('score-max', maxScore);
    animateCountUp('score-min', minScore);
    
    // 1. สร้างข้อมูลสำหรับ Grade Distribution Chart
    const gradeCounts = { '4': 0, '3.5': 0, '3': 0, '2.5': 0, '2': 0, '1.5': 0, '1': 0, '0': 0 };
    studentScores.forEach(s => {
        if (gradeCounts.hasOwnProperty(s.grade)) {
            gradeCounts[s.grade]++;
        }
    });

    const gradeCtx = document.getElementById('grade-distribution-pie-chart').getContext('2d');
    if (gradeDistChart) gradeDistChart.destroy();
    gradeDistChart = new Chart(gradeCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(gradeCounts),
            datasets: [{
                data: Object.values(gradeCounts),
                backgroundColor: ['#10B981', '#34D399', '#6EE7B7', '#A7F3D0', '#F59E0B', '#FBBF24', '#FCD34D', '#EF4444'],
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // 2. สร้างข้อมูลสำหรับ Component Average Chart
    const componentAverages = scoreComponents.map(comp => {
        const componentId = comp.id;
        const maxScore = parseFloat(comp.maxScore);
        const scoresForComp = scores.filter(s => s.componentId === componentId && s.score);
        const average = scoresForComp.length > 0
            ? (scoresForComp.reduce((acc, s) => acc + parseFloat(s.score), 0) / scoresForComp.length)
            : 0;
        const percentage = maxScore > 0 ? (average / maxScore) * 100 : 0;
        return {
            name: comp.componentName,
            percentage: percentage.toFixed(2)
        };
    });

    const componentCtx = document.getElementById('component-average-bar-chart').getContext('2d');
    if (componentAvgChart) componentAvgChart.destroy();
    componentAvgChart = new Chart(componentCtx, {
        type: 'bar',
        data: {
            labels: componentAverages.map(c => c.name),
            datasets: [{
                label: 'คะแนนเฉลี่ย (%)',
                data: componentAverages.map(c => c.percentage),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } },
            plugins: { legend: { display: false } }
        }
    });
    console.log('Scoring dashboard rendered.');
}


document.getElementById('add-subject-btn').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    document.getElementById('subject-modal-title').textContent = 'เพิ่มรายวิชา';
    document.getElementById('subject-form').reset();
    document.getElementById('subject-id').value = '';
    // --- START: ส่วนที่แก้ไข ---
    // ทำให้ช่องกรอกหน่วยกิตเป็นตัวเลขทศนิยมได้
    $('#subject-credits').attr('step', '0.5'); 
    // --- END: ส่วนที่แก้ไข ---
    openModal('subject-modal');
});


document.getElementById('add-teacher-btn').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    document.getElementById('teacher-modal-title').textContent = 'เพิ่มครูผู้สอน';
    document.getElementById('teacher-form').reset();
    document.getElementById('teacher-id').value = '';
    document.querySelector('#subject-class-table tbody').innerHTML = '';
    initializeSubjectClassTable([], GLOBAL_ENABLED_LEVELS);
    openModal('teacher-modal');
});


document.getElementById('add-student-btn').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    const studentClassSelect = document.getElementById('student-class');
    studentClassSelect.innerHTML = '<option value="">-- เลือกระดับชั้น --</option>'; 
    if (GLOBAL_ENABLED_LEVELS && GLOBAL_ENABLED_LEVELS.length > 0) {
        GLOBAL_ENABLED_LEVELS.forEach(level => { const option = document.createElement('option'); option.value = level; option.textContent = level; studentClassSelect.appendChild(option); });
    }
    document.getElementById('student-modal-title').textContent = 'เพิ่มนักเรียน';
    document.getElementById('student-form').reset();
    document.getElementById('student-id').value = '';
    openModal('student-modal');
});

// วางทับฟังก์ชันเดิม
function populateClassLevelDropdowns(enabledLevels = []) {
    if (!enabledLevels) enabledLevels = []; 
    let filteredClassLevels = [...enabledLevels];
    if (appState.user && appState.user.role === 'teacher') {
        let pairs = [];
        try { pairs = JSON.parse(appState.user.subjectClassPairs || '[]'); } catch (e) {}
        const teacherLevels = [...new Set(pairs.flatMap(p => p.classLevels || []))];
        filteredClassLevels = enabledLevels.filter(level => teacherLevels.includes(level));
    }
    const classSelects = [ 
        document.getElementById('student-class'), 
        document.getElementById('attendance-class'), 
        document.getElementById('report-class'), 
        document.getElementById('classroom-report-class'), 
        document.getElementById('school-report-class'),
        document.getElementById('student-filter-class') // <-- เพิ่มบรรทัดนี้
    ];
    classSelects.forEach(select => {
        if (select) {
            // แก้ไขให้ใช้ all สำหรับตัวกรอง, และใช้ '' สำหรับฟอร์มเพิ่ม/แก้ไข
            let defaultOption = (select.id === 'student-class') 
                ? '<option value="">-- เลือกระดับชั้น --</option>' 
                : '<option value="all" selected>ทุกระดับชั้น</option>';
            let optionsHtml = defaultOption;
            filteredClassLevels.forEach(level => { optionsHtml += `<option value="${level}">${level}</option>`; });
            select.innerHTML = optionsHtml;
        }
    });
}

function populateClassroomDropdowns(students) {
    let allClassrooms = [...new Set(students.map(s => s.classroom).filter(Boolean))].sort();
    let classroomsToDisplay = allClassrooms;
    if (appState.user && appState.user.role === 'teacher') {
        let pairs = [];
        try { pairs = JSON.parse(appState.user.subjectClassPairs || '[]'); } catch (e) {}
        const validClassrooms = [...new Set(pairs.flatMap(p => p.classrooms || []))];
        classroomsToDisplay = allClassrooms.filter(c => validClassrooms.includes(c));
    }
    const classroomSelects = [ 
        document.getElementById('attendance-classroom'), 
        document.getElementById('report-classroom'), 
        document.getElementById('classroom-report-classroom'), 
        document.getElementById('school-report-classroom'),
        document.getElementById('student-filter-classroom') // <-- เพิ่มบรรทัดนี้
    ];
    classroomSelects.forEach(select => {
        if (select) {
            let html = '<option value="" selected>ทุกห้องเรียน</option>';
            classroomsToDisplay.forEach(classroom => { html += `<option value="${classroom}">${classroom}</option>`; });
            select.innerHTML = html;
        }
    });
}

function setupPagination(tableId, rows, rowsPerPage = 30) {
    const tableBody = document.querySelector(`#${tableId} tbody`);
    const container = document.querySelector(`#${tableId}`)?.parentElement;
    if (!container || !tableBody) return;
    let paginationContainer = container.querySelector('.pagination-container');
    if(paginationContainer) paginationContainer.remove();
    if (rows.length <= rowsPerPage) {
        tableBody.innerHTML = rows.join('');
        return;
    }
    paginationContainer = document.createElement('div');
    paginationContainer.className = 'pagination-container';
    container.appendChild(paginationContainer);
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    let currentPage = 1;
    function renderPage(page) {
        currentPage = page;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        tableBody.innerHTML = rows.slice(start, end).join('');
        paginationContainer.innerHTML = '';
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination';
        const prevButton = document.createElement('button');
        prevButton.textContent = 'ก่อนหน้า';
        prevButton.disabled = page === 1;
        prevButton.addEventListener('click', () => renderPage(page - 1));
        paginationDiv.appendChild(prevButton);
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `หน้าที่ ${page} จาก ${totalPages}`;
        paginationDiv.appendChild(pageInfo);
        const nextButton = document.createElement('button');
        nextButton.textContent = 'ถัดไป';
        nextButton.disabled = page === totalPages;
        nextButton.addEventListener('click', () => renderPage(page + 1));
        paginationDiv.appendChild(nextButton);
        paginationContainer.appendChild(paginationDiv);
    }
    renderPage(currentPage);
}

function loadStudents() {
    console.log('Loading students from appState...');
    showLoading(); 
    const { students: allStudentsData, subjects: safeSubjectsData, user } = appState;
    if (!user) { hideLoading(); return; }

    const downloadTemplateBtn = document.getElementById('download-students-template');
    const importStudentsBtn = document.getElementById('import-students-btn');
    const addStudentBtn = document.getElementById('add-student-btn');
    const studentFiltersDiv = document.getElementById('student-filters');

    if (downloadTemplateBtn) downloadTemplateBtn.style.display = 'none';
    if (importStudentsBtn) importStudentsBtn.style.display = 'none';
    if (addStudentBtn) addStudentBtn.style.display = 'none';
    if (studentFiltersDiv) studentFiltersDiv.style.display = 'none';

    if (user.role === 'admin') {
        if (downloadTemplateBtn) downloadTemplateBtn.style.display = 'inline-block';
        if (importStudentsBtn) importStudentsBtn.style.display = 'inline-block';
        if (addStudentBtn) addStudentBtn.style.display = 'inline-block';
        if (studentFiltersDiv) studentFiltersDiv.style.display = 'block';
    } else if (user.role === 'teacher') {
        if (studentFiltersDiv) studentFiltersDiv.style.display = 'block';
    }

    const isTeacher = user.role === 'teacher';
    const headerColumns = ['ลำดับ', 'รหัสนักเรียน', 'ชื่อ-นามสกุล', 'ระดับชั้น', 'ห้องเรียน', ...(isTeacher ? ['รหัสวิชา', 'ชื่อวิชา'] : []), 'จัดการ'];
    $('#students-table thead').html(`<tr>${headerColumns.map(col => `<th>${col}</th>`).join('')}</tr>`);

    let studentsToDisplay = [...allStudentsData];

    if (isTeacher) {
        let pairs = [];
        try { pairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) {}
        const validClasses = pairs.flatMap(p => p.classLevels || []);
        const validClassrooms = pairs.flatMap(p => p.classrooms || []);
        studentsToDisplay = studentsToDisplay.filter(s => validClasses.includes(s.class) && validClassrooms.includes(s.classroom || ''));
    }

    // --- ส่วนที่แก้ไขและเพิ่มเติม ---
    // อ่านค่าจากตัวกรองทั้งหมด
    const searchQuery = ($('#student-search').val() || '').trim().toLowerCase();
    const classLevelFilter = $('#student-filter-class').val();
    const classroomFilter = $('#student-filter-classroom').val();

    // กรองด้วย Text Search
    if (searchQuery) {
        studentsToDisplay = studentsToDisplay.filter(s => (s.code || '').toLowerCase().includes(searchQuery) || (s.name || '').toLowerCase().includes(searchQuery));
    }
    // กรองด้วยระดับชั้น
    if (classLevelFilter && classLevelFilter !== 'all') {
        studentsToDisplay = studentsToDisplay.filter(s => s.class === classLevelFilter);
    }
    // กรองด้วยห้องเรียน
    if (classroomFilter) {
        studentsToDisplay = studentsToDisplay.filter(s => s.classroom === classroomFilter);
    }
    // --- สิ้นสุดส่วนแก้ไข ---

    let rows = [];
    if (studentsToDisplay.length === 0) {
        rows.push(`<tr><td colspan="${headerColumns.length}" class="text-center">ไม่พบข้อมูลนักเรียน</td></tr>`);
    } else {
        studentsToDisplay.forEach((student, index) => {
            let subjectCodes = '-';
            let subjectNames = '-';
            if (isTeacher) {
                let pairs = [];
                try { pairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) {}
                const subjectsForClass = pairs.filter(p => (p.classLevels || []).includes(student.class) && (p.classrooms || []).includes(student.classroom || '')).map(p => p.subjectId);
                if (subjectsForClass.length > 0) {
                    const mappedSubjects = subjectsForClass.map(id => safeSubjectsData.find(s => String(s.id) === String(id).trim())).filter(Boolean);
                    subjectCodes = mappedSubjects.map(s => s.code).join(', ') || '-';
                    subjectNames = mappedSubjects.map(s => s.name).join(', ') || '-';
                }
            }
            const actionButtons = `<button class="edit-student bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-2" data-id="${student.id}">แก้ไข</button>${user.role === 'admin' ? `<button class="delete-student bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${student.id}">ลบ</button>` : ''}`;
            rows.push(`<tr><td>${index + 1}</td><td>${student.code || '-'}</td><td>${student.name || '-'}</td><td>${student.class || '-'}</td><td>${student.classroom || '-'}</td>${isTeacher ? `<td>${subjectCodes}</td><td>${subjectNames}</td>` : ''}<td>${actionButtons}</td></tr>`);
        });
    }
    setupPagination('students-table', rows);
    hideLoading();
    console.log('Students displayed:', studentsToDisplay.length);
}

function exportTableToCSV(tableId, filename) {
    // สร้างหัวตาราง
    const headerRow = document.querySelector(`#${tableId} thead tr`);
    const headerData = [];
    headerRow.querySelectorAll('th').forEach(th => {
        let text = th.innerText.replace(/"/g, '""');
        if (text.includes(',') || text.includes('"')) text = `"${text}"`;
        headerData.push(text);
    });
    let csv = [headerData.join(',')];
    
    // เพิ่มข้อมูลจาก allReportRows (ทุกหน้า)
    window.allReportRows.forEach(rowHtml => {
        const row = document.createElement('tr');
        row.innerHTML = rowHtml;
        const rowData = [];
        row.querySelectorAll('td').forEach(td => {
            let text = td.innerText.replace(/"/g, '""');
            if (text.includes(',') || text.includes('"')) text = `"${text}"`;
            rowData.push(text);
        });
        csv.push(rowData.join(','));
    });
    
    downloadCSV(csv.join('\n'), filename);
}

function downloadCSV(csv, filename) {
    const BOM = '\uFEFF';
    const csvFile = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(csvFile);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.getElementById('export-csv').addEventListener('click', () => exportTableToCSV('report-table', 'รายงานเช็คชื่อ.csv'));

document.getElementById('export-xlsx').addEventListener('click', () => {
    // สร้างตารางชั่วคราวที่มีข้อมูลทุกหน้า
    const tempTable = document.createElement('table');
    tempTable.innerHTML = `
        <thead>${document.querySelector('#report-table thead').innerHTML}</thead>
        <tbody>${window.allReportRows.join('')}</tbody>
    `;
    const wb = XLSX.utils.table_to_book(tempTable, { sheet: 'รายงานเช็คชื่อ' });
    XLSX.writeFile(wb, 'รายงานเช็คชื่อ.xlsx');
});

document.getElementById('export-pdf').addEventListener('click', () => {
    showLoading();
    // สร้างตารางชั่วคราวที่มีข้อมูลทุกหน้า
    const tempTable = document.createElement('table');
    tempTable.innerHTML = `
        <thead>${document.querySelector('#report-table thead').innerHTML}</thead>
        <tbody>${window.allReportRows.join('')}</tbody>
    `;
    tempTable.style.width = '100%';
    tempTable.style.borderCollapse = 'collapse';
    tempTable.querySelectorAll('th, td').forEach(cell => {
        cell.style.border = '1px solid #d1d5db';
        cell.style.padding = '12px';
        cell.style.textAlign = 'left';
    });
    // สร้าง div ชั่วคราวเพื่อเก็บตาราง
    const tempContainer = document.createElement('div');
    tempContainer.appendChild(tempTable);
    document.body.appendChild(tempContainer);
    
    html2canvas(tempContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
        let heightLeft = imgHeight;
        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();
        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdf.internal.pageSize.getHeight();
        }
        pdf.save('รายงานเช็คชื่อรายบุคคล.pdf');
        document.body.removeChild(tempContainer);
        hideLoading();
    }).catch(err => {
        document.body.removeChild(tempContainer);
        hideLoading();
        handleError(err);
    });
});

document.getElementById('classroom-export-csv').addEventListener('click', () => {
    // สร้าง CSV จาก allClassroomReportRows
    const headerRow = document.querySelector('#classroom-report-table thead tr');
    const headerData = [];
    headerRow.querySelectorAll('th').forEach(th => {
        let text = th.innerText.replace(/"/g, '""');
        if (text.includes(',') || text.includes('"')) text = `"${text}"`;
        headerData.push(text);
    });
    let csv = [headerData.join(',')];
    window.allClassroomReportRows.forEach(rowHtml => {
        const row = document.createElement('tr');
        row.innerHTML = rowHtml;
        const rowData = [];
        row.querySelectorAll('td').forEach(td => {
            let text = td.innerText.replace(/"/g, '""');
            if (text.includes(',') || text.includes('"')) text = `"${text}"`;
            rowData.push(text);
        });
        csv.push(rowData.join(','));
    });
    downloadCSV(csv.join('\n'), 'รายงานห้องเรียน.csv');
});

document.getElementById('classroom-export-xlsx').addEventListener('click', () => {
    // สร้างตารางชั่วคราวที่มีข้อมูลทุกหน้า
    const tempTable = document.createElement('table');
    tempTable.innerHTML = `
        <thead>${document.querySelector('#classroom-report-table thead').innerHTML}</thead>
        <tbody>${window.allClassroomReportRows.join('')}</tbody>
    `;
    const wb = XLSX.utils.table_to_book(tempTable, { sheet: 'รายงานห้องเรียน' });
    XLSX.writeFile(wb, 'รายงานห้องเรียน.xlsx');
});

document.getElementById('classroom-export-pdf').addEventListener('click', () => {
    showLoading();
    // สร้างตารางชั่วคราวที่มีข้อมูลทุกหน้า
    const tempTable = document.createElement('table');
    tempTable.innerHTML = `
        <thead>${document.querySelector('#classroom-report-table thead').innerHTML}</thead>
        <tbody>${window.allClassroomReportRows.join('')}</tbody>
    `;
    tempTable.style.width = '100%';
    tempTable.style.borderCollapse = 'collapse';
    tempTable.querySelectorAll('th, td').forEach(cell => {
        cell.style.border = '1px solid #d1d5db';
        cell.style.padding = '12px';
        cell.style.textAlign = 'left';
    });
    // สร้าง div ชั่วคราวเพื่อเก็บตาราง
    const tempContainer = document.createElement('div');
    tempContainer.appendChild(tempTable);
    document.body.appendChild(tempContainer);
    
    html2canvas(tempContainer, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
        let heightLeft = imgHeight;
        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();
        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdf.internal.pageSize.getHeight();
        }
        pdf.save('รายงานห้องเรียน.pdf');
        document.body.removeChild(tempContainer);
        hideLoading();
    }).catch(err => {
        document.body.removeChild(tempContainer);
        hideLoading();
        handleError(err);
    });
});

document.getElementById('school-export-csv').addEventListener('click', () => exportTableToCSV('school-report-table', 'รายงานภาพรวมโรงเรียน.csv'));
document.getElementById('school-export-xlsx').addEventListener('click', () => { const table = document.getElementById('school-report-table'); const wb = XLSX.utils.table_to_book(table, { sheet: 'รายงานภาพรวมโรงเรียน' }); XLSX.writeFile(wb, 'รายงานภาพรวมโรงเรียน.xlsx'); });
document.getElementById('school-export-pdf').addEventListener('click', () => { showLoading(); html2canvas(document.getElementById('school-report-results'), { scale: 2, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => { const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' }); const imgProps = pdf.getImageProperties(imgData); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight(); const imgHeight = (imgProps.height * pdfWidth) / imgProps.width; let heightLeft = imgHeight; let position = 0; pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight; while (heightLeft > 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight; } pdf.save('รายงานภาพรวมโรงเรียน.pdf'); hideLoading(); }).catch(err => { hideLoading(); handleError(err); }); });

function loadReportFilters() {
    populateAllDropdowns();
    const today = normalizeDate(new Date());
    document.getElementById('report-start-date').value = today;
    document.getElementById('report-end-date').value = today;
    hideLoading();
}

document.getElementById('generate-report').addEventListener('click', function() {
    const startDate = normalizeDate(document.getElementById('report-start-date').value);
    const endDate = normalizeDate(document.getElementById('report-end-date').value);
    if (!startDate || !endDate) { 
        Swal.fire({ 
            icon: 'error', 
            title: 'ข้อมูลไม่ครบถ้วน', 
            text: 'กรุณาเลือกวันที่เริ่มต้นและวันที่สิ้นสุด' 
        }); 
        return; 
    }
    if (new Date(startDate) > new Date(endDate)) {
        Swal.fire({ 
            icon: 'error', 
            title: 'วันที่ไม่ถูกต้อง', 
            text: 'วันที่เริ่มต้นต้องไม่อยู่หลังวันที่สิ้นสุด',
            confirmButtonColor: 'var(--primary-color)' 
        }); 
        return;
    }
    showLoading();
    const classLevel = document.getElementById('report-class').value;
    const classroom = document.getElementById('report-classroom').value.trim();
    const subjectId = document.getElementById('report-subject').value;
    const statusFilter = document.getElementById('report-status').value;
    const { attendance, subjects, students, user } = appState;
    let filteredAtt = (attendance || []).filter(r => { 
        const d = new Date(r.date); 
        return d >= new Date(startDate) && d <= new Date(endDate); 
    });
    let filteredStudents = students.slice();
    if (user.role === 'teacher') {
        let pairs = []; 
        try { pairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) {}
        const validClasses = pairs.flatMap(p => p.classLevels || []);
        const validClassrooms = pairs.flatMap(p => p.classrooms || []);
        const validSubjectIds = pairs.map(p => p.subjectId);
        filteredStudents = filteredStudents.filter(s => validClasses.includes(s.class) && validClassrooms.includes(s.classroom || ''));
        filteredAtt = filteredAtt.filter(a => validClasses.includes(a.class) && validClassrooms.includes(a.classroom || '') && validSubjectIds.includes(String(a.subjectId)));
    }
    if (classLevel && classLevel !== 'all') { 
        filteredStudents = filteredStudents.filter(s => s.class === classLevel); 
        filteredAtt = filteredAtt.filter(a => a.class === classLevel); 
    }
    if (classroom && classroom !== '') { 
        filteredStudents = filteredStudents.filter(s => (s.classroom || '').toString().trim() === classroom); 
        filteredAtt = filteredAtt.filter(a => (a.classroom || '').toString().trim() === classroom); 
    }
    if (subjectId) { 
        filteredAtt = filteredAtt.filter(a => a.subjectId === subjectId); 
    }
    if (statusFilter) { 
        filteredAtt = filteredAtt.filter(a => a.status === statusFilter); 
    }
    let relevantDates = statusFilter ? [...new Set(filteredAtt.map(a => normalizeDate(a.date)))].sort() : [];
    if (!statusFilter) {
        for (let d = new Date(startDate); d <= new Date(endDate); d.setDate(d.getDate() + 1)) { 
            relevantDates.push(normalizeDate(d)); 
        }
    }
    const tableHead = document.getElementById('report-table-head');
    tableHead.innerHTML = `<tr><th>ลำดับ</th><th>รหัสนักเรียน</th><th>ชื่อ-นามสกุล</th><th>ระดับชั้น</th><th>ห้องเรียน</th><th>รายวิชา</th>${relevantDates.map(d => `<th class="date-column">${formatThaiDate(d)}</th>`).join('')}<th class="present-column">มาเรียน</th><th class="absent-column">ขาดเรียน</th><th class="leave-column">ลา</th><th class="late-column">มาสาย</th></tr>`;
    window.allReportRows = []; // รีเซ็ต rows สำหรับการดาวน์โหลด
    let totalPresent = 0, totalAbsent = 0, totalLeave = 0, totalLate = 0;
    let studentSubjectPairs = [];
    filteredStudents.forEach(student => { 
        const subjectsForStudent = new Set(filteredAtt.filter(a => a.studentId === student.id).map(a => a.subjectId)); 
        if (subjectId) { 
            if (subjectsForStudent.has(subjectId)) { 
                studentSubjectPairs.push({ student, subjectId }); 
            } 
        } else { 
            subjectsForStudent.forEach(subId => { 
                studentSubjectPairs.push({ student, subjectId: subId }); 
            }); 
        } 
    });
    if (statusFilter) { 
        const studentsWithStatus = new Set(filteredAtt.map(a => a.studentId)); 
        studentSubjectPairs = studentSubjectPairs.filter(p => studentsWithStatus.has(p.student.id)); 
    }
    if (studentSubjectPairs.length === 0) { 
        allReportRows.push(`<tr><td colspan="${6 + relevantDates.length + 4}" class="text-center">ไม่พบข้อมูลตามเงื่อนไขที่ระบุ</td></tr>`); 
    } else { 
        studentSubjectPairs.forEach((p, idx) => { 
            const s = p.student; 
            const sub = subjects.find(x => x.id === p.subjectId) || {}; 
            let counts = { present: 0, absent: 0, leave: 0, late: 0 }; 
            let rowHtml = `<tr><td>${idx + 1}</td><td>${s.code || '-'}</td><td>${s.name || '-'}</td><td>${s.class || '-'}</td><td>${s.classroom || '-'}</td><td>${sub.name || '-'}</td>`; 
            relevantDates.forEach(d => { 
                const rec = filteredAtt.find(a => a.studentId === s.id && a.subjectId === p.subjectId && a.date === d); 
                const status = rec ? rec.status : 'none'; 
                const textMap = { present: 'มา', absent: 'ขาด', leave: 'ลา', late: 'สาย', none: '-' }; 
                const classMap = { present: 'attendance-present', absent: 'attendance-absent', leave: 'attendance-leave', late: 'attendance-late', none: '' }; 
                rowHtml += `<td><span class="${classMap[status]} px-2 py-1 rounded">${textMap[status]}</span></td>`; 
                if (rec && counts.hasOwnProperty(status)) { 
                    counts[status]++; 
                } 
            }); 
            rowHtml += `<td class="present-column">${counts.present}</td><td class="absent-column">${counts.absent}</td><td class="leave-column">${counts.leave}</td><td class="late-column">${counts.late}</td></tr>`; 
            window.allReportRows.push(rowHtml);
            totalPresent += counts.present; 
            totalAbsent += counts.absent; 
            totalLeave += counts.leave; 
            totalLate += counts.late; 
        }); 
    }
    setupPagination('report-table', allReportRows);
    document.getElementById('report-total-students').textContent = new Set(studentSubjectPairs.map(p => p.student.id)).size;
    document.getElementById('report-present-students').textContent = totalPresent;
    document.getElementById('report-absent-students').textContent = totalAbsent;
    document.getElementById('report-leave-students').textContent = totalLeave;
    document.getElementById('report-late-students').textContent = totalLate;
    document.getElementById('report-results').classList.remove('hidden');
    hideLoading();
});

function loadClassroomReportFilters() {
    populateAllDropdowns();
    document.getElementById('classroom-report-end-date').value = normalizeDate(new Date());
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    document.getElementById('classroom-report-start-date').value = normalizeDate(oneWeekAgo);
}


// *** ฟังก์ชันใหม่สำหรับจัดการหน้ารายงานประจำเดือน ***
function loadMonthlyReportFilters() {
    showLoading();
    // 1. ตั้งค่าปี
    const yearSelect = document.getElementById('monthly-report-year');
    const currentYear = new Date().getFullYear();
    let yearOptions = '';
    for (let i = currentYear + 1; i >= currentYear - 5; i--) {
        yearOptions += `<option value="${i}" ${i === currentYear ? 'selected' : ''}>${i + 543}</option>`;
    }
    yearSelect.innerHTML = yearOptions;

    // 2. ตั้งค่าเดือน
    const monthSelect = document.getElementById('monthly-report-month');
    const currentMonth = new Date().getMonth() + 1;
    const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    let monthOptions = '';
    monthNames.forEach((name, index) => {
        monthOptions += `<option value="${index + 1}" ${index + 1 === currentMonth ? 'selected' : ''}>${name}</option>`;
    });
    monthSelect.innerHTML = monthOptions;

    // 3. ตั้งค่า Dropdown อื่นๆ จาก State
    const subjectSelect = document.getElementById('monthly-report-subject');
    const classSelect = document.getElementById('monthly-report-class');
    const classroomSelect = document.getElementById('monthly-report-classroom');

    subjectSelect.innerHTML = '<option value="">-- กรุณาเลือกวิชา --</option>';
    appState.subjects.forEach(s => { subjectSelect.innerHTML += `<option value="${s.id}">${s.code} - ${s.name}</option>`; });

    classSelect.innerHTML = '<option value="">-- กรุณาเลือกระดับชั้น --</option>';
    // กรองระดับชั้นตามที่ครูสอน
    let teacherLevels = [];
    try {
        const pairs = JSON.parse(appState.user.subjectClassPairs || '[]');
        teacherLevels = [...new Set(pairs.flatMap(p => p.classLevels || []))];
    } catch(e) {}
    teacherLevels.forEach(level => { classSelect.innerHTML += `<option value="${level}">${level}</option>`; });

    classroomSelect.innerHTML = '<option value="">-- กรุณาเลือกห้องเรียน --</option>';
    // เราจะ populate ห้องเรียนหลังจากเลือกระดับชั้น
    $(classSelect).off('change.monthly').on('change.monthly', function() {
        const selectedClass = $(this).val();
        classroomSelect.innerHTML = '<option value="">-- กรุณาเลือกห้องเรียน --</option>';
        if (selectedClass) {
            let teacherClassrooms = [];
            try {
                const pairs = JSON.parse(appState.user.subjectClassPairs || '[]');
                teacherClassrooms = [...new Set(pairs
                    .filter(p => (p.classLevels || []).includes(selectedClass))
                    .flatMap(p => p.classrooms || [])
                )];
            } catch(e) {}
            teacherClassrooms.sort().forEach(cr => { classroomSelect.innerHTML += `<option value="${cr}">${cr}</option>`; });
        }
    });

    hideLoading();
}

document.getElementById('generate-monthly-report').addEventListener('click', function() {
    const params = {
        year: $('#monthly-report-year').val(),
        month: $('#monthly-report-month').val(),
        subjectId: $('#monthly-report-subject').val(),
        classLevel: $('#monthly-report-class').val(),
        classroom: $('#monthly-report-classroom').val(),
        teacherName: appState.user.name
    };

    if (!params.year || !params.month || !params.subjectId || !params.classLevel || !params.classroom) {
        Swal.fire({
            icon: 'warning',
            title: 'ข้อมูลไม่ครบถ้วน',
            text: 'กรุณาเลือกเงื่อนไขให้ครบทุกช่อง (ปี, เดือน, รายวิชา, ระดับชั้น, และห้องเรียน)',
            confirmButtonColor: 'var(--primary-color)'
        });
        return;
    }

    showLoading();
    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success) {
                renderMonthlyReportTable(result);
                $('#monthly-report-results').removeClass('hidden');
            } else {
                handleError({ message: 'ไม่พบข้อมูลตามเงื่อนไขที่เลือก' });
            }
            hideLoading();
        })
        .withFailureHandler(handleError)
        .getMonthlyReportData(params);
});

function renderMonthlyReportTable(data) {
    const { reportData, daysInMonth, workingDays, reportDetails } = data;
    const resultsContainer = document.getElementById('monthly-report-results');
    const head = document.getElementById('monthly-report-table-head');
    const body = document.getElementById('monthly-report-table-body');

    // --- START: ส่วนที่เพิ่มเข้ามา (สร้าง Header) ---
    // ล้าง header เก่า (ถ้ามี) และสร้างใหม่
    let headerDiv = document.getElementById('monthly-report-header');
    if (!headerDiv) {
        headerDiv = document.createElement('div');
        headerDiv.id = 'monthly-report-header';
        // ใส่ headerDiv ไว้เป็น element แรกสุดใน resultsContainer
        resultsContainer.insertBefore(headerDiv, resultsContainer.firstChild);
    }
    
    const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    const monthYearText = `ประจำเดือน ${monthNames[reportDetails.month - 1]} พ.ศ. ${parseInt(reportDetails.year) + 543}`;
    const subjectText = `รายวิชา: ${reportDetails.subjectInfo.code} - ${reportDetails.subjectInfo.name}`;
    const classText = `ระดับชั้น: ${reportDetails.classLevel} ห้อง: ${reportDetails.classroom}`;
    const teacherText = `ครูผู้สอน: ${reportDetails.teacherName}`;

    headerDiv.innerHTML = `
        <h3 class="text-xl font-bold">${monthYearText}</h3>
        <p class="text-md text-gray-700">${subjectText}</p>
        <p class="text-sm text-gray-600">${classText} | ${teacherText}</p>
        <p class="text-sm text-gray-500 mt-1">จำนวนวันทำการทั้งหมด: <strong>${workingDays}</strong> วัน</p>
    `;
    // --- END: ส่วนที่เพิ่มเข้ามา (สร้าง Header) ---


    let headerHtml = '<tr>';
    // ทำให้ Header คอลัมน์ตรึงอยู่กับที่ (Sticky)
    headerHtml += '<th class="sticky top-0 left-0 z-10">ลำดับ</th>';
    headerHtml += '<th class="sticky top-0" style="left: 60px; z-index: 1;">รหัสนักเรียน</th>';
    headerHtml += '<th class="sticky top-0" style="left: 180px; z-index: 1;">ชื่อ-นามสกุล</th>';
    
    for (let i = 1; i <= daysInMonth; i++) {
        headerHtml += `<th>${i}</th>`;
    }
    headerHtml += '<th class="present-column">มา</th><th class="absent-column">ขาด</th><th class="leave-column">ลา</th><th class="late-column">สาย</th></tr>';
    head.innerHTML = headerHtml;

    let bodyHtml = '';
    let totalSummary = { present: 0, absent: 0, leave: 0, late: 0 };
    
    if (reportData.length === 0) {
        bodyHtml = `<tr><td colspan="${daysInMonth + 7}" class="text-center">ไม่พบข้อมูลนักเรียน</td></tr>`;
    } else {
        reportData.forEach((student, index) => {
            bodyHtml += `<tr>`;
            // ทำให้คอลัมน์ข้อมูลตรึงอยู่กับที่ (Sticky)
            bodyHtml += `<td class="sticky left-0 bg-white">${index + 1}</td>`;
            bodyHtml += `<td class="sticky bg-white" style="left: 60px;">${student.studentCode}</td>`;
            bodyHtml += `<td class="sticky bg-white text-left" style="left: 180px;">${student.studentName}</td>`;

            for (let i = 1; i <= daysInMonth; i++) {
                const status = student.attendance[i];
                const statusText = { present: 'ม', absent: 'ข', leave: 'ล', late: 'ส', none: '-' }[status] || '-';
                const statusClass = { present: 'text-green-600 font-bold', absent: 'text-red-600 font-bold', leave: 'text-yellow-600 font-bold', late: 'text-pink-600 font-bold', none: 'text-gray-400' }[status] || '';
                bodyHtml += `<td class="${statusClass}">${statusText}</td>`;
            }
            bodyHtml += `<td class="present-column font-bold">${student.summary.present}</td>`;
            bodyHtml += `<td class="absent-column font-bold">${student.summary.absent}</td>`;
            bodyHtml += `<td class="leave-column font-bold">${student.summary.leave}</td>`;
            bodyHtml += `<td class="late-column font-bold">${student.summary.late}</td></tr>`;

            // รวมยอดสรุปทั้งหมด
            totalSummary.present += student.summary.present;
            totalSummary.absent += student.summary.absent;
            totalSummary.leave += student.summary.leave;
            totalSummary.late += student.summary.late;
        });
    }
    
    // --- START: ส่วนที่เพิ่มเข้ามา (สร้าง Footer สรุปเปอร์เซ็นต์) ---
    let footerHtml = '<tfoot class="bg-gray-100 font-bold">';
    // แถวรวมจำนวน
    footerHtml += '<tr>';
    footerHtml += `<td colspan="3" class="text-right pr-4 sticky left-0 bg-gray-100">รวมทั้งหมด</td>`;
    footerHtml += `<td colspan="${daysInMonth}"></td>`; // คอลัมน์ว่างสำหรับวัน
    footerHtml += `<td class="present-column">${totalSummary.present}</td>`;
    footerHtml += `<td class="absent-column">${totalSummary.absent}</td>`;
    footerHtml += `<td class="leave-column">${totalSummary.leave}</td>`;
    footerHtml += `<td class="late-column">${totalSummary.late}</td>`;
    footerHtml += '</tr>';

    // แถวเปอร์เซ็นต์
    footerHtml += '<tr>';
    footerHtml += `<td colspan="3" class="text-right pr-4 sticky left-0 bg-gray-100">ร้อยละ (%)</td>`;
    footerHtml += `<td colspan="${daysInMonth}"></td>`; // คอลัมน์ว่าง
    
    // คำนวณเปอร์เซ็นต์โดยใช้ workingDays ที่ได้มาจาก server
    const totalStudents = reportData.length;
    const totalPossibleDays = totalStudents * workingDays;

    const percentPresent = totalPossibleDays > 0 ? ((totalSummary.present / totalPossibleDays) * 100).toFixed(2) : "0.00";
    const percentAbsent = totalPossibleDays > 0 ? ((totalSummary.absent / totalPossibleDays) * 100).toFixed(2) : "0.00";
    const percentLeave = totalPossibleDays > 0 ? ((totalSummary.leave / totalPossibleDays) * 100).toFixed(2) : "0.00";
    const percentLate = totalPossibleDays > 0 ? ((totalSummary.late / totalPossibleDays) * 100).toFixed(2) : "0.00";

    footerHtml += `<td class="present-column">${percentPresent}%</td>`;
    footerHtml += `<td class="absent-column">${percentAbsent}%</td>`;
    footerHtml += `<td class="leave-column">${percentLeave}%</td>`;
    footerHtml += `<td class="late-column">${percentLate}%</td>`;
    footerHtml += '</tr>';
    
    footerHtml += '</tfoot>';
    
    // ใส่ body และ footer ลงในตาราง
    body.innerHTML = bodyHtml + footerHtml;
    // --- END: ส่วนที่เพิ่มเข้ามา ---
}

document.getElementById('export-monthly-pdf').addEventListener('click', function() {
    const params = {
        year: $('#monthly-report-year').val(),
        month: $('#monthly-report-month').val(),
        subjectId: $('#monthly-report-subject').val(),
        classLevel: $('#monthly-report-class').val(),
        classroom: $('#monthly-report-classroom').val(),
        teacherName: appState.user.name
    };

    if (!params.year || !params.month || !params.subjectId || !params.classLevel || !params.classroom) {
        Swal.fire({ icon: 'warning', title: 'ข้อมูลไม่ครบถ้วน', text: 'กรุณาเลือกเงื่อนไขให้ครบทุกช่อง' });
        return;
    }

    showLoading();
    Swal.fire({
        title: 'กำลังสร้างรายงาน PDF',
        text: 'กรุณารอสักครู่ ระบบกำลังประมวลผล...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    google.script.run
        .withSuccessHandler(function(result) {
            if (result.success && result.url) {
                Swal.fire({
                    icon: 'success',
                    title: 'สร้างรายงานสำเร็จ!',
                    html: `<p>คุณสามารถดาวน์โหลดไฟล์ PDF ได้จากลิงก์ด้านล่าง</p><a href="${result.url}" target="_blank" class="text-blue-500 underline">ดาวน์โหลดรายงาน PDF</a>`,
                    confirmButtonText: 'ปิด',
                    confirmButtonColor: 'var(--primary-color)'
                });
            } else {
                handleError({ message: 'สร้าง PDF ล้มเหลว' });
            }
            hideLoading();
        })
        .withFailureHandler(function(error) {
            Swal.close();
            handleError(error);
        })
        .createMonthlyReportPdfFromSheet(params);
});

document.getElementById('generate-classroom-report').addEventListener('click', function() {
    const startDateStr = normalizeDate(document.getElementById('classroom-report-start-date').value);
    const endDateStr = normalizeDate(document.getElementById('classroom-report-end-date').value);
    if (!startDateStr || !endDateStr) { 
        Swal.fire({ 
            icon: 'error', 
            title: 'ข้อมูลไม่ครบถ้วน', 
            text: 'กรุณาเลือกวันที่' 
        }); 
        return; 
    }
    if (new Date(startDateStr) > new Date(endDateStr)) {
        Swal.fire({ 
            icon: 'error', 
            title: 'วันที่ไม่ถูกต้อง', 
            text: 'วันที่เริ่มต้นต้องไม่อยู่หลังวันที่สิ้นสุด',
            confirmButtonColor: 'var(--primary-color)' 
        }); 
        return;
    }
    showLoading();
    const classLevel = document.getElementById('classroom-report-class').value;
    const classroom = document.getElementById('classroom-report-classroom').value;
    const subjectId = document.getElementById('classroom-report-subject').value;
    let { attendance, subjects, user } = appState;
    if (user.role === 'teacher') {
        let pairs = []; 
        try { pairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) {}
        const validClasses = pairs.flatMap(p => p.classLevels || []);
        const validClassrooms = pairs.flatMap(p => p.classrooms || []);
        const validSubjectIds = pairs.map(p => p.subjectId);
        attendance = attendance.filter(a => validClasses.includes(a.class) && validClassrooms.includes(a.classroom || '') && validSubjectIds.includes(String(a.subjectId)));
    }
    const reportMap = {};
    attendance.forEach(a => {
        const attDate = new Date(a.date);
        if (attDate < new Date(startDateStr) || attDate > new Date(endDateStr)) return;
        if (classLevel !== 'all' && a.class !== classLevel) return;
        if (classroom && a.classroom !== classroom) return;
        if (subjectId && a.subjectId !== subjectId) return;
        const key = a.date + '_' + a.class + '_' + a.classroom + '_' + a.subjectId;
        if (!reportMap[key]) {
            const subjObj = subjects.find(s => s.id === a.subjectId) || {};
            reportMap[key] = { 
                date: a.date, 
                class: a.class, 
                classroom: a.classroom, 
                subjectId: a.subjectId, 
                subjectCode: subjObj.code, 
                subjectName: subjObj.name, 
                present: 0, 
                absent: 0, 
                leave: 0, 
                late: 0, 
                studentSet: new Set() 
            };
        }
        const entry = reportMap[key];
        entry.studentSet.add(a.studentId);
        if (['present', 'absent', 'leave', 'late'].includes(a.status)) entry[a.status]++;
    });
    const reportData = Object.values(reportMap).map(item => { 
        item.totalStudents = item.studentSet.size; 
        delete item.studentSet; 
        return item; 
    }).sort((a,b) => new Date(b.date) - new Date(a.date));
    window.allClassroomReportRows = []; // รีเซ็ต rows สำหรับการดาวน์โหลด
    let summaryPresent = 0, summaryAbsent = 0, summaryLeave = 0, summaryLate = 0;
    if (reportData.length === 0) { 
        allClassroomReportRows.push('<tr><td colspan="11" class="text-center">ไม่มีข้อมูลห้องเรียนในช่วงเวลานี้</td></tr>'); 
    } else {
        reportData.forEach((item, index) => {
            const rowHtml = `<tr><td>${index + 1}</td><td>${formatThaiDate(item.date)}</td><td>${item.class || '-'}</td><td>${item.classroom || '-'}</td><td>${item.subjectCode || '-'}</td><td>${item.subjectName || '-'}</td><td>${item.totalStudents}</td><td class="present-column">${item.present}</td><td class="absent-column">${item.absent}</td><td class="leave-column">${item.leave}</td><td class="late-column">${item.late}</td></tr>`;
            window.allClassroomReportRows.push(rowHtml);
            summaryPresent += item.present; 
            summaryAbsent += item.absent; 
            summaryLeave += item.leave; 
            summaryLate += item.late;
        });
    }
    setupPagination('classroom-report-table', allClassroomReportRows);
    document.getElementById('summary-present').textContent = summaryPresent;
    document.getElementById('summary-absent').textContent = summaryAbsent;
    document.getElementById('summary-leave').textContent = summaryLeave;
    document.getElementById('summary-late').textContent = summaryLate;
    document.getElementById('classroom-report-results').classList.remove('hidden');
    hideLoading();
});

function loadSchoolReportFilters() {
    populateAllDropdowns();
    document.getElementById('school-report-end-date').value = normalizeDate(new Date());
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
    document.getElementById('school-report-start-date').value = normalizeDate(oneWeekAgo);
}

document.getElementById('generate-school-report').addEventListener('click', function() {
    const startDateStr = normalizeDate(document.getElementById('school-report-start-date').value);
    const endDateStr = normalizeDate(document.getElementById('school-report-end-date').value);
    if (!startDateStr || !endDateStr) { 
        Swal.fire({ 
            icon: 'error', 
            title: 'ข้อมูลไม่ครบถ้วน', 
            text: 'กรุณาเลือกวันที่' 
        }); 
        return; 
    }
    if (new Date(startDateStr) > new Date(endDateStr)) {
        Swal.fire({ 
            icon: 'error', 
            title: 'วันที่ไม่ถูกต้อง', 
            text: 'วันที่เริ่มต้นต้องไม่อยู่หลังวันที่สิ้นสุด',
            confirmButtonColor: 'var(--primary-color)' 
        }); 
        return;
    }
    showLoading();
    const classLevel = document.getElementById('school-report-class').value;
    const classroom = document.getElementById('school-report-classroom').value;
    const subjectId = document.getElementById('school-report-subject').value;
    const { attendance, subjects } = appState;
    const filteredAttendance = attendance.filter(a => { 
        const attDate = new Date(a.date); 
        return attDate >= new Date(startDateStr) && attDate <= new Date(endDateStr) && 
               (classLevel === 'all' || a.class === classLevel) && 
               (!classroom || a.classroom === classroom) && 
               (!subjectId || a.subjectId === subjectId); 
    });
    const reportMap = {};
    filteredAttendance.forEach(a => {
        if (!['present', 'absent', 'leave', 'late'].includes(a.status)) return;
        const key = a.date + '_' + a.class + '_' + (a.classroom || '') + '_' + a.subjectId;
        if (!reportMap[key]) { 
            const subject = subjects.find(s => s.id === a.subjectId) || { code: 'N/A', name: 'N/A' }; 
            reportMap[key] = { 
                date: a.date, 
                subjectCode: subject.code, 
                subjectName: subject.name, 
                classLevel: a.class, 
                classroom: a.classroom || '', 
                studentIds: new Set(), 
                present: 0, 
                absent: 0, 
                leave: 0, 
                late: 0, 
            }; 
        }
        reportMap[key].studentIds.add(a.studentId);
        if (reportMap[key].hasOwnProperty(a.status)) { 
            reportMap[key][a.status]++; 
        }
    });
    const reportData = Object.values(reportMap).map(item => { 
        item.totalStudents = item.studentIds.size; 
        delete item.studentIds; 
        return item; 
    }).sort((a,b) => new Date(b.date) - new Date(a.date));
    let rows = []; 
    let totalStudents = 0, totalPresent = 0, totalAbsent = 0, totalLeave = 0, totalLate = 0;
    if (reportData.length === 0) { 
        rows.push('<tr><td colspan="11" class="text-center">ไม่มีข้อมูลในช่วงเวลานี้</td></tr>'); 
    } else {
        reportData.forEach((item, index) => {
            rows.push(`<tr><td>${index + 1}</td><td>${formatThaiDate(item.date)}</td><td>${item.subjectCode || '-'}</td><td>${item.subjectName || '-'}</td><td>${item.classLevel}</td><td>${item.classroom || '-'}</td><td>${item.totalStudents}</td><td class="present-column">${item.present}</td><td class="absent-column">${item.absent}</td><td class="leave-column">${item.leave}</td><td class="late-column">${item.late}</td></tr>`);
            totalStudents += item.totalStudents; 
            totalPresent += item.present; 
            totalAbsent += item.absent; 
            totalLeave += item.leave; 
            totalLate += item.late;
        });
    }
    setupPagination('school-report-table', rows, 50);
    const tfootEl = document.querySelector('#school-report-table tfoot');
    if (tfootEl) {
        const totalCheckedIn = totalPresent + totalLeave + totalLate + totalAbsent;
        const percentPresent = totalCheckedIn > 0 ? ((totalPresent / totalCheckedIn) * 100).toFixed(2) : '0.00';
        const percentAbsent = totalCheckedIn > 0 ? ((totalAbsent / totalCheckedIn) * 100).toFixed(2) : '0.00';
        const percentLeave = totalCheckedIn > 0 ? ((totalLeave / totalCheckedIn) * 100).toFixed(2) : '0.00';
        const percentLate = totalCheckedIn > 0 ? ((totalLate / totalCheckedIn) * 100).toFixed(2) : '0.00';
        tfootEl.innerHTML = `<tr><td colspan="6" class="text-right font-bold">รวมทั้งหมด</td><td class="font-bold">${totalStudents}</td><td class="present-column font-bold">${totalPresent}</td><td class="absent-column font-bold">${totalAbsent}</td><td class="leave-column font-bold">${totalLeave}</td><td class="late-column font-bold">${totalLate}</td></tr><tr><td colspan="7" class="text-right font-bold">ร้อยละ</td><td class="present-column font-bold">${percentPresent}%</td><td class="absent-column font-bold">${percentAbsent}%</td><td class="leave-column font-bold">${percentLeave}%</td><td class="late-column font-bold">${percentLate}%</td></tr>`;
    }
    document.getElementById('school-report-results').classList.remove('hidden');
    hideLoading();
});

document.getElementById('download-subjects-template').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    // เพิ่ม 'credits' เข้าไปในอาร์เรย์ของส่วนหัว
    downloadCSVTemplate('subjects', ['code', 'name', 'credits'], 'template_subjects.csv');
});

document.getElementById('download-students-template').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    downloadCSVTemplate('students', ['code', 'name', 'class', 'classroom'], 'template_students.csv');
});

function downloadCSVTemplate(sheetName, headers, filename) {
    const csv = headers.join(',') + '\n';
    const BOM = '\uFEFF';
    const csvFile = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(csvFile);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.getElementById('import-subjects-btn').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    document.getElementById('import-subjects-form').reset();
    openModal('import-subjects-modal');
});

document.getElementById('import-students-btn').addEventListener('click', function() {
    if (appState.user.role !== 'admin') return;
    document.getElementById('import-students-form').reset();
    openModal('import-students-modal');
});

function loadSubjects() {
    const { subjects } = appState;
    let rows = [];
    if (!subjects || subjects.length === 0) {
        // แก้ไข colspan จาก 4 เป็น 5
        rows.push('<tr><td colspan="5" class="text-center">ไม่มีข้อมูล</td></tr>');
    } else {
        subjects.forEach((subject, index) => {
            // เพิ่ม <td> สำหรับแสดง subject.credits
            rows.push(`<tr><td>${index + 1}</td><td>${subject.code}</td><td>${subject.name}</td><td>${subject.credits || '-'}</td><td><button class="edit-subject bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-2" data-id="${subject.id}">แก้ไข</button><button class="delete-subject bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${subject.id}">ลบ</button></td></tr>`);
        });
    }
    setupPagination('subjects-table', rows);
    // อัปเดต dropdown เฉพาะเมื่ออยู่ในแท็บ subjects
    if ($('.nav-tab.active').data('tab') === 'subjects') {
        populateSubjectDropdowns(appState.subjects);
    }
    hideLoading();
}

function initializeSubjectClassTable(pairs = [], enabledLevels = []) {
    const tableBody = document.querySelector('#subject-class-table tbody');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    const { subjects, students } = appState;
    const classrooms = [...new Set(students.map(s => s.classroom).filter(Boolean))];
    function addRow(subjectId = '', classLevels = [], selectedClassrooms = []) {
        const row = document.createElement('tr');
        const classLevelOptions = enabledLevels.map(c => `<option value="${c}" ${classLevels.includes(c) ? 'selected' : ''}>${c}</option>`).join('');
        row.innerHTML = `<td><select class="subject-select w-full px-3 py-2 border rounded-lg" required><option value="">เลือกวิชา</option>${subjects.map(s => `<option value="${s.id}" ${s.id === subjectId ? 'selected' : ''}>${s.code}-${s.name}</option>`).join('')}</select></td><td><select class="class-select w-full px-3 py-2 border rounded-lg select2" multiple required>${classLevelOptions}</select></td><td><select class="classroom-select w-full px-3 py-2 border rounded-lg select2" multiple required>${classrooms.map(c => `<option value="${c}" ${selectedClassrooms.includes(c) ? 'selected' : ''}>${c}</option>`).join('')}</select></td><td><button type="button" class="remove-row bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">ลบ</button></td>`;
        tableBody.appendChild(row);
        $(row.querySelector('.class-select')).select2({ width: '100%', placeholder: 'เลือกระดับชั้น' });
        $(row.querySelector('.classroom-select')).select2({ width: '100%', placeholder: 'เลือกห้องเรียน' });
        row.querySelector('.remove-row').addEventListener('click', () => { row.remove(); if (tableBody.children.length === 0) addRow(); });
    }
    if (pairs.length > 0) { pairs.forEach(p => addRow(p.subjectId, p.classLevels, p.classrooms || [])); } else { addRow(); }
    const addButton = document.getElementById('add-subject-class-row');
    if (addButton) { const newButton = addButton.cloneNode(true); addButton.parentNode.replaceChild(newButton, addButton); newButton.addEventListener('click', () => addRow()); }
}

function loadTeachers() {
    const { teachers, subjects } = appState;
    let rows = [];
    if (!teachers || teachers.length === 0) {
        rows.push('<tr><td colspan="8" class="text-center">ไม่มีข้อมูล</td></tr>');
    } else {
        teachers.forEach((teacher, index) => {
            let pairs = []; 
            try { pairs = JSON.parse(teacher.subjectClassPairs || '[]'); } catch (e) {}
            const subjectDisplayParts = []; 
            const classLevelClassroomMap = new Map();
            const classroomsSet = new Set();
            pairs.forEach(p => { 
                const subj = subjects.find(s => String(s.id) === String(p.subjectId)); 
                if (subj) { subjectDisplayParts.push(subj.name); } 
                if (Array.isArray(p.classLevels) && Array.isArray(p.classrooms)) {
                    p.classLevels.forEach(cl => {
                        if (!classLevelClassroomMap.has(cl)) {
                            classLevelClassroomMap.set(cl, new Set());
                        }
                        p.classrooms.forEach(cr => {
                            classLevelClassroomMap.get(cl).add(cr);
                            classroomsSet.add(cr);
                        });
                    });
                }
            });
            const subjectDisplay = subjectDisplayParts.length > 0 ? [...new Set(subjectDisplayParts)].join(', ') : '-';
            const classDisplay = Array.from(classLevelClassroomMap.entries())
                .map(([level, classrooms]) => {
                    const classroomList = Array.from(classrooms).sort().join(', ');
                    return classroomList ? `${level} (${classroomList})` : level;
                })
                .join(', ') || '-';
            const classroomDisplay = classroomsSet.size > 0 ? Array.from(classroomsSet).sort().join(', ') : '-';
            const resetRequested = teacher.resetRequested ? 'รอรีเซ็ต' : 'ปกติ';
            rows.push(`<tr><td>${index + 1}</td><td>${teacher.name || '-'}</td><td>${teacher.username || '-'}</td><td>${subjectDisplay}</td><td>${classDisplay}</td><td>${classroomDisplay}</td><td>${resetRequested}</td><td><button class="edit-teacher bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-2" data-id="${teacher.id}">แก้ไข</button><button class="delete-teacher bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded mr-2" data-id="${teacher.id}">ลบ</button><button class="reset-password bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" data-id="${teacher.id}">รีเซ็ตรหัสผ่าน</button></td></tr>`);
        });
    }
    setupPagination('teachers-table', rows);
    hideLoading();
}

function loadSettings() {
    if (!appState.user || appState.user.role !== 'admin') return;
    const { settings } = appState;
    document.getElementById('system-name').value = settings.system_name || '';
    document.getElementById('logo-url').value = settings.logo_url || '';
    document.getElementById('header-text').value = settings.header_text || '';
    document.getElementById('footer-text').value = settings.footer_text || '';
    // --- START: เพิ่มส่วนนี้ ---
    document.getElementById('school-name').value = settings.school_name || ''; // ดึงข้อมูลชื่อโรงเรียน
    // --- END: เพิ่มส่วนนี้ ---
    document.getElementById('school-area').value = settings.school_area || '';
    document.getElementById('director-name').value = settings.director_name || '';
    const themeColor = settings.theme_color || '#FF69B4';
    document.getElementById('theme-color').value = themeColor;
    applyTheme(themeColor);
    document.querySelectorAll('.theme-button').forEach(button => {
        button.classList.toggle('active', button.dataset.color === themeColor);
    });
    hideLoading();
}

function initializeTabs() {
    $('#nav-tabs').off('click.tab-switcher').on('click.tab-switcher', '.nav-tab', function() {
        if (isLoading || $(this).hasClass('active')) return;
        const tabId = $(this).data('tab');
        $('.nav-tab').removeClass('active');
        $(this).addClass('active');
        $('.tab-content').removeClass('active');
        $('#' + tabId).addClass('active');
        loadContentForTab(tabId, true); // บังคับ refresh สำหรับทุกแท็บ
    });
}

function showTeacherChoiceModal() {
    openModal('teacher-choice-modal');
}

function initializeScoringPage() {
    const user = appState.user;
    if (!user || user.role !== 'teacher') return;

    const container = $('#scoring-container');
    const subjectSelect = container.find('#scoring-subject');
    const classSelect = container.find('#scoring-class');
    const classroomSelect = container.find('#scoring-classroom');
    const startScoringBtn = container.find('#start-scoring-btn');
    const contentArea = container.find('#scoring-content-area');
    const placeholder = container.find('#scoring-placeholder');
    const componentsList = container.find('#score-components-list');
    const tableHead = container.find('#scoring-table-head');
    const tableBody = container.find('#scoring-table-body');

    let currentFilters = {};
    let currentComponents = [];
    let currentStudents = [];

    function checkFiltersAndToggleButton() {
        if (subjectSelect.val() && classSelect.val() && classroomSelect.val()) {
            startScoringBtn.removeClass('hidden');
        } else {
            startScoringBtn.addClass('hidden');
        }
        contentArea.addClass('hidden');
        placeholder.removeClass('hidden');
    }

    function populateFilters() {
        const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
        const teacherSubjectIds = [...new Set(teacherPairs.map(p => p.subjectId))];
        const teacherSubjects = appState.subjects.filter(s => teacherSubjectIds.includes(s.id));
        subjectSelect.html('<option value="">-- เลือกวิชา --</option>');
        teacherSubjects.forEach(s => subjectSelect.append(`<option value="${s.id}">${s.code} - ${s.name}</option>`));

        const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
        classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
        teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));

        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);

        classSelect.on('change', function() {
            const selectedLevel = $(this).val();
            const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
            classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
            if (selectedLevel) {
                relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
                classroomSelect.prop('disabled', false);
            } else {
                classroomSelect.prop('disabled', true);
            }
            checkFiltersAndToggleButton();
        });

        subjectSelect.add(classroomSelect).on('change', checkFiltersAndToggleButton);
    }

    function renderComponents() {
        componentsList.empty();
        currentComponents = appState.scoreComponents.filter(c => c.subjectId === currentFilters.subjectId && c.classLevel === currentFilters.classLevel && c.classroom === currentFilters.classroom);
        if (currentComponents.length === 0) {
            componentsList.html('<p class="text-gray-400 text-center">ยังไม่มีองค์ประกอบคะแนนสำหรับวิชานี้</p>');
        } else {
            currentComponents.forEach(c => {
                const componentHtml = `<div class="flex items-center justify-between p-2 border rounded-md bg-gray-50">
                                        <div><span class="font-semibold">${c.componentName}</span> <span class="text-sm text-gray-500 ml-2">(เต็ม ${c.maxScore})</span></div>
                                        <div>
                                            <button class="edit-component bg-yellow-500 text-white px-2 py-1 rounded-md text-xs mr-1" data-id="${c.id}">แก้ไข</button>
                                            <button class="delete-component bg-red-500 text-white px-2 py-1 rounded-md text-xs" data-id="${c.id}">ลบ</button>
                                        </div></div>`;
                componentsList.append(componentHtml);
            });
        }
        renderScoringTable();
    }

function renderScoringTable() {
    tableHead.empty();
    tableBody.empty();
    currentStudents = appState.students.filter(s => s.class === currentFilters.classLevel && s.classroom === currentFilters.classroom).sort((a, b) => (a.code || '').localeCompare(b.code));

    if (currentComponents.length === 0 || currentStudents.length === 0) {
        $('#scoring-table-container').addClass('hidden');
        return;
    }
    $('#scoring-table-container').removeClass('hidden');

    let headerHtml = '<tr><th class="p-2 border">ลำดับ</th><th class="p-2 border">รหัสนักเรียน</th><th class="p-2 border text-left">ชื่อ-นามสกุล</th>';
    currentComponents.forEach(c => headerHtml += `<th class="p-2 border text-center">${c.componentName}<br><small>(เต็ม ${c.maxScore})</small></th>`);
    headerHtml += '<th class="p-2 border">คะแนนรวม</th><th class="p-2 border">เกรด</th><th class="p-2 border">หมายเหตุ</th></tr>';
    tableHead.html(headerHtml);

    currentStudents.forEach((student, index) => {
        let rowHtml = `<tr data-student-id="${student.id}"><td class="p-2 border text-center">${index + 1}</td><td class="p-2 border">${student.code}</td><td class="p-2 border text-left">${student.name}</td>`;
        let totalScore = 0;
        let totalMaxScore = 0;
        currentComponents.forEach(c => {
            const scoreRecord = appState.scores.find(s => s.studentId === student.id && s.componentId === c.id);
            const currentScore = scoreRecord ? scoreRecord.score : '';
            totalScore += parseFloat(currentScore) || 0;
            totalMaxScore += parseFloat(c.maxScore) || 0;
            rowHtml += `<td class="p-1 border text-center"><input type="number" class="score-input w-20 text-center border rounded" data-component-id="${c.id}" data-max-score="${c.maxScore}" value="${currentScore}" placeholder="-"></td>`;
        });

        // --- START: ส่วนที่แก้ไข ---
        // เพิ่มการกรองด้วย subjectId เพื่อแก้ปัญหาข้อมูลปนกัน
        const remarkRecord = appState.scores.find(s => s.studentId === student.id && s.componentId === 'remark' && s.subjectId === currentFilters.subjectId);
        // --- END: ส่วนที่แก้ไข ---
        const currentRemark = remarkRecord ? remarkRecord.remark : '-';
        const grade = calculateGrade(totalScore, totalMaxScore, currentRemark);

        rowHtml += `<td class="p-2 border text-center font-bold total-score">${totalScore.toFixed(2)}</td>
                    <td class="p-2 border text-center font-bold grade">${grade}</td>
                    
                    <td class="p-1 border text-center">
                        <select class="remark-select w-full border rounded text-sm p-1" data-student-id="${student.id}">
                            <option value="-" ${currentRemark === '-' ? 'selected' : ''}>-</option>
                            <option value="ร" ${currentRemark === 'ร' ? 'selected' : ''}>ร</option>
                            <option value="มผ" ${currentRemark === 'มผ' ? 'selected' : ''}>มผ</option>
                            <option value="มส" ${currentRemark === 'มส' ? 'selected' : ''}>มส</option>
                        </select>
                    </td></tr>`;
        tableBody.append(rowHtml);
    });

    tableBody.find('.remark-select').each(function() {
        handleRemarkChange($(this));
    });
}

    container.off('click').off('input').off('change');

    container.on('click', '#start-scoring-btn', function() {
        currentFilters = {
            subjectId: subjectSelect.val(),
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            teacherId: user.id
        };

        const studentsInClass = appState.students.filter(s => s.class === currentFilters.classLevel && s.classroom === currentFilters.classroom);
        if (studentsInClass.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'ไม่พบข้อมูลนักเรียน',
                text: 'ไม่พบรายชื่อนักเรียนในห้องเรียนที่เลือก กรุณาตรวจสอบข้อมูล',
                confirmButtonColor: 'var(--primary-color)'
            });
            contentArea.addClass('hidden');
            placeholder.removeClass('hidden');
            return;
        }

        placeholder.addClass('hidden');
        contentArea.removeClass('hidden');
        renderComponents();
    });

    container.on('change', '.remark-select', function() {
        handleRemarkChange($(this));
    });

    container.on('click', '#add-score-component-btn', function() {
        $('#score-component-form')[0].reset();
        $('#score-component-id').val('');
        $('#score-component-modal-title').text('เพิ่มองค์ประกอบคะแนน');
        openModal('score-component-modal');
    });

    container.on('click', '.edit-component', function() {
        const componentId = $(this).data('id');
        const component = appState.scoreComponents.find(c => c.id === componentId);
        if (component) {
            $('#score-component-id').val(component.id);
            $('#score-component-name').val(component.componentName);
            $('#score-component-max').val(component.maxScore);
            $('#score-component-modal-title').text('แก้ไของค์ประกอบคะแนน');
            openModal('score-component-modal');
        }
    });

    container.on('click', '.delete-component', function() {
        const componentId = $(this).data('id');
        Swal.fire({
            title: 'ยืนยันการลบ?',
            text: "องค์ประกอบคะแนนและคะแนนทั้งหมดที่เกี่ยวข้องจะถูกลบอย่างถาวร!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ใช่, ลบเลย!'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                google.script.run.withSuccessHandler(function() {
                    appState.scoreComponents = appState.scoreComponents.filter(c => c.id !== componentId);
                    appState.scores = appState.scores.filter(s => s.componentId !== componentId);
                    renderComponents();
                    hideLoading();
                    Swal.fire('ลบแล้ว!', 'ลบองค์ประกอบคะแนนเรียบร้อย', 'success');
                }).withFailureHandler(handleError).deleteScoreComponent(componentId);
            }
        });
    });

    container.on('input', '.score-input', function() {
        const input = $(this);
        const maxScore = parseFloat(input.data('max-score'));
        if (parseFloat(input.val()) > maxScore) {
            input.val(maxScore);
        }
        if (parseFloat(input.val()) < 0) {
            input.val(0);
        }
        const row = input.closest('tr');
        let totalScore = 0,
            totalMaxScore = 0;
        row.find('.score-input').each(function() {
            totalScore += parseFloat($(this).val()) || 0;
            totalMaxScore += parseFloat($(this).data('max-score')) || 0;
        });
        row.find('.total-score').text(totalScore.toFixed(2));
        row.find('.grade').text(calculateGrade(totalScore, totalMaxScore, '-'));
    });

    container.on('click', '#save-scores-btn', function() {
    const scoresToSave = [];
    $('#scoring-table-body tr').each(function() {
        const row = $(this);
        const studentId = row.data('student-id');
        const remarkValue = row.find('.remark-select').val();
        
        // --- START: ส่วนที่แก้ไข ---
        // เพิ่ม subjectId เข้าไปใน object ของ remark ที่จะบันทึก
        scoresToSave.push({
            studentId: studentId,
            componentId: 'remark',
            score: '',
            remark: remarkValue,
            subjectId: currentFilters.subjectId // เพิ่มบรรทัดนี้
        });
        // --- END: ส่วนที่แก้ไข ---
        
        if (remarkValue === '-') {
            row.find('.score-input').each(function() {
                const input = $(this);
                // --- START: ส่วนที่แก้ไข ---
                // เพิ่ม subjectId เข้าไปใน object ของคะแนนปกติด้วย
                scoresToSave.push({
                    studentId: studentId,
                    componentId: input.data('component-id'),
                    score: input.val(),
                    remark: '-',
                    subjectId: currentFilters.subjectId // เพิ่มบรรทัดนี้
                });
                // --- END: ส่วนที่แก้ไข ---
            });
        }
    });

    if (scoresToSave.length === 0) {
        Swal.fire('ไม่มีข้อมูล', 'ไม่มีคะแนนที่เปลี่ยนแปลงเพื่อบันทึก', 'info');
        return;
    }
    showLoading();
    google.script.run.withSuccessHandler(function(result) {
        if (result.success && result.savedRecords) {
            result.savedRecords.forEach(savedRec => {
                // --- START: ส่วนที่แก้ไข ---
                // ปรับปรุงการค้นหา index ใน appState โดยเพิ่มเงื่อนไข subjectId
                const index = appState.scores.findIndex(s => s.studentId === savedRec.studentId && s.componentId === savedRec.componentId && s.subjectId === savedRec.subjectId);
                // --- END: ส่วนที่แก้ไข ---
                if (index !== -1) {
                    appState.scores[index] = savedRec;
                } else {
                    appState.scores.push(savedRec);
                }
            });
        }
        renderScoringTable();
        hideLoading();
        Swal.fire('สำเร็จ!', `บันทึกข้อมูล ${result.count} รายการเรียบร้อย`, 'success');
    }).withFailureHandler(handleError).saveScores(scoresToSave);
});

    $('#score-component-form').off('submit').on('submit', function(e) {
        e.preventDefault();
        const componentData = {
            id: $('#score-component-id').val(),
            teacherId: user.id,
            subjectId: currentFilters.subjectId,
            classLevel: currentFilters.classLevel,
            classroom: currentFilters.classroom,
            componentName: $('#score-component-name').val().trim(),
            maxScore: parseFloat($('#score-component-max').val())
        };
        
        const newComponentMaxScore = componentData.maxScore;
        if (isNaN(newComponentMaxScore) || newComponentMaxScore < 0) {
            Swal.fire('ข้อมูลไม่ถูกต้อง', 'กรุณากรอกคะแนนเต็มเป็นตัวเลขบวกเท่านั้น', 'error');
            return;
        }

        let currentTotalScore = 0;
        appState.scoreComponents
            .filter(c => 
                c.subjectId === currentFilters.subjectId &&
                c.classLevel === currentFilters.classLevel &&
                c.classroom === currentFilters.classroom &&
                c.id !== componentData.id
            )
            .forEach(c => {
                currentTotalScore += parseFloat(c.maxScore) || 0;
            });

        const potentialTotalScore = currentTotalScore + newComponentMaxScore;

        if (potentialTotalScore > 100) {
            Swal.fire({
                icon: 'error',
                title: 'คะแนนรวมเกิน 100',
                html: `คะแนนรวมของทุกองค์ประกอบในวิชานี้จะเท่ากับ <b>${potentialTotalScore}</b> คะแนน (คะแนนเดิม ${currentTotalScore} + ที่เพิ่มใหม่ ${newComponentMaxScore}) ซึ่งเกิน 100 คะแนน กรุณาปรับแก้`,
                confirmButtonColor: 'var(--primary-color)'
            });
            return;
        }

        showLoading();
        google.script.run.withSuccessHandler(function(result) {
            if (result.success) {
                const newComponent = { ...componentData, id: result.id };
                if (componentData.id) {
                    const index = appState.scoreComponents.findIndex(c => c.id === componentData.id);
                    if (index > -1) appState.scoreComponents[index] = newComponent;
                } else {
                    appState.scoreComponents.push(newComponent);
                }
                closeModal('score-component-modal');
                renderComponents();
                hideLoading();
                Swal.fire('สำเร็จ!', 'บันทึกองค์ประกอบคะแนนเรียบร้อย', 'success');
            }
        }).withFailureHandler(handleError).saveScoreComponent(componentData);
    });
    
    populateFilters();
}

function handleRemarkChange(selectElement) {
    const selectedValue = selectElement.val();
    const row = selectElement.closest('tr');
    const gradeCell = row.find('.grade');
    const scoreInputs = row.find('.score-input');
    const totalScoreCell = row.find('.total-score');

    if (selectedValue !== '-') {
        // --- START: แก้ไขจุดที่ 1 ---
        // เมื่อเลือก ร, มส, มผ: ให้ปิดการใช้งานช่องคะแนน แต่ "ไม่ลบ" ค่าในช่องออก
        gradeCell.text(selectedValue).addClass('text-red-500');
        scoreInputs.prop('disabled', true).addClass('bg-gray-100'); // เอา .val('') ออกไปแล้ว
        // --- END: แก้ไขจุดที่ 1 ---
    } else {
        // --- START: แก้ไขจุดที่ 2 ---
        // เมื่อเลือกกลับมาเป็น "-": ให้เปิดใช้งานช่องคะแนนและคำนวณเกรดใหม่จากค่าที่มีอยู่
        gradeCell.removeClass('text-red-500');
        scoreInputs.prop('disabled', false).removeClass('bg-gray-100');

        // คำนวณคะแนนรวมและเกรดใหม่จากค่าที่ยังคงอยู่ในช่อง input
        let totalScore = 0;
        let totalMaxScore = 0;
        row.find('.score-input').each(function() {
            const input = $(this);
            totalScore += parseFloat(input.val()) || 0;
            totalMaxScore += parseFloat(input.data('max-score')) || 0;
        });

        // อัปเดตการแสดงผลคะแนนรวมและเกรด
        totalScoreCell.text(totalScore.toFixed(2));
        gradeCell.text(calculateGrade(totalScore, totalMaxScore, '-'));
        // --- END: แก้ไขจุดที่ 2 ---
    }
}


function loadContentForTab(tabId, needsRefresh) {
    if (tabId === 'dashboard') {
        loadApplicationData(true, () => {
            try { loadDashboard(); } 
            catch (error) { handleError(error); }
        });
        return;
    }
    
    if (tabId === 'scoring') {
        showLoading();
        google.script.run
            .withSuccessHandler(function(htmlContent) {
                $('#scoring').html(htmlContent);
                initializeScoringPage(); 
                hideLoading();
            })
            .withFailureHandler(handleError)
            .loadScoringPage();
        return;
    }

    if (tabId === 'characteristics') {
        showLoading();
        google.script.run
            .withSuccessHandler(function(htmlContent) {
                $('#characteristics').html(htmlContent);
                initializeCharacteristicsPage(); 
                hideLoading();
            })
            .withFailureHandler(handleError)
            .loadCharacteristicsPage();
        return;
    }

    if (tabId === 'values-competencies') {
        showLoading();
        google.script.run
            .withSuccessHandler(function(htmlContent) {
                $('#values-competencies').html(htmlContent);
                initializeValuesCompetenciesPage(); 
                hideLoading();
            })
            .withFailureHandler(handleError)
            .loadValuesCompetenciesPage();
        return;
    }
    
    if (tabId === 'p5-cover') {
        showLoading();
        google.script.run
            .withSuccessHandler(function(htmlContent) {
                $('#p5-cover').html(htmlContent);
                initializeP5CoverPage(); 
                hideLoading();
            })
            .withFailureHandler(handleError)
            .loadP5CoverPage();
        return;
    }
    
    if (tabId === 'activities') {
        showLoading();
        google.script.run
            .withSuccessHandler(function(htmlContent) {
                $('#activities').html(htmlContent);
                initializeActivitiesPage();
                hideLoading();
            })
            .withFailureHandler(handleError)
            .loadActivitiesPage();
        return;
    }

    const loadFunctionMap = { 
        'attendance': populateAttendanceFilters,
        'settings': loadSettings, 
        'subjects': loadSubjects, 
        'teachers': loadTeachers, 
        'students': loadStudents, 
        'reports': loadReportFilters, 
        'classroom-reports': loadClassroomReportFilters, 
        'school-report': loadSchoolReportFilters, 
        'monthly-report': loadMonthlyReportFilters,
        'class-levels': loadClassLevelSettings,
        'score-report': initializeScoreReportPage,
        'characteristics-report': initializeCharacteristicsReportPage,
        'activities-report': initializeActivitiesReportPage,
        'values-competencies-report': initializeValuesCompetenciesReportPage
    };

    const loadFn = loadFunctionMap[tabId];
    if (!loadFn) {
        console.warn(`No load function defined for tab: ${tabId}`); 
        hideLoading();
        return;
    }

    const alwaysRefresh = ['subjects', 'teachers', 'students', 'reports', 'classroom-reports', 'school-report', 'class-levels'];
    if (needsRefresh && alwaysRefresh.includes(tabId)) {
        loadApplicationData(true, () => {
            populateAllDropdowns();
            loadFn();
        });
    } else {
        showLoading();
        setTimeout(() => {
            try { loadFn(); } 
            catch (error) { handleError(error); } 
            finally { hideLoading(); }
        }, 50);
    }
}

function initializeScoreReportPage() {
    const user = appState.user;
    if (!user || user.role !== 'teacher') return;

    const subjectSelect = $('#score-report-subject');
    const classSelect = $('#score-report-class');
    const classroomSelect = $('#score-report-classroom');

    const printSettingsHtml = `
    <details class="mt-4 border rounded-lg p-2">
        <summary class="cursor-pointer text-gray-600">ตั้งค่าการพิมพ์ (สำหรับ PDF)</summary>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
            <div>
                <label for="margin-top" class="block text-sm text-gray-500">ขอบบน</label>
                <input type="number" id="margin-top" value="0.75" step="0.05" class="w-full p-1 border rounded">
            </div>
            <div>
                <label for="margin-bottom" class="block text-sm text-gray-500">ขอบล่าง</label>
                <input type="number" id="margin-bottom" value="0.75" step="0.05" class="w-full p-1 border rounded">
            </div>
            <div>
                <label for="margin-left" class="block text-sm text-gray-500">ขอบซ้าย</label>
                <input type="number" id="margin-left" value="0.7" step="0.05" class="w-full p-1 border rounded">
            </div>
            <div>
                <label for="margin-right" class="block text-sm text-gray-500">ขอบขวา</label>
                <input type="number" id="margin-right" value="0.7" step="0.05" class="w-full p-1 border rounded">
            </div>
        </div>
    </details>
    `;

    if (!$('#export-score-report-pdf').next('details').length) {
        $('#export-score-report-pdf').after(printSettingsHtml);
    }

    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherSubjectIds = [...new Set(teacherPairs.map(p => p.subjectId))];
    const teacherSubjects = appState.subjects.filter(s => teacherSubjectIds.includes(s.id));

    subjectSelect.html('<option value="">-- เลือกวิชา --</option>');
    teacherSubjects.forEach(s => subjectSelect.append(`<option value="${s.id}">${s.code} - ${s.name}</option>`));

    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));

    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);

    classSelect.off('change.scorereport').on('change.scorereport', function() {
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
    });

    $('#generate-score-report').off('click').on('click', function() {
        const params = {
            subjectId: subjectSelect.val(),
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            teacherName: user.name
        };
        if (!params.subjectId || !params.classLevel || !params.classroom) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกตัวกรองให้ครบทุกช่อง', 'warning');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success) {
                    renderScoreReportTable(result);
                    $('#score-report-results').removeClass('hidden');
                } else {
                    handleError({
                        message: 'ไม่พบข้อมูลสำหรับสร้างรายงาน'
                    });
                }
            })
            .withFailureHandler(handleError)
            .getMonthlyScoreReportData(params);
    });

    $('#export-score-report-pdf').off('click').on('click', function() {
        const params = {
            subjectId: subjectSelect.val(),
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            teacherName: user.name,
            margins: {
                top: $('#margin-top').val(),
                bottom: $('#margin-bottom').val(),
                left: $('#margin-left').val(),
                right: $('#margin-right').val()
            }
        };

        if (!params.subjectId || !params.classLevel || !params.classroom) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกตัวกรองให้ครบทุกช่องเพื่อสร้าง PDF', 'warning');
            return;
        }
        showLoading();
        Swal.fire({
            title: 'กำลังสร้างรายงาน PDF',
            text: 'กรุณารอสักครู่ ระบบกำลังประมวลผล...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.url) {
                    Swal.fire({
                        icon: 'success',
                        title: 'สร้างรายงานสำเร็จ!',
                        html: `<p>คุณสามารถดาวน์โหลดไฟล์ PDF ได้จากลิงก์ด้านล่าง</p><a href="${result.url}" target="_blank" class="text-blue-500 underline">ดาวน์โหลดรายงาน PDF</a>`,
                        confirmButtonText: 'ปิด',
                        confirmButtonColor: 'var(--primary-color)'
                    });
                } else {
                    handleError({
                        message: result.message || 'สร้าง PDF ล้มเหลว'
                    });
                }
            })
            .withFailureHandler(handleError)
            .createScoreReportPdfFromSheet(params);
    });
}

function renderScoreReportTable(data) {
    const { reportData, components, reportDetails } = data;
    const resultsContainer = document.getElementById('score-report-results');
    const headerDiv = document.getElementById('score-report-header');
    const head = document.getElementById('score-report-table-head');
    const body = document.getElementById('score-report-table-body');

    const subjectText = `รายวิชา: ${reportDetails.subjectInfo.code} - ${reportDetails.subjectInfo.name}`;
    const classText = `ระดับชั้น: ${reportDetails.classLevel} ห้อง: ${reportDetails.classroom}`;
    const teacherText = `ครูผู้สอน: ${reportDetails.teacherName}`;
    headerDiv.innerHTML = `<h3 class="text-xl font-bold">รายงานสรุปผลการเรียน</h3><p class="text-md text-gray-700">${subjectText}</p><p class="text-sm text-gray-600">${classText} | ${teacherText}</p>`;

    if (!reportData || reportData.length === 0) {
        head.innerHTML = '';
        body.innerHTML = `<tr><td class="text-center p-4">ไม่พบข้อมูลคะแนนของนักเรียนในห้องนี้</td></tr>`;
        return;
    }

    let headerHtml = '<tr><th>ลำดับ</th><th>รหัสนักเรียน</th><th>ชื่อ-นามสกุล</th>';
    let totalMaxScorePossible = 0;
    components.forEach(c => {
        headerHtml += `<th>${c.componentName}<br><small>(${c.maxScore})</small></th>`;
        totalMaxScorePossible += parseFloat(c.maxScore);
    });
    headerHtml += `<th>รวม<br><small>(${totalMaxScorePossible.toFixed(2)})</small></th><th>เกรด</th></tr>`;
    head.innerHTML = headerHtml;

    let bodyHtml = '';
    const componentAverages = components.reduce((acc, c) => ({ ...acc, [c.id]: 0 }), {});
    let totalStudentsWithScores = 0;

    reportData.sort((a,b) => (a.studentCode || '').localeCompare(b.studentCode)).forEach((student, index) => {
        bodyHtml += `<tr><td>${index + 1}</td><td>${student.studentCode}</td><td>${student.studentName}</td>`;
        if (student.totalScore > 0) totalStudentsWithScores++;
        components.forEach(c => {
            const score = student.scores[c.id] || 0;
            bodyHtml += `<td>${score}</td>`;
            componentAverages[c.id] += parseFloat(score);
        });
        
        // --- START: ส่วนที่แก้ไข ---
        // 1. นำเกรดที่คำนวณเสร็จแล้วจาก Backend มาใช้โดยตรง ไม่ต้องคำนวณซ้ำ
        const grade = student.finalGrade; 
        // --- END: ส่วนที่แก้ไข ---

        bodyHtml += `<td class="text-blue-600">${student.totalScore.toFixed(2)}</td><td class="text-green-600">${grade}</td></tr>`;
    });
    
    // Footer Row for Averages
    let footerHtml = '<tfoot class="bg-gray-100 font-bold"><tr><td colspan="3" class="text-right pr-4">ค่าเฉลี่ยของห้อง</td>';
    let totalAverageScore = 0;
    components.forEach(c => {
        const avg = totalStudentsWithScores > 0 ? (componentAverages[c.id] / totalStudentsWithScores) : 0;
        footerHtml += `<td>${avg.toFixed(2)}</td>`;
        totalAverageScore += avg;
    });
    footerHtml += `<td>${totalAverageScore.toFixed(2)}</td><td>-</td></tr></tfoot>`;
    body.innerHTML = bodyHtml + footerHtml;
}

function initializeCharacteristicsPage() {
    const user = appState.user;
    if (!user || user.role !== 'teacher') return;

    const container = $('#characteristics-container');
    const classSelect = container.find('#characteristics-class');
    const classroomSelect = container.find('#characteristics-classroom');
    const startBtn = container.find('#start-characteristics-evaluation-btn');
    const contentArea = container.find('#characteristics-content-area');
    const placeholder = container.find('#characteristics-placeholder');

    // ฟังก์ชันภายในสำหรับตรวจสอบเงื่อนไขตัวกรอง
    function checkFilters() {
        if (classSelect.val() && classroomSelect.val()) {
            startBtn.removeClass('hidden');
        } else {
            startBtn.addClass('hidden');
        }
        contentArea.addClass('hidden');
        placeholder.removeClass('hidden');
    }

    // 1. ตั้งค่าและผูก Event กับตัวกรอง (Filters)
    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));
    
    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);

    classSelect.off('change').on('change', function() {
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
        checkFilters();
    });
    classroomSelect.off('change').on('change', checkFilters);

    // 2. Event Listener สำหรับปุ่ม "เริ่มการประเมิน"
    startBtn.off('click').on('click', function() {
        placeholder.addClass('hidden');
        contentArea.removeClass('hidden');
        renderCharacteristicsTable();
    });

    // 3. Event Listener สำหรับปุ่ม "บันทึกผลการประเมิน"
    $('#save-characteristics-btn').off('click').on('click', function() {
        const scoresToSave = [];
        $('#characteristics-table-body tr').each(function() {
            const studentId = $(this).data('student-id');
            $(this).find('.char-score-select').each(function() {
                const scoreValue = $(this).val();
                if (scoreValue !== "") { // บันทึกเฉพาะที่มีการให้คะแนน
                    scoresToSave.push({
                        studentId: studentId,
                        itemId: $(this).data('item-id'),
                        score: scoreValue,
                        teacherId: user.id
                    });
                }
            });
        });

        if (scoresToSave.length === 0) {
            Swal.fire('ไม่มีข้อมูล', 'ยังไม่มีการให้คะแนนเพื่อบันทึก', 'info');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.savedRecords) {
                     // อัปเดต State ในเครื่อง
                    result.savedRecords.forEach(savedRec => {
                        const index = appState.characteristicsScores.findIndex(s => s.studentId === savedRec.studentId && s.itemId === savedRec.itemId);
                        if (index !== -1) {
                            appState.characteristicsScores[index].score = savedRec.score;
                        } else {
                            appState.characteristicsScores.push(savedRec);
                        }
                    });
                    Swal.fire('สำเร็จ!', `บันทึกผลการประเมิน ${result.count} รายการเรียบร้อย`, 'success');
                }
            })
            .withFailureHandler(handleError)
            .saveCharacteristicsScores(scoresToSave);
    });

    // 4. Event Listener สำหรับการคำนวณผลสรุปแบบ Real-time
    $('#characteristics-table-body').off('change.summary').on('change.summary', '.char-score-select', function() {
        const row = $(this).closest('tr');
        updateSummaryForRow(row);
    });
}


/**
 * วาดตารางประเมินคุณลักษณะฯ
 */
function renderCharacteristicsTable() {
    const classLevel = $('#characteristics-class').val();
    const classroom = $('#characteristics-classroom').val();
    
    console.log("Attempting to render table for:", { class: classLevel, room: classroom });
    console.log("Total students in appState:", appState.students.length);

    // --- START: แก้ไข Logic การกรองข้อมูล ---
    // เพิ่ม .trim() เพื่อตัดช่องว่างที่อาจติดมากับข้อมูล และเปลี่ยน === เป็น == เพื่อให้ยืดหยุ่นระหว่างตัวเลขและข้อความ
    const students = appState.students.filter(s => 
        (s.class || '').trim() == classLevel && 
        (s.classroom || '').toString().trim() == classroom
    ).sort((a,b) => (a.code || '').localeCompare(b.code));
    // --- END: แก้ไข Logic การกรองข้อมูล ---
    
    const items = appState.characteristicsItems.sort((a,b) => (a.order || 0) - (b.order || 0));
    const scores = appState.characteristicsScores;

    const head = $('#characteristics-table-head');
    const body = $('#characteristics-table-body');
    head.empty();
    body.empty();
    
    if (!items || items.length === 0) {
        body.html(`<tr><td colspan="5" class="p-4 text-center text-red-600 bg-red-50"><strong>ข้อผิดพลาด:</strong> ไม่พบรายการประเมินในระบบ</td></tr>`);
        return;
    }

    if (students.length === 0) {
        // --- START: เพิ่มการ Log ข้อมูลเพื่อช่วยตรวจสอบ ---
        console.log("Filter returned 0 students.");
        // ดึงรายชื่อห้องเรียนทั้งหมดที่มีอยู่จริงในชั้นเรียนที่เลือก เพื่อให้ผู้ใช้เปรียบเทียบ
        const availableClassroomsInGrade = [...new Set(appState.students
            .filter(s => (s.class || '').trim() == classLevel)
            .map(s => (s.classroom || '').toString().trim())
        )];
        console.log("Selected Classroom:", `'${classroom}'`);
        console.log("Available classrooms in this grade from database:", availableClassroomsInGrade);
        // --- END: เพิ่มการ Log ข้อมูล ---
        
        body.html(`<tr><td colspan="5" class="p-4 text-center text-yellow-600 bg-yellow-50"><strong>แจ้งเตือน:</strong> ไม่พบรายชื่อนักเรียนในชั้นเรียนที่เลือก<br><small>กรุณาตรวจสอบความถูกต้องของข้อมูลห้องเรียนในชีต Students และ Teachers</small></td></tr>`);
        return;
    } else {
        console.log("Found " + students.length + " students for this class.");
    }

    // (ส่วนที่เหลือของฟังก์ชันตั้งแต่การสร้าง Header ลงไป เหมือนเดิมทั้งหมด ไม่ต้องแก้ไข)
    const characteristicItems = items.filter(i => i.itemGroup === 'คุณลักษณะอันพึงประสงค์');
    const readingItems = items.filter(i => i.itemGroup === 'การอ่าน คิดวิเคราะห์ และเขียน');

    let headerRow1 = '<tr>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 0px; min-width: 60px;">ลำดับ</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 60px; min-width: 120px;">รหัสนักเรียน</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 180px; min-width: 200px;">ชื่อ-นามสกุล</th>';
    
    if(characteristicItems.length > 0) {
        headerRow1 += `<th colspan="${characteristicItems.length}" class="text-center bg-gray-100">คุณลักษณะอันพึงประสงค์</th>`;
    }
    if(readingItems.length > 0) {
        headerRow1 += `<th colspan="${readingItems.length}" class="text-center bg-gray-100">การอ่าน คิดวิเคราะห์ และเขียน</th>`;
    }

    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-blue-100 z-30" style="right: 120px; min-width: 120px;">สรุป<br>(คุณลักษณะฯ)</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-green-100 z-30" style="right: 0px; min-width: 120px;">สรุป<br>(การอ่านฯ)</th>';
    headerRow1 += '</tr>';

    let headerRow2 = '<tr>';
    characteristicItems.forEach(item => {
        const itemName = item.itemName.replace(/(\d+\.\s)/, '');
        headerRow2 += `<th class="vertical-header"><div>${itemName}</div></th>`;
    });
    readingItems.forEach(item => {
        const itemName = item.itemName.replace(/(\d+\.\s)/, '');
        headerRow2 += `<th class="vertical-header"><div>${itemName}</div></th>`;
    });
    headerRow2 += '</tr>';

    head.html(headerRow1 + headerRow2);

    students.forEach((student, index) => {
        let rowHtml = `<tr data-student-id="${student.id}">`;
        rowHtml += `<td class="sticky text-center bg-white z-20" style="left: 0px;">${index + 1}</td>`;
        rowHtml += `<td class="sticky bg-white z-20" style="left: 60px;">${student.code}</td>`;
        rowHtml += `<td class="sticky bg-white z-20 text-left" style="left: 180px;">${student.name}</td>`;
        
        items.forEach(item => {
            const scoreRecord = scores.find(s => s.studentId === student.id && s.itemId === item.id);
            const currentScore = scoreRecord ? scoreRecord.score : "";
            rowHtml += `<td class="text-center p-1">
                <select class="char-score-select w-full border rounded p-1 text-sm" data-item-id="${item.id}">
                    <option value="" ${currentScore === "" ? 'selected' : ''}>-</option>
                    <option value="3" ${currentScore == "3" ? 'selected' : ''}>3</option>
                    <option value="2" ${currentScore == "2" ? 'selected' : ''}>2</option>
                    <option value="1" ${currentScore == "1" ? 'selected' : ''}>1</option>
                    <option value="0" ${currentScore == "0" ? 'selected' : ''}>0</option>
                </select>
            </td>`;
        });
        
        rowHtml += `<td class="sticky text-center font-bold bg-blue-50 z-20 char-summary-result" style="right: 120px;">-</td>`;
        rowHtml += `<td class="sticky text-center font-bold bg-green-50 z-20 read-summary-result" style="right: 0px;">-</td>`;
        rowHtml += '</tr>';
        body.append(rowHtml);
    });
    
    body.find('tr').each(function() {
        updateSummaryForRow($(this));
    });
}

function updateSummaryForRow(rowElement) {
    let characteristicSum = 0, characteristicCount = 0;
    let readingSum = 0, readingCount = 0;
    
    const items = appState.characteristicsItems;

    rowElement.find('.char-score-select').each(function() {
        const scoreSelect = $(this);
        const score = parseInt(scoreSelect.val());
        const itemId = scoreSelect.data('item-id');
        
        if (!isNaN(score)) {
            const itemInfo = items.find(i => i.id === itemId);
            if (itemInfo) {
                if (itemInfo.itemGroup === 'คุณลักษณะอันพึงประสงค์') {
                    characteristicSum += score;
                    characteristicCount++;
                } else if (itemInfo.itemGroup === 'การอ่าน คิดวิเคราะห์ และเขียน') {
                    readingSum += score;
                    readingCount++;
                }
            }
        }
    });

    // --- START: ส่วนที่แก้ไข ---
    const charResultCell = rowElement.find('.char-summary-result');
    charResultCell.text('-').removeClass('text-green-600 text-blue-600 text-yellow-600 text-red-600');
    if (characteristicCount > 0) {
        const percentage = (characteristicSum / (characteristicCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        charResultCell.text(style.text).addClass(style.class);
    }

    const readResultCell = rowElement.find('.read-summary-result');
    readResultCell.text('-').removeClass('text-green-600 text-blue-600 text-yellow-600 text-red-600');
    if (readingCount > 0) {
        const percentage = (readingSum / (readingCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        readResultCell.text(style.text).addClass(style.class);
    }
    // --- END: ส่วนที่แก้ไข ---
}

function initializeCharacteristicsReportPage() {
    const reportContainer = $('#characteristics-report');
    // --- START: แก้ไข ---
    // ปรับปรุง UI ให้มีส่วนหัวรายงาน (report-header) และจัดปุ่มให้อยู่ตรงกลาง
    reportContainer.html(`
        <div class="p-2 md:p-4">
            <h2 class="text-2xl font-bold mb-6">รายงานสรุปผลคุณลักษณะฯ</h2>
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                        <select id="char-report-class" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                        <select id="char-report-classroom" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <button id="generate-char-report" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg w-full mt-4 md:mt-0">
                        สร้างรายงาน
                    </button>
                </div>
            </div>
            
            <div id="char-report-results-container" class="hidden mt-6">
                <div id="char-report-header" class="report-header"></div> 
                
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center mb-4">
                        <button id="download-char-report-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">
                            ดาวน์โหลดรายงาน (PDF)
                        </button>
                    </div>
                    <div class="overflow-x-auto report-table-container" style="max-height: 75vh;">
                         <table id="char-report-table" class="w-full report-table">
                            <thead id="char-report-table-head"></thead>
                            <tbody id="char-report-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `);
    // --- END: แก้ไข ---

    // ส่วน Logic การทำงานของปุ่ม (เหมือนเดิม)
    const user = appState.user;
    const classSelect = $('#char-report-class');
    const classroomSelect = $('#char-report-classroom');
    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    
    // Populate Filters
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));
    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);
    classSelect.on('change', function() {
        $('#char-report-results-container').addClass('hidden'); // ซ่อนผลลัพธ์เมื่อมีการเปลี่ยน filter
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
    });
    classroomSelect.on('change', function(){
        $('#char-report-results-container').addClass('hidden');
    });

    // ปุ่ม "สร้างรายงาน"
    $('#generate-char-report').on('click', function() {
        const params = {
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            teacherName: user.name // ส่งชื่อครูไปด้วย
        };
        if (!params.classLevel || !params.classroom) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกระดับชั้นและห้องเรียน', 'warning');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success) {
                    renderCharacteristicsReportTable(result);
                    $('#char-report-results-container').removeClass('hidden');
                } else {
                    handleError({ message: result.message || 'ไม่สามารถดึงข้อมูลรายงานได้' });
                }
            })
            .withFailureHandler(handleError)
            .getCharacteristicsReportData(params);
    });

    // ปุ่ม "ดาวน์โหลด PDF"
    $('#download-char-report-pdf').on('click', function() {
        const params = {
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            teacherName: user.name
        };

        showLoading();
        Swal.fire({
            title: 'กำลังสร้างรายงาน PDF',
            text: 'กรุณารอสักครู่ ระบบกำลังประมวลผล...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.url) {
                    Swal.fire({
                        icon: 'success',
                        title: 'สร้างรายงานสำเร็จ!',
                        html: `<p>คุณสามารถดาวน์โหลดไฟล์ PDF ได้จากลิงก์ด้านล่าง</p><a href="${result.url}" target="_blank" class="text-blue-500 underline">ดาวน์โหลดรายงาน PDF</a>`,
                        confirmButtonText: 'ปิด',
                        confirmButtonColor: 'var(--primary-color)'
                    });
                } else {
                    handleError({ message: result.message || 'สร้าง PDF ล้มเหลว' });
                }
            })
            .withFailureHandler(function(error) {
                Swal.close();
                handleError(error);
            })
            .createCharacteristicsReportPdf(params);
    });
}

function renderCharacteristicsReportTable(data) {
    const { reportData, items, reportDetails } = data; 
    const headerDiv = document.getElementById('char-report-header');
    const head = $('#char-report-table-head');
    const body = $('#char-report-table-body');
    head.empty();
    body.empty();

    if (headerDiv && reportDetails) {
        const classText = `ระดับชั้น: ${reportDetails.classLevel} ห้อง: ${reportDetails.classroom}`;
        const teacherText = `ครูผู้ประเมิน: ${reportDetails.teacherName}`;
        headerDiv.innerHTML = `<h3 class="text-xl font-bold">รายงานสรุปผลคุณลักษณะอันพึงประสงค์ฯ</h3><p class="text-md text-gray-700">${classText}</p><p class="text-sm text-gray-600">${teacherText}</p>`;
    }

    if (!reportData || reportData.length === 0) {
        body.html('<tr><td class="text-center p-4" colspan="20">ไม่พบข้อมูลการประเมิน</td></tr>');
        return;
    }

    const characteristicItems = items.filter(i => i.itemGroup === 'คุณลักษณะอันพึงประสงค์');
    const readingItems = items.filter(i => i.itemGroup === 'การอ่าน คิดวิเคราะห์ และเขียน');

    let headerRow1 = '<tr>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 0px; min-width: 60px;">ลำดับ</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 60px; min-width: 120px;">รหัสนักเรียน</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 180px; min-width: 200px;">ชื่อ-นามสกุล</th>';
    
    if(characteristicItems.length > 0) {
        headerRow1 += `<th colspan="${characteristicItems.length}" class="text-center bg-gray-100">คุณลักษณะอันพึงประสงค์</th>`;
    }
    if(readingItems.length > 0) {
        headerRow1 += `<th colspan="${readingItems.length}" class="text-center bg-gray-100">การอ่าน คิดวิเคราะห์ และเขียน</th>`;
    }

    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-blue-100 z-30" style="right: 120px; min-width: 120px;">สรุป<br>(คุณลักษณะฯ)</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-green-100 z-30" style="right: 0px; min-width: 120px;">สรุป<br>(การอ่านฯ)</th>';
    headerRow1 += '</tr>';

    let headerRow2 = '<tr>';
    items.forEach(item => {
        const itemName = item.itemName.replace(/(\d+\.\s)/, '');
        headerRow2 += `<th class="vertical-header"><div>${itemName}</div></th>`;
    });
    headerRow2 += '</tr>';

    head.html(headerRow1 + headerRow2);
    
    reportData.forEach((student, index) => {
        let rowHtml = `<tr>`;
        rowHtml += `<td class="sticky bg-white z-10 text-center" style="left: 0px;">${index + 1}</td>`;
        rowHtml += `<td class="sticky bg-white z-10" style="left: 60px;">${student.studentCode}</td>`;
        rowHtml += `<td class="sticky bg-white z-10 text-left" style="left: 180px;">${student.studentName}</td>`;
        
        items.forEach(item => {
            const score = student.scores[item.id] !== undefined ? student.scores[item.id] : '-';
            rowHtml += `<td class="text-center">${score}</td>`;
        });
        
        // --- START: ส่วนที่แก้ไข ---
        // กำหนด Class ของ CSS ตามเงื่อนไขใหม่ (ดีเยี่ยม, ดี, ผ่าน ใช้สีเดียวกัน)
        const passLevels = ['ผ่าน', 'ดี', 'ดีเยี่ยม'];
        const charResultClass = passLevels.includes(student.characteristicResult) ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
        const readResultClass = passLevels.includes(student.readingResult) ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';

        rowHtml += `<td class="sticky text-center font-bold z-10 ${charResultClass}" style="right: 120px;">${student.characteristicResult}</td>`;
        rowHtml += `<td class="sticky text-center font-bold z-10 ${readResultClass}" style="right: 0px;">${student.readingResult}</td>`;
        // --- END: ส่วนที่แก้ไข ---

        rowHtml += '</tr>';
        body.append(rowHtml);
    });
}

function initializeActivitiesPage() {
    const user = appState.user;
    if (!user || user.role !== 'teacher') return;

    const container = $('#activities-container');
    const classSelect = container.find('#activities-class');
    const classroomSelect = container.find('#activities-classroom');
    const startBtn = container.find('#start-activities-evaluation-btn');
    const contentArea = container.find('#activities-content-area');
    const placeholder = container.find('#activities-placeholder');
    const componentsList = container.find('#activity-components-list');
    const tableHead = container.find('#activities-table-head');
    const tableBody = container.find('#activities-table-body');

    let currentFilters = {};
    let currentComponents = [];
    let currentStudents = [];

    function checkFilters() {
        if (classSelect.val() && classroomSelect.val()) {
            startBtn.removeClass('hidden');
        } else {
            startBtn.addClass('hidden');
        }
        contentArea.addClass('hidden');
        placeholder.removeClass('hidden');
    }

    // Populate Filters
    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));

    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);

    classSelect.on('change', function() {
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
        checkFilters();
    });
    classroomSelect.on('change', checkFilters);

    // Event Listeners
    container.off('click').off('change'); // Clear previous handlers for this container

    container.on('click', '#start-activities-evaluation-btn', function() {
        currentFilters = {
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            teacherId: user.id
        };

        const studentsInClass = appState.students.filter(s => s.class === currentFilters.classLevel && s.classroom === currentFilters.classroom);

        if (studentsInClass.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'ไม่พบข้อมูลนักเรียน',
                text: 'ไม่พบรายชื่อนักเรียนในห้องเรียนที่เลือก กรุณาตรวจสอบข้อมูล',
                confirmButtonColor: 'var(--primary-color)'
            });
            contentArea.addClass('hidden');
            placeholder.removeClass('hidden');
            return;
        }

        placeholder.addClass('hidden');
        contentArea.removeClass('hidden');
        renderActivityComponents();
    });

    container.on('click', '#add-activity-component-btn', function() {
        // --- START: ส่วนที่แก้ไข ---
        // กรอง components ปัจจุบันของห้องที่เลือก
        currentComponents = appState.activityComponents.filter(c => c.classLevel === currentFilters.classLevel && c.classroom === currentFilters.classroom);
        
        // ตรวจสอบจำนวนกิจกรรม
        if (currentComponents.length >= 4) {
            Swal.fire({
                icon: 'error',
                title: 'ไม่สามารถเพิ่มได้',
                text: 'คุณสามารถเพิ่มรายการกิจกรรมพัฒนาผู้เรียนได้สูงสุด 4 รายการต่อห้องเรียนเท่านั้น',
                confirmButtonColor: 'var(--primary-color)'
            });
            return; // หยุดการทำงาน ไม่เปิด Modal
        }
        // --- END: ส่วนที่แก้ไข ---

        $('#activity-component-form')[0].reset();
        $('#activity-component-id').val('');
        $('#activity-component-modal-title').text('เพิ่มรายการกิจกรรม');
        openModal('activity-component-modal');
    });

    container.on('click', '.edit-component', function() {
        const componentId = $(this).data('id');
        const component = appState.activityComponents.find(c => c.id === componentId);
        if (component) {
            $('#activity-component-id').val(component.id);
            $('#activity-component-name').val(component.componentName);
            $('#activity-component-modal-title').text('แก้ไขรายการกิจกรรม');
            openModal('activity-component-modal');
        }
    });

    container.on('click', '.delete-component', function() {
        const componentId = $(this).data('id');
        Swal.fire({
            title: 'ยืนยันการลบ?',
            text: "รายการกิจกรรมและผลการประเมินที่เกี่ยวข้องทั้งหมดจะถูกลบ!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ใช่, ลบเลย!'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                google.script.run
                    .withSuccessHandler(function() {
                        appState.activityComponents = appState.activityComponents.filter(c => c.id !== componentId);
                        appState.activityScores = appState.activityScores.filter(s => s.componentId !== componentId);
                        renderActivityComponents();
                        hideLoading();
                        Swal.fire('ลบแล้ว!', 'ลบรายการกิจกรรมเรียบร้อย', 'success');
                    })
                    .withFailureHandler(handleError)
                    .deleteActivityComponent(componentId);
            }
        });
    });

    container.on('click', '#save-activities-btn', function() {
        const scoresToSave = [];
        $('#activities-table-body tr').each(function() {
            const studentId = $(this).data('student-id');
            $(this).find('.activity-result-select').each(function() {
                const resultValue = $(this).val();
                if (resultValue) { // Save only if a value is selected
                    scoresToSave.push({
                        studentId: studentId,
                        componentId: $(this).data('component-id'),
                        result: resultValue,
                        teacherId: user.id
                    });
                }
            });
        });

        if (scoresToSave.length === 0) {
            Swal.fire('ไม่มีข้อมูล', 'ยังไม่มีการประเมินเพื่อบันทึก', 'info');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.savedRecords) {
                    result.savedRecords.forEach(savedRec => {
                        const index = appState.activityScores.findIndex(s => s.studentId === savedRec.studentId && s.componentId === savedRec.componentId);
                        if (index !== -1) {
                            appState.activityScores[index].result = savedRec.result;
                        } else {
                            appState.activityScores.push(savedRec);
                        }
                    });
                    Swal.fire('สำเร็จ!', `บันทึกผลการประเมิน ${result.count} รายการเรียบร้อย`, 'success');
                }
            })
            .withFailureHandler(handleError)
            .saveActivityScores(scoresToSave);
    });

    $('#activity-component-form').off('submit').on('submit', function(e) {
        e.preventDefault();
        const componentData = {
            id: $('#activity-component-id').val(),
            teacherId: user.id,
            classLevel: currentFilters.classLevel,
            classroom: currentFilters.classroom,
            componentName: $('#activity-component-name').val().trim()
        };
        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success) {
                    const newComponent = { ...componentData,
                        id: result.id
                    };
                    if (componentData.id) {
                        const index = appState.activityComponents.findIndex(c => c.id === componentData.id);
                        if (index > -1) appState.activityComponents[index] = newComponent;
                    } else {
                        appState.activityComponents.push(newComponent);
                    }
                    closeModal('activity-component-modal');
                    renderActivityComponents();
                    Swal.fire('สำเร็จ!', 'บันทึกรายการกิจกรรมเรียบร้อย', 'success');
                }
            })
            .withFailureHandler(handleError)
            .saveActivityComponent(componentData);
    });

    function renderActivityComponents() {
        componentsList.empty();
        currentComponents = appState.activityComponents.filter(c => c.classLevel === currentFilters.classLevel && c.classroom === currentFilters.classroom);
        if (currentComponents.length === 0) {
            componentsList.html('<p class="text-gray-400 text-center">ยังไม่มีรายการกิจกรรมสำหรับห้องเรียนนี้</p>');
        } else {
            currentComponents.forEach(c => {
                const componentHtml = `<div class="flex items-center justify-between p-2 border rounded-md bg-gray-50">
                                <div><span class="font-semibold">${c.componentName}</span></div>
                                <div>
                                    <button class="edit-component bg-yellow-500 text-white px-2 py-1 rounded-md text-xs mr-1" data-id="${c.id}">แก้ไข</button>
                                    <button class="delete-component bg-red-500 text-white px-2 py-1 rounded-md text-xs" data-id="${c.id}">ลบ</button>
                                </div></div>`;
                componentsList.append(componentHtml);
            });
        }
        renderActivitiesTable();
    }

   function renderActivitiesTable() {
        tableHead.empty();
        tableBody.empty();
        currentStudents = appState.students.filter(s => s.class === currentFilters.classLevel && s.classroom === currentFilters.classroom).sort((a, b) => (a.code || '').localeCompare(b.code));

        if (currentComponents.length === 0 || currentStudents.length === 0) {
            $('#activities-table-container').addClass('hidden');
            return;
        }
        $('#activities-table-container').removeClass('hidden');

        let headerHtml = '<tr><th class="p-2 border">ลำดับ</th><th class="p-2 border">รหัสนักเรียน</th><th class="p-2 border text-left">ชื่อ-นามสกุล</th>';

        currentComponents.forEach(c => headerHtml += `<th class="p-2 border text-center">${c.componentName}</th>`);
        headerHtml += '</tr>';
        tableHead.html(headerHtml);

        currentStudents.forEach((student, index) => {
            let rowHtml = `<tr data-student-id="${student.id}"><td class="p-2 border text-center">${index + 1}</td><td class="p-2 border">${student.code || '-'}</td><td class="p-2 border text-left">${student.name}</td>`;

            currentComponents.forEach(c => {
                const scoreRecord = appState.activityScores.find(s => s.studentId === student.id && s.componentId === c.id);
                const currentResult = scoreRecord ? scoreRecord.result : '';
                rowHtml += `<td class="p-1 border text-center"><select class="activity-result-select w-full border rounded" data-component-id="${c.id}">
                                <option value="" ${currentResult === '' ? 'selected' : ''}>-</option>
                                <option value="ผ่าน" ${currentResult === 'ผ่าน' ? 'selected' : ''}>ผ่าน</option>
                                <option value="ไม่ผ่าน" ${currentResult === 'ไม่ผ่าน' ? 'selected' : ''}>ไม่ผ่าน</option>
                            </select></td>`;
            });
            rowHtml += `</tr>`;
            tableBody.append(rowHtml);
        });
    }
}

function initializeValuesCompetenciesPage() {
    const user = appState.user;
    if (!user || user.role !== 'teacher') return;

    const container = $('#values-competencies-container');
    const classSelect = container.find('#values-competencies-class');
    const classroomSelect = container.find('#values-competencies-classroom');
    const startBtn = container.find('#start-values-competencies-evaluation-btn');
    const contentArea = container.find('#values-competencies-content-area');
    const placeholder = container.find('#values-competencies-placeholder');

    function checkFilters() {
        if (classSelect.val() && classroomSelect.val()) {
            startBtn.removeClass('hidden');
        } else {
            startBtn.addClass('hidden');
        }
        contentArea.addClass('hidden');
        placeholder.removeClass('hidden');
    }

    // Populate Filters
    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));
    
    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);

    classSelect.off('change').on('change', function() {
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
        checkFilters();
    });
    classroomSelect.off('change').on('change', checkFilters);

    // Event Listeners
    startBtn.off('click').on('click', function() {
        placeholder.addClass('hidden');
        contentArea.removeClass('hidden');
        renderValuesCompetenciesTable();
    });

    $('#save-values-competencies-btn').off('click').on('click', function() {
        const scoresToSave = [];
        $('#values-competencies-table-body tr').each(function() {
            const studentId = $(this).data('student-id');
            $(this).find('.vc-score-select').each(function() {
                const scoreValue = $(this).val();
                if (scoreValue !== "") {
                    scoresToSave.push({
                        studentId: studentId,
                        itemId: $(this).data('item-id'),
                        score: scoreValue,
                        teacherId: user.id
                    });
                }
            });
        });

        if (scoresToSave.length === 0) {
            Swal.fire('ไม่มีข้อมูล', 'ยังไม่มีการให้คะแนนเพื่อบันทึก', 'info');
            return;
        }

        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.savedRecords) {
                    result.savedRecords.forEach(savedRec => {
                        const index = appState.valuesCompetenciesScores.findIndex(s => s.studentId === savedRec.studentId && s.itemId === savedRec.itemId);
                        if (index !== -1) {
                            appState.valuesCompetenciesScores[index].score = savedRec.score;
                        } else {
                            appState.valuesCompetenciesScores.push(savedRec);
                        }
                    });
                    Swal.fire('สำเร็จ!', `บันทึกผลการประเมิน ${result.count} รายการเรียบร้อย`, 'success');
                }
            })
            .withFailureHandler(handleError)
            .saveValuesCompetenciesScores(scoresToSave);
    });

    $('#values-competencies-table-body').off('change.summary').on('change.summary', '.vc-score-select', function() {
        const row = $(this).closest('tr');
        updateSummaryForRowVC(row);
    });
}

function renderValuesCompetenciesTable() {
    const classLevel = $('#values-competencies-class').val();
    const classroom = $('#values-competencies-classroom').val();
    
    // --- START: แก้ไข Logic การกรองข้อมูล ---
    // ปรับปรุงการกรองให้ยืดหยุ่นขึ้นโดยใช้ .trim() และ ==
    const students = appState.students.filter(s => 
        (s.class || '').trim() == classLevel && 
        (s.classroom || '').toString().trim() == classroom
    ).sort((a,b) => (a.code || '').localeCompare(b.code));
    // --- END: แก้ไข Logic การกรองข้อมูล ---
    
    const items = appState.valuesCompetenciesItems.sort((a,b) => (a.order || 0) - (b.order || 0));
    const scores = appState.valuesCompetenciesScores;

    const head = $('#values-competencies-table-head');
    const body = $('#values-competencies-table-body');
    head.empty();
    body.empty();
    
    if (!items || items.length === 0) {
        body.html(`<tr><td colspan="5" class="p-4 text-center text-red-600 bg-red-50"><strong>ข้อผิดพลาด:</strong> ไม่พบรายการค่านิยมและสมรรถนะในระบบ</td></tr>`);
        return;
    }

    // --- START: เพิ่มการแจ้งเตือนเมื่อไม่พบนักเรียน ---
    if (students.length === 0) {
        body.html(`<tr><td colspan="5" class="p-4 text-center text-yellow-600 bg-yellow-50"><strong>แจ้งเตือน:</strong> ไม่พบรายชื่อนักเรียนในชั้นเรียนที่เลือก<br><small>กรุณาตรวจสอบความถูกต้องของข้อมูลห้องเรียนในชีต Students และ Teachers</small></td></tr>`);
        return;
    }
    // --- END: เพิ่มการแจ้งเตือน ---

    const valuesItems = items.filter(i => i.itemGroup === 'ค่านิยมหลักของคนไทย 12 ประการ');
    const competenciesItems = items.filter(i => i.itemGroup === 'สมรรถนะสำคัญของผู้เรียน');

    let headerRow1 = '<tr>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 0px; min-width: 60px;">ลำดับ</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 60px; min-width: 120px;">รหัสนักเรียน</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 180px; min-width: 200px;">ชื่อ-นามสกุล</th>';
    
    if(valuesItems.length > 0) {
        headerRow1 += `<th colspan="${valuesItems.length}" class="text-center bg-gray-100">ค่านิยมหลัก 12 ประการ</th>`;
    }
    if(competenciesItems.length > 0) {
        headerRow1 += `<th colspan="${competenciesItems.length}" class="text-center bg-gray-100">สมรรถนะสำคัญ</th>`;
    }

    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-blue-100 z-30" style="right: 120px; min-width: 120px;">สรุป<br>(ค่านิยมฯ)</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-green-100 z-30" style="right: 0px; min-width: 120px;">สรุป<br>(สมรรถนะฯ)</th>';
    headerRow1 += '</tr>';

    let headerRow2 = '<tr>';
    items.forEach(item => {
        const itemName = item.itemName.replace(/(\d+\.\s)/, '');
        headerRow2 += `<th class="vertical-header"><div>${itemName}</div></th>`;
    });
    headerRow2 += '</tr>';

    head.html(headerRow1 + headerRow2);

    students.forEach((student, index) => {
        let rowHtml = `<tr data-student-id="${student.id}">`;
        rowHtml += `<td class="sticky text-center bg-white z-20" style="left: 0px;">${index + 1}</td>`;
        rowHtml += `<td class="sticky bg-white z-20" style="left: 60px;">${student.code}</td>`;
        rowHtml += `<td class="sticky bg-white z-20 text-left" style="left: 180px;">${student.name}</td>`;
        
        items.forEach(item => {
            const scoreRecord = scores.find(s => s.studentId === student.id && s.itemId === item.id);
            const currentScore = scoreRecord ? scoreRecord.score : "";
            rowHtml += `<td class="text-center p-1">
                <select class="vc-score-select w-full border rounded p-1 text-sm" data-item-id="${item.id}">
                    <option value="" ${currentScore === "" ? 'selected' : ''}>-</option>
                    <option value="3" ${currentScore == "3" ? 'selected' : ''}>3</option>
                    <option value="2" ${currentScore == "2" ? 'selected' : ''}>2</option>
                    <option value="1" ${currentScore == "1" ? 'selected' : ''}>1</option>
                    <option value="0" ${currentScore == "0" ? 'selected' : ''}>0</option>
                </select>
            </td>`;
        });
        
        rowHtml += `<td class="sticky text-center font-bold bg-blue-50 z-20 values-summary-result" style="right: 120px;">-</td>`;
        rowHtml += `<td class="sticky text-center font-bold bg-green-50 z-20 competencies-summary-result" style="right: 0px;">-</td>`;
        rowHtml += '</tr>';
        body.append(rowHtml);
    });
    
    body.find('tr').each(function() {
        updateSummaryForRowVC($(this));
    });
}

function updateSummaryForRowVC(rowElement) {
    let valuesSum = 0, valuesCount = 0;
    let competenciesSum = 0, competenciesCount = 0;
    
    const items = appState.valuesCompetenciesItems;

    rowElement.find('.vc-score-select').each(function() {
        const scoreSelect = $(this);
        const score = parseInt(scoreSelect.val());
        const itemId = scoreSelect.data('item-id');
        
        if (!isNaN(score)) {
            const itemInfo = items.find(i => i.id === itemId);
            if (itemInfo) {
                if (itemInfo.itemGroup === 'ค่านิยมหลักของคนไทย 12 ประการ') {
                    valuesSum += score;
                    valuesCount++;
                } else if (itemInfo.itemGroup === 'สมรรถนะสำคัญของผู้เรียน') {
                    competenciesSum += score;
                    competenciesCount++;
                }
            }
        }
    });

    const valuesResultCell = rowElement.find('.values-summary-result');
    valuesResultCell.text('-').removeClass('text-green-600 text-blue-600 text-yellow-600 text-red-600');
    if (valuesCount > 0) {
        const percentage = (valuesSum / (valuesCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        valuesResultCell.text(style.text).addClass(style.class);
    }

    const competenciesResultCell = rowElement.find('.competencies-summary-result');
    competenciesResultCell.text('-').removeClass('text-green-600 text-blue-600 text-yellow-600 text-red-600');
    if (competenciesCount > 0) {
        const percentage = (competenciesSum / (competenciesCount * 3)) * 100;
        const style = getCharacteristicGradeStyle(percentage);
        competenciesResultCell.text(style.text).addClass(style.class);
    }
}

function initializeValuesCompetenciesReportPage() {
    const reportContainer = $('#values-competencies-report');
    reportContainer.html(`
        <div class="p-2 md:p-4">
            <h2 class="text-2xl font-bold mb-6">รายงานสรุปผลค่านิยมและสมรรถนะ</h2>
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                        <select id="vc-report-class" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                        <select id="vc-report-classroom" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <button id="generate-vc-report" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg w-full mt-4 md:mt-0">สร้างรายงาน</button>
                </div>
            </div>
            <div id="vc-report-results-container" class="hidden mt-6">
                <div id="vc-report-header" class="report-header"></div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center mb-4">
                        <button id="download-vc-report-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">ดาวน์โหลดรายงาน (PDF)</button>
                    </div>
                    <div class="overflow-x-auto report-table-container" style="max-height: 75vh;">
                         <table id="vc-report-table" class="w-full report-table">
                            <thead id="vc-report-table-head"></thead>
                            <tbody id="vc-report-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `);

    const user = appState.user;
    const classSelect = $('#vc-report-class');
    const classroomSelect = $('#vc-report-classroom');
    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    
    // Populate Filters
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));
    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);
    classSelect.on('change', function() {
        $('#vc-report-results-container').addClass('hidden');
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
    });

    $('#generate-vc-report').on('click', function() {
        const params = { classLevel: classSelect.val(), classroom: classroomSelect.val(), teacherName: user.name };
        if (!params.classLevel || !params.classroom) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกระดับชั้นและห้องเรียน', 'warning');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success) {
                    renderValuesCompetenciesReportTable(result);
                    $('#vc-report-results-container').removeClass('hidden');
                } else {
                    handleError({ message: result.message || 'ไม่สามารถดึงข้อมูลรายงานได้' });
                }
            })
            .withFailureHandler(handleError)
            .getValuesCompetenciesReportData(params);
    });

    $('#download-vc-report-pdf').on('click', function() {
        const params = { classLevel: classSelect.val(), classroom: classroomSelect.val(), teacherName: user.name };
        showLoading();
        Swal.fire({ title: 'กำลังสร้างรายงาน PDF', text: 'กรุณารอสักครู่...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.url) {
                    Swal.fire({ icon: 'success', title: 'สร้างรายงานสำเร็จ!', html: `<p>คุณสามารถดาวน์โหลดไฟล์ PDF ได้จากลิงก์ด้านล่าง</p><a href="${result.url}" target="_blank" class="text-blue-500 underline">ดาวน์โหลดรายงาน PDF</a>`, confirmButtonText: 'ปิด' });
                } else {
                    handleError({ message: result.message || 'สร้าง PDF ล้มเหลว' });
                }
            })
            .withFailureHandler(function(error) {
                Swal.close();
                handleError(error);
            })
            .createValuesCompetenciesReportPdf(params);
    });
}

function renderValuesCompetenciesReportTable(data) {
    const { reportData, items, reportDetails } = data; 
    const headerDiv = document.getElementById('vc-report-header');
    const head = $('#vc-report-table-head');
    const body = $('#vc-report-table-body');
    head.empty();
    body.empty();

    if (headerDiv && reportDetails) {
        headerDiv.innerHTML = `<h3 class="text-xl font-bold">รายงานสรุปผลค่านิยมและสมรรถนะ</h3><p class="text-md text-gray-700">ระดับชั้น: ${reportDetails.classLevel} ห้อง: ${reportDetails.classroom}</p><p class="text-sm text-gray-600">ครูผู้ประเมิน: ${reportDetails.teacherName}</p>`;
    }

    if (!reportData || reportData.length === 0) {
        body.html('<tr><td class="text-center p-4" colspan="20">ไม่พบข้อมูลการประเมิน</td></tr>');
        return;
    }

    const valuesItems = items.filter(i => i.itemGroup === 'ค่านิยมหลักของคนไทย 12 ประการ');
    const competenciesItems = items.filter(i => i.itemGroup === 'สมรรถนะสำคัญของผู้เรียน');

    let headerRow1 = '<tr>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 0px; min-width: 60px;">ลำดับ</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 60px; min-width: 120px;">รหัสนักเรียน</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 180px; min-width: 200px;">ชื่อ-นามสกุล</th>';
    
    if(valuesItems.length > 0) {
        headerRow1 += `<th colspan="${valuesItems.length}" class="text-center bg-gray-100">ค่านิยมหลัก 12 ประการ</th>`;
    }
    if(competenciesItems.length > 0) {
        headerRow1 += `<th colspan="${competenciesItems.length}" class="text-center bg-gray-100">สมรรถนะสำคัญ</th>`;
    }

    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-blue-100 z-30" style="right: 120px; min-width: 120px;">สรุป<br>(ค่านิยมฯ)</th>';
    headerRow1 += '<th rowspan="2" class="sticky top-0 bg-green-100 z-30" style="right: 0px; min-width: 120px;">สรุป<br>(สมรรถนะฯ)</th>';
    headerRow1 += '</tr>';

    let headerRow2 = '<tr>';
    items.forEach(item => {
        const itemName = item.itemName.replace(/(\d+\.\s)/, '');
        headerRow2 += `<th class="vertical-header"><div>${itemName}</div></th>`;
    });
    headerRow2 += '</tr>';

    head.html(headerRow1 + headerRow2);
    
    reportData.forEach((student, index) => {
        let rowHtml = `<tr>`;
        rowHtml += `<td class="sticky bg-white z-10 text-center" style="left: 0px;">${index + 1}</td>`;
        rowHtml += `<td class="sticky bg-white z-10" style="left: 60px;">${student.studentCode}</td>`;
        rowHtml += `<td class="sticky bg-white z-10 text-left" style="left: 180px;">${student.studentName}</td>`;
        
        items.forEach(item => {
            const score = student.scores[item.id] !== undefined ? student.scores[item.id] : '-';
            rowHtml += `<td class="text-center">${score}</td>`;
        });
        
        const passLevels = ['ผ่าน', 'ดี', 'ดีเยี่ยม'];
        const valuesResultClass = passLevels.includes(student.valuesResult) ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
        const competenciesResultClass = passLevels.includes(student.competenciesResult) ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';

        rowHtml += `<td class="sticky text-center font-bold z-10 ${valuesResultClass}" style="right: 120px;">${student.valuesResult}</td>`;
        rowHtml += `<td class="sticky text-center font-bold z-10 ${competenciesResultClass}" style="right: 0px;">${student.competenciesResult}</td>`;
        rowHtml += '</tr>';
        body.append(rowHtml);
    });
}

function initializeActivitiesReportPage() {
    // โครงสร้าง UI และ Logic คล้ายกับ characteristics report มาก
    const reportContainer = $('#activities-report');
    reportContainer.html(`
        <div class="p-2 md:p-4">
            <h2 class="text-2xl font-bold mb-6">รายงานสรุปผลกิจกรรมพัฒนาผู้เรียน</h2>
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block text-gray-700 mb-2">ระดับชั้น</label>
                        <select id="activity-report-class" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ห้องเรียน</label>
                        <select id="activity-report-classroom" class="w-full px-3 py-2 border rounded-lg"></select>
                    </div>
                    <button id="generate-activity-report" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg w-full mt-4 md:mt-0">สร้างรายงาน</button>
                </div>
            </div>
            
            <div id="activity-report-results-container" class="hidden mt-6">
                <div id="activity-report-header" class="report-header"></div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center mb-4">
                        <button id="download-activity-report-pdf" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg">ดาวน์โหลดรายงาน (PDF)</button>
                    </div>
                    <div class="overflow-x-auto report-table-container" style="max-height: 75vh;">
                         <table id="activity-report-table" class="w-full report-table">
                            <thead id="activity-report-table-head"></thead>
                            <tbody id="activity-report-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `);

    const user = appState.user;
    const classSelect = $('#activity-report-class');
    const classroomSelect = $('#activity-report-classroom');
    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    
    // Populate Filters
    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));
    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);
    classSelect.on('change', function() {
        $('#activity-report-results-container').addClass('hidden');
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
    });

    $('#generate-activity-report').on('click', function() {
        const params = { classLevel: classSelect.val(), classroom: classroomSelect.val(), teacherName: user.name };
        if (!params.classLevel || !params.classroom) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกระดับชั้นและห้องเรียน', 'warning');
            return;
        }
        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success) {
                    renderActivitiesReportTable(result);
                    $('#activity-report-results-container').removeClass('hidden');
                } else {
                    handleError({ message: result.message || 'ไม่สามารถดึงข้อมูลรายงานได้' });
                }
            })
            .withFailureHandler(handleError)
            .getActivitiesReportData(params);
    });

    $('#download-activity-report-pdf').on('click', function() {
        const params = { classLevel: classSelect.val(), classroom: classroomSelect.val(), teacherName: user.name };
        showLoading();
        Swal.fire({
            title: 'กำลังสร้างรายงาน PDF',
            text: 'กรุณารอสักครู่...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result.success && result.url) {
                    Swal.fire({
                        icon: 'success',
                        title: 'สร้างรายงานสำเร็จ!',
                        html: `<p>คุณสามารถดาวน์โหลดไฟล์ PDF ได้จากลิงก์ด้านล่าง</p><a href="${result.url}" target="_blank" class="text-blue-500 underline">ดาวน์โหลดรายงาน PDF</a>`,
                        confirmButtonText: 'ปิด'
                    });
                } else {
                    handleError({ message: result.message || 'สร้าง PDF ล้มเหลว' });
                }
            })
            .withFailureHandler(function(error) {
                Swal.close();
                handleError(error);
            })
            .createActivitiesReportPdf(params);
    });
}

function renderActivitiesReportTable(data) {
    const { reportData, components, reportDetails } = data;
    const headerDiv = document.getElementById('activity-report-header');
    const head = $('#activity-report-table-head');
    const body = $('#activity-report-table-body');
    head.empty();
    body.empty();

    if (headerDiv && reportDetails) {
        headerDiv.innerHTML = `<h3 class="text-xl font-bold">รายงานสรุปผลกิจกรรมพัฒนาผู้เรียน</h3><p class="text-md text-gray-700">ระดับชั้น: ${reportDetails.classLevel} ห้อง: ${reportDetails.classroom}</p><p class="text-sm text-gray-600">ครูผู้ประเมิน: ${reportDetails.teacherName}</p>`;
    }

    if (!reportData || reportData.length === 0) {
        body.html('<tr><td class="text-center p-4" colspan="20">ไม่พบข้อมูลการประเมิน</td></tr>');
        return;
    }

    let headerRow1 = `<tr><th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 0px; min-width: 60px;">ลำดับ</th><th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 60px; min-width: 120px;">รหัสนักเรียน</th><th rowspan="2" class="sticky top-0 bg-gray-200 z-30" style="left: 180px; min-width: 200px;">ชื่อ-นามสกุล</th>`;
    if(components.length > 0) {
        headerRow1 += `<th colspan="${components.length}" class="text-center bg-gray-100">รายการกิจกรรม</th>`;
    }
    headerRow1 += `<th rowspan="2" class="sticky top-0 bg-blue-100 z-30" style="right: 0px; min-width: 120px;">สรุปผล</th></tr>`;

    let headerRow2 = '<tr>';
    components.forEach(item => {
        headerRow2 += `<th class="vertical-header"><div>${item.componentName}</div></th>`;
    });
    headerRow2 += '</tr>';
    head.html(headerRow1 + headerRow2);

    reportData.forEach((student, index) => {
        let rowHtml = `<tr><td class="sticky bg-white z-10 text-center" style="left: 0px;">${index + 1}</td><td class="sticky bg-white z-10" style="left: 60px;">${student.studentCode}</td><td class="sticky bg-white z-10 text-left" style="left: 180px;">${student.studentName}</td>`;
        components.forEach(item => {
            const result = student.results[item.id] || '-';
            rowHtml += `<td class="text-center">${result}</td>`;
        });
        rowHtml += `<td class="sticky text-center font-bold z-10 ${student.finalResult === 'ผ่าน' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50'}" style="right: 0px;">${student.finalResult}</td></tr>`;
        body.append(rowHtml);
    });
}

function populateAttendanceFilters() {
    populateAllDropdowns();
    document.getElementById('attendance-date').value = normalizeDate(new Date()); // ตั้งค่าวันที่เป็นวันนี้
}

function loadAttendanceTable() {
    const date = normalizeDate(document.getElementById('attendance-date').value);
    const subjectId = document.getElementById('attendance-subject').value;
    const classLevel = document.getElementById('attendance-class').value;
    const classroom = document.getElementById('attendance-classroom').value;
    if (!date) { Swal.fire({ icon: 'error', title: 'ข้อมูลไม่ครบถ้วน', text: 'กรุณาเลือกวันที่' }); return; }
    showLoading();
    const { students, subjects, attendance, user } = appState;
    let filteredStudents = students;
    if (user.role === 'teacher') {
        let pairs = []; try { pairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) {}
        const validClasses = pairs.flatMap(p => p.classLevels || []);
        const validClassrooms = pairs.flatMap(p => p.classrooms || []);
        filteredStudents = filteredStudents.filter(s => validClasses.includes(s.class) && validClassrooms.includes(s.classroom || ''));
    }
    if (classLevel !== 'all') filteredStudents = filteredStudents.filter(s => s.class === classLevel);
    if (classroom) filteredStudents = filteredStudents.filter(s => s.classroom === classroom);
    if (filteredStudents.length === 0) { hideLoading(); Swal.fire({ icon: 'info', title: 'ไม่พบข้อมูล', text: 'ไม่มีนักเรียนในระดับชั้นหรือห้องเรียนที่เลือก' }); document.getElementById('attendance-list').classList.add('hidden'); return; }
    pendingAttendanceRecords = [];
    let teacherPairs = []; try { teacherPairs = JSON.parse(user.subjectClassPairs || '[]'); } catch (e) {}
    const attendanceForDay = attendance.filter(a => normalizeDate(a.date) === date);
    filteredStudents.forEach(student => {
        const subjectsForStudentClass = teacherPairs.filter(p => (p.classLevels || []).includes(student.class) && (p.classrooms || []).includes(student.classroom || '')).map(p => p.subjectId);
        const subjectsToCheck = (subjectId === 'all') ? subjectsForStudentClass : (subjectsForStudentClass.includes(subjectId) ? [subjectId] : []);
        subjectsToCheck.forEach(subId => {
            const subjectInfo = subjects.find(s => s.id === subId);
            if (!subjectInfo) return;
            const existingAttendance = attendanceForDay.find(a => a.studentId === student.id && a.subjectId === subId);
            pendingAttendanceRecords.push({ studentId: student.id, studentCode: student.code, studentName: student.name, class: student.class, classroom: student.classroom || '', subjectId: subId, subjectCode: subjectInfo.code, subjectName: subjectInfo.name, status: existingAttendance ? existingAttendance.status : 'none', remark: existingAttendance ? existingAttendance.remark : '', id: existingAttendance ? existingAttendance.id : null });
        });
    });
    if (pendingAttendanceRecords.length === 0) { hideLoading(); Swal.fire({ icon: 'info', title: 'ไม่พบข้อมูล', text: 'ไม่มีวิชาที่สามารถเช็คชื่อได้สำหรับเงื่อนไขนี้' }); document.getElementById('attendance-list').classList.add('hidden'); return; }
    renderAttendancePage(1);
    document.getElementById('attendance-list').classList.remove('hidden');
    hideLoading();
}

function renderAttendancePage(page, rowsPerPage = 30) {
    const tableBody = document.querySelector('#attendance-table tbody');
    if (!tableBody) return;
    const start = (page - 1) * rowsPerPage;
    const paginatedItems = pendingAttendanceRecords.slice(start, start + rowsPerPage);
    tableBody.innerHTML = paginatedItems.map((record, index) => { const statusTextMap = { 'none': 'ยังไม่เช็ค', 'present': 'มา', 'absent': 'ขาด', 'leave': 'ลา', 'late': 'สาย' }; const statusClassMap = { 'none': 'attendance-none', 'present': 'attendance-present', 'absent': 'attendance-absent', 'leave': 'attendance-leave', 'late': 'attendance-late' }; const isRemarkDisabled = record.status === 'present' || record.status === 'none'; return `<tr data-record-index="${start + index}"><td>${start + index + 1}</td><td>${record.studentCode || '-'}</td><td>${record.studentName}</td><td>${record.class}</td><td>${record.classroom || '-'}</td><td>${record.subjectCode || '-'}</td><td>${record.subjectName || '-'}</td><td><span class="${statusClassMap[record.status]} px-2 py-1 rounded" data-status="${record.status}">${statusTextMap[record.status]}</span></td><td><input type="text" class="remark-input" value="${record.remark || ''}" ${isRemarkDisabled ? 'disabled' : ''}></td><td><button class="mark-present bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1">มา</button><button class="mark-absent bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded mr-1">ขาด</button><button class="mark-leave bg-yellow-500 hover:bg-yellow-600 text-black px-2 py-1 rounded mr-1">ลา</button><button class="mark-late bg-pink-500 hover:bg-pink-600 text-white px-2 py-1 rounded">สาย</button></td></tr>`; }).join('');
    const container = tableBody.closest('.bg-white');
    if (!container) return;
    let paginationDiv = container.querySelector('.pagination');
    if (paginationDiv) paginationDiv.remove();
    if (pendingAttendanceRecords.length > rowsPerPage) {
        paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination';
        const totalPages = Math.ceil(pendingAttendanceRecords.length / rowsPerPage);
        const prevButton = document.createElement('button'); prevButton.textContent = 'ก่อนหน้า'; prevButton.disabled = (page === 1); prevButton.addEventListener('click', () => renderAttendancePage(page - 1)); paginationDiv.appendChild(prevButton);
        const pageInfo = document.createElement('span'); pageInfo.textContent = `หน้าที่ ${page} จาก ${totalPages}`; paginationDiv.appendChild(pageInfo);
        const nextButton = document.createElement('button'); nextButton.textContent = 'ถัดไป'; nextButton.disabled = (page === totalPages); nextButton.addEventListener('click', () => renderAttendancePage(page + 1)); paginationDiv.appendChild(nextButton);
        container.appendChild(paginationDiv);
    }
}

function initializeP5CoverPage() {
    const user = appState.user;
    const container = $('#p5-cover-container');
    const yearInput = container.find('#p5-academic-year');
    const semesterSelect = container.find('#p5-semester');
    const classSelect = container.find('#p5-class');
    const classroomSelect = container.find('#p5-classroom');
    const subjectSelect = container.find('#p5-subject');
    const resultsArea = container.find('#p5-results-area');
    const learningHoursInput = container.find('#p5-learning-hours');
    const learningAreaInput = container.find('#p5-learning-area');
    const advisorNameInput = container.find('#p5-advisor-name');
    const headAcademicNameInput = container.find('#p5-head-academic-name');
    const approvalDateInput = container.find('#p5-approval-date');

    // ส่วนของการตั้งค่า Filter ต่างๆ (ส่วนนี้ทำงานถูกต้องอยู่แล้ว)
    learningHoursInput.val('');
    learningAreaInput.val('');
    advisorNameInput.val('');
    headAcademicNameInput.val('');
    approvalDateInput.val('');

    const currentYearBE = new Date().getFullYear() + 543;
    yearInput.val(currentYearBE);

    const teacherPairs = JSON.parse(user.subjectClassPairs || '[]');
    const teacherLevels = [...new Set(teacherPairs.flatMap(p => p.classLevels || []))];
    const teacherSubjectIds = [...new Set(teacherPairs.map(p => p.subjectId))];
    const teacherSubjects = appState.subjects.filter(s => teacherSubjectIds.includes(s.id));

    classSelect.html('<option value="">-- เลือกระดับชั้น --</option>');
    teacherLevels.forEach(l => classSelect.append(`<option value="${l}">${l}</option>`));

    classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>').prop('disabled', true);
    subjectSelect.html('<option value="">-- เลือกวิชา --</option>').prop('disabled', true);

    classSelect.on('change', function() {
        const selectedLevel = $(this).val();
        const relevantClassrooms = [...new Set(teacherPairs.filter(p => (p.classLevels || []).includes(selectedLevel)).flatMap(p => p.classrooms || []))].sort();
        classroomSelect.html('<option value="">-- เลือกห้องเรียน --</option>');
        if (selectedLevel) {
            relevantClassrooms.forEach(c => classroomSelect.append(`<option value="${c}">${c}</option>`));
            classroomSelect.prop('disabled', false);
        } else {
            classroomSelect.prop('disabled', true);
        }
        subjectSelect.html('<option value="">-- เลือกวิชา --</option>').prop('disabled', true);
    });

    classroomSelect.on('change', function() {
        const selectedLevel = classSelect.val();
        const selectedClassroom = $(this).val();
        const relevantSubjects = teacherSubjects.filter(subj => {
            return teacherPairs.some(p => p.subjectId === subj.id && (p.classLevels || []).includes(selectedLevel) && (p.classrooms || []).includes(selectedClassroom));
        });
        subjectSelect.html('<option value="">-- เลือกวิชา --</option>');
        if (selectedClassroom) {
            relevantSubjects.forEach(s => subjectSelect.append(`<option value="${s.id}">${s.code} - ${s.name}</option>`));
            subjectSelect.prop('disabled', false);
        } else {
            subjectSelect.prop('disabled', true);
        }
    });

    container.find('#generate-p5-preview-btn').off('click').on('click', function() {
        const params = {
            academicYear: yearInput.val(),
            semester: semesterSelect.val(),
            classLevel: classSelect.val(),
            classroom: classroomSelect.val(),
            subjectId: subjectSelect.val(),
            teacherName: user.name,
            learningHours: learningHoursInput.val(),
            learningArea: learningAreaInput.val(),
            advisorName: advisorNameInput.val(),
            headAcademicName: headAcademicNameInput.val(),
            approvalDate: approvalDateInput.val()
        };

        if (!params.academicYear || !params.semester || !params.classLevel || !params.classroom || !params.subjectId) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลให้ครบทุกช่อง', 'warning');
            return;
        }

        const studentsInClass = appState.students.filter(s => s.class === params.classLevel && s.classroom === params.classroom);
        const studentIds = studentsInClass.map(s => s.id);
        const componentsForSubject = appState.scoreComponents.filter(c => c.subjectId === params.subjectId);
        const componentIds = componentsForSubject.map(c => c.id);

        const dataForServer = {
            params: params,
            appData: {
                settings: appState.settings,
                subjects: appState.subjects,
                students: studentsInClass,
                characteristicsScores: appState.characteristicsScores.filter(s => studentIds.includes(s.studentId)),
                valuesCompetenciesScores: appState.valuesCompetenciesScores.filter(s => studentIds.includes(s.studentId)),
                characteristicsItems: appState.characteristicsItems,
                valuesCompetenciesItems: appState.valuesCompetenciesItems,
                scoreComponents: componentsForSubject,
                scores: appState.scores.filter(s => studentIds.includes(s.studentId) && (componentIds.includes(s.componentId) || s.componentId === 'remark')),
                activityComponents: appState.activityComponents.filter(c => c.classLevel === params.classLevel && c.classroom === params.classroom),
                activityScores: appState.activityScores.filter(s => studentIds.includes(s.studentId))
            }
        };

        showLoading();
        google.script.run
            .withSuccessHandler(function(result) {
                hideLoading();
                if (result && result.success) {
                    renderP5CoverPreview(result.coverData);
                    resultsArea.removeClass('hidden');
                } else {
                    handleError({ message: (result ? result.message : "เกิดข้อผิดพลาดไม่ทราบสาเหตุ") });
                }
            })
            .withFailureHandler(handleError)
            .getP5CoverData(dataForServer);
    });
    
    // --- START: นี่คือส่วนแก้ไขที่สำคัญ นำโค้ดที่เคยทำงานได้กลับมาใช้ ---
    resultsArea.find('#download-p5-pdf-btn, #print-p5-btn').off('click').on('click', function() {
        const isPrint = $(this).attr('id') === 'print-p5-btn';
        const elementToCapture = document.getElementById('p5-preview-wrapper');

        if (!elementToCapture || elementToCapture.innerHTML.trim() === '') {
            Swal.fire('ไม่พบข้อมูล', 'กรุณากดปุ่ม "แสดงตัวอย่าง" ก่อนสร้าง PDF', 'warning');
            return;
        }

        showLoading();
        Swal.fire({
            title: 'กำลังสร้างไฟล์ PDF',
            text: 'กรุณารอสักครู่...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        // เพิ่ม CSS ชั่วคราวเพื่อให้เส้นตารางใน PDF คมชัดขึ้น
        const styleId = 'pdf-p5-fix-style';
        const cssFixes = `
            #${elementToCapture.id} .p5-details-table td, 
            #${elementToCapture.id} .p5-summary-table td, 
            #${elementToCapture.id} .p5-summary-table th {
                border: 0.5px solid black !important;
            }
        `;
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = cssFixes;
        document.head.appendChild(style);

        html2canvas(elementToCapture, {
            scale: 2.5, // เพิ่มความละเอียดของภาพที่ได้
            useCORS: true, // *** สำคัญมาก: อนุญาตให้โหลดรูปภาพจาก URL ภายนอก (โลโก้) ***
            backgroundColor: '#ffffff'
        }).then(canvas => {
            // ลบ CSS ชั่วคราวออกทันที
            const styleElement = document.getElementById(styleId);
            if (styleElement) {
                styleElement.remove();
            }

            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10; // กำหนดขอบกระดาษ 10mm
            const usableWidth = pdfWidth - (margin * 2);
            const usableHeight = pdfHeight - (margin * 2);

            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const canvasRatio = canvasHeight / canvasWidth;

            let imgWidth = usableWidth;
            let imgHeight = usableWidth * canvasRatio;
            
            if (imgHeight > usableHeight) {
                imgHeight = usableHeight;
                imgWidth = imgHeight / canvasRatio;
            }
            
            const xPosition = (pdfWidth - imgWidth) / 2;
            const yPosition = (pdfHeight - imgHeight) / 2;

            pdf.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);

            hideLoading();
            Swal.close();
            
            const subjectInfo = $('#p5-subject').find('option:selected').text().split('-')[1] || "Report";
            const fileName = `ปก-ปพ5-${subjectInfo.trim()}.pdf`;

            if (isPrint) {
                pdf.autoPrint();
                window.open(pdf.output('bloburl'), '_blank');
            } else {
                pdf.save(fileName);
            }
        }).catch(err => {
            const styleElement = document.getElementById(styleId);
            if (styleElement) {
                styleElement.remove();
            }
            hideLoading();
            Swal.close();
            handleError(err);
        });
    });
    // --- END: ส่วนแก้ไขที่สำคัญ ---
}


function renderP5CoverPreview(data) {
    const wrapper = $('#p5-preview-wrapper');
    wrapper.empty();

    // START: ส่วนที่แก้ไขใหม่ทั้งหมด - ปรับโครงสร้างตารางสรุปเกรด
    const sortedGradeOrder = ['4', '3.5', '3', '2.5', '2', '1.5', '1', '0', 'ร', 'มผ'];
    const gradeKeys = sortedGradeOrder.filter(key => data.gradeSummary.hasOwnProperty(key));

    const midIndex = Math.ceil(gradeKeys.length / 2);
    const leftKeys = gradeKeys.slice(0, midIndex);
    const rightKeys = gradeKeys.slice(midIndex);

    let gradeSummaryRowsHtml = '';
    const rowCount = leftKeys.length; // จำนวนแถวจะยึดตามฝั่งซ้ายซึ่งมีจำนวนมากกว่าหรือเท่ากันเสมอ

    for (let i = 0; i < rowCount; i++) {
        let rowHtml = '<tr>';

        // --- คอลัมน์ฝั่งซ้าย ---
        const leftKey = leftKeys[i];
        const leftValue = data.gradeSummary[leftKey];
        const leftStyle = (leftKey === 'มผ' || leftKey === 'ร') ? 'style="color: #D32F2F;"' : '';
        rowHtml += `<td class="sub-item" ${leftStyle}>ผลการเรียนระดับ ${leftKey}</td>`;
        rowHtml += `<td class="count-col">${leftValue}</td>`;

        // --- คอลัมน์ฝั่งขวา ---
        if (i < rightKeys.length) {
            const rightKey = rightKeys[i];
            const rightValue = data.gradeSummary[rightKey];
            const rightStyle = (rightKey === 'มผ' || rightKey === 'ร') ? 'style="color: #D32F2F;"' : '';
            rowHtml += `<td class="sub-item" ${rightStyle}>ผลการเรียนระดับ ${rightKey}</td>`;
            rowHtml += `<td class="count-col">${rightValue}</td>`;
        } else {
            // ถ้าฝั่งขวาไม่มีข้อมูลแล้ว ให้สร้างเป็นช่องว่างๆ เพื่อรักษารูปแบบตาราง
            rowHtml += '<td></td><td></td>';
        }

        rowHtml += '</tr>';
        gradeSummaryRowsHtml += rowHtml;
    }
    // END: ส่วนที่แก้ไขใหม่ทั้งหมด

    let activitySummaryHtml = '';
    if (data.activitySummary && data.activitySummary.length > 0) {
        const activityRows = data.activitySummary.map(act => `
            <tr>
                <td class="sub-item">${act.name}</td>
                <td class="count-col">${act.pass}</td>
                <td class="count-col">${act.fail}</td>
            </tr>
        `).join('');

        activitySummaryHtml = `
            <table class="p5-summary-table">
                <thead>
                    <tr><th colspan="3">สรุปกิจกรรมพัฒนาผู้เรียน</th></tr>
                    <tr><th style="width: 60%;">รายการกิจกรรม</th><th class="count-col" style="width: 20%;">ผ่าน (คน)</th><th class="count-col" style="width: 20%;">ไม่ผ่าน (คน)</th></tr>
                </thead>
                <tbody>
                    ${activityRows}
                </tbody>
            </table>
        `;
    }

    const approvalDateText = data.approvalDate ? `วันที่ ${formatThaiDate(data.approvalDate)}` : 'วันที่ ......... เดือน ......................... พ.ศ. .........';
    
    const signatureHtml = `
        <div class="p5-approval-section">
            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                <div class="sig-block">
                    <div class="sig-line">........................................................</div>
                    <div>( ${data.teacherName} )</div>
                    <div>ครูผู้สอน/ครูประจำวิชา</div>
                </div>
                <div class="sig-block">
                    <div class="sig-line">........................................................</div>
                    <div>( ${data.headAcademicName || '...........................................'} )</div>
                    <div>หัวหน้าวิชาการ</div>
                </div>
            </div>
            <div style="margin-top: 30px;">
                <div><input type="checkbox"> อนุมัติ &nbsp;&nbsp;&nbsp;&nbsp; <input type="checkbox"> ไม่อนุมัติ</div>
                <div class="sig-block" style="margin-top: 20px;">
                    <div class="sig-line">........................................................</div>
                    <div>( ${data.directorName} )</div>
                    <div>ผู้อำนวยการ${data.schoolTypeName}</div>
                    <div style="margin-top:15px;">${approvalDateText}</div>
                </div>
            </div>
        </div>
    `;

    const html = `
        <style>
            #p5-preview-wrapper, #p5-preview-wrapper * { font-family: 'Sarabun', sans-serif; color: black; box-sizing: border-box; }
            .p5-border { border: 2px solid black; padding: 15px; }
            .p5-header { text-align: center; line-height: 1.5; font-weight: bold; }
            .p5-logo-container { display: flex; justify-content: center; margin-bottom: 10px; }
            .p5-logo { max-height: 60px; width: auto; }
            .p5-header .main-title { font-size: 22px; }
            .p5-header .sub-title { font-size: 20px; }
            .p5-details-table, .p5-summary-table { width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 16px; }
            .p5-details-table td, .p5-summary-table td, .p5-summary-table th { border: 1px solid black; padding: 5px 8px; vertical-align: top; }
            /* ไม่จำเป็นต้องใช้ CSS ของตารางซ้อนในอีกต่อไป จึงลบส่วนนี้ออกได้เพื่อความสะอาด */
            .p5-details-table .label { font-weight: bold; width: 1%; white-space: nowrap; }
            .p5-summary-table th { font-weight: bold; text-align: center; }
            .p5-summary-table .summary-group { font-weight: bold; text-align: left; background-color: #f2f2f2;}
            .p5-summary-table .sub-item { text-align: left; padding-left: 10px;}
            .p5-summary-table .count-col { text-align: center; }
            .p5-approval-section { text-align: center; margin-top: 30px; font-size: 16px; width: 100%; }
            .p5-approval-section .sig-line { margin-bottom: 5px; }
            .p5-approval-section .sig-block { display: inline-block; width: 45%; }
        </style>
        <div class="p5-border">
            <div class="p5-logo-container">
                <img src="${data.logoBase64}" class="p5-logo" alt="School Logo">
            </div>
            <div class="p5-header">
                <div class="main-title">สมุดบันทึกการพัฒนาคุณภาพผู้เรียน (ปพ.5)</div>
                <div class="sub-title">${data.schoolName}</div>
                <div>${data.schoolArea}</div>
            </div>

            <table class="p5-details-table">
                <tr><td class="label">ชั้น</td><td>${data.classLevel}</td><td class="label">ภาคเรียนที่</td><td>${data.semester}</td><td class="label">ปีการศึกษา</td><td>${data.academicYear}</td></tr>
                <tr><td class="label">รายวิชา</td><td>${data.subjectName}</td><td class="label">รหัส</td><td>${data.subjectCode}</td><td class="label">เวลาเรียน</td><td>${data.learningHours}</td></tr>
                <tr><td class="label" colspan="2">กลุ่มสาระการเรียนรู้</td><td colspan="4">${data.learningArea}</td></tr>
                <tr><td class="label" colspan="2">ครูผู้สอน/ครูประจำวิชา</td><td colspan="4">${data.teacherName}</td></tr>
                <tr><td class="label" colspan="2">ครูที่ปรึกษา</td><td colspan="4">${data.advisorName}</td></tr>
            </table>

            <table class="p5-summary-table">
                <tr><th style="width: 75%;">ข้อมูลนักเรียน</th><th class="count-col" style="width: 25%;">รวม (คน)</th></tr>
                <tr><td class="sub-item">จำนวนนักเรียนทั้งหมด</td><td class="count-col">${data.studentTotal}</td></tr>
            </table>
            
            <table class="p5-summary-table">
                <thead>
                    <tr><th colspan="4">สรุปผลสัมฤทธิ์ทางการเรียน</th></tr>
                    <tr>
                        <th style="width: 35%;">ระดับผลการเรียน</th>
                        <th class="count-col" style="width: 15%;">จำนวน (คน)</th>
                        <th style="width: 35%;">ระดับผลการเรียน</th>
                        <th class="count-col" style="width: 15%;">จำนวน (คน)</th>
                    </tr>
                </thead>
                <tbody>
                    ${gradeSummaryRowsHtml}
                </tbody>
            </table>
            ${activitySummaryHtml}
            <table class="p5-summary-table">
                <thead><tr><th style="width: 40%;">สรุปผลการประเมิน</th><th style="width: 15%;">ไม่ผ่าน (คน)</th><th style="width: 15%;">ผ่าน (คน)</th><th style="width: 15%;">ดี (คน)</th><th style="width: 15%;">ดีเยี่ยม (คน)</th></tr></thead>
                <tbody>
                    <tr><td class="sub-item">คุณลักษณะอันพึงประสงค์</td><td class="count-col">${data.evaluationSummary.characteristics['ไม่ผ่าน']}</td><td class="count-col">${data.evaluationSummary.characteristics['ผ่าน']}</td><td class="count-col">${data.evaluationSummary.characteristics['ดี']}</td><td class="count-col">${data.evaluationSummary.characteristics['ดีเยี่ยม']}</td></tr>
                    <tr><td class="sub-item">การอ่าน คิดวิเคราะห์ และเขียน</td><td class="count-col">${data.evaluationSummary.reading['ไม่ผ่าน']}</td><td class="count-col">${data.evaluationSummary.reading['ผ่าน']}</td><td class="count-col">${data.evaluationSummary.reading['ดี']}</td><td class="count-col">${data.evaluationSummary.reading['ดีเยี่ยม']}</td></tr>
                    <tr><td class="sub-item">ค่านิยม 12 ประการ</td><td class="count-col">${data.evaluationSummary.values['ไม่ผ่าน']}</td><td class="count-col">${data.evaluationSummary.values['ผ่าน']}</td><td class="count-col">${data.evaluationSummary.values['ดี']}</td><td class="count-col">${data.evaluationSummary.values['ดีเยี่ยม']}</td></tr>
                    <tr><td class="sub-item">สมรรถนะสำคัญของผู้เรียน</td><td class="count-col">${data.evaluationSummary.competencies['ไม่ผ่าน']}</td><td class="count-col">${data.evaluationSummary.competencies['ผ่าน']}</td><td class="count-col">${data.evaluationSummary.competencies['ดี']}</td><td class="count-col">${data.evaluationSummary.competencies['ดีเยี่ยม']}</td></tr>
                    </tbody>
            </table>

            ${signatureHtml}
        </div>
    `;
    wrapper.html(html);
}

$.validator.addMethod("alphanumeric", function(value, element) {
    return this.optional(element) || /^[a-zA-Z0-9]+$/.test(value);
}, "ชื่อผู้ใช้ต้องประกอบด้วยภาษาอังกฤษและตัวเลขเท่านั้น");

$(document).ready(function() {
    console.log('Initializing application interface...');
    waitForGoogleScriptRun(() => {
        const userStr = sessionStorage.getItem('user');
        const initialDataStr = sessionStorage.getItem('initialData');

        if (!userStr || !initialDataStr) {
            // โหลดหน้า login (เหมือนเดิม)
            return;
        }

        appState.user = JSON.parse(userStr);
        initializeAppState(JSON.parse(initialDataStr));
        appState.isDataLoaded = true;
        
        initializeNavigation();
        populateAllDropdowns();

        const user = appState.user;
        if (user.role === 'teacher') {
            const teacherMode = sessionStorage.getItem('teacherChoiceMode');
            if (!teacherMode) {
                const teacherName = appState.user.name;
                $('#teacher-choice-modal h2').text(`ยินดีต้อนรับ, คุณครู ${teacherName}`);
                
                // ถ้ายังไม่ได้เลือกโหมด -> แสดง Modal
                $('#pre-choice-overlay').show();
                showTeacherChoiceModal();
            } else {
                // **** START: EDIT ****
                // ถ้าเลือกโหมดแล้ว -> โหลด Dashboard โดยตรง
                // จากเดิม: $('.nav-tab[data-tab="dashboard"]').click();
                loadContentForTab('dashboard', false); 
                // **** END: EDIT ****
            }
        } else {
             // สำหรับ admin หรือ student ให้โหลด dashboard เลย
             loadContentForTab('dashboard', false);
        }
    });

    $('#teacher-form').validate({
        rules: {
            'teacher-username': {
                required: true,
                minlength: 3,
                alphanumeric: true
            },
            'teacher-password': {
                minlength: 6
            },
            'teacher-name': {
                required: true
            }
        },
        messages: {
            'teacher-username': {
                required: "กรุณากรอกชื่อผู้ใช้",
                minlength: "ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร",
                alphanumeric: "ชื่อผู้ใช้ต้องประกอบด้วยภาษาอังกฤษและตัวเลขเท่านั้น"
            },
            'teacher-password': {
                minlength: "รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร"
            },
            'teacher-name': {
                required: "กรุณากรอกชื่อ-นามสกุล"
            }
        },
        errorElement: 'div',
        errorClass: 'error',
        errorPlacement: function(error, element) { error.insertAfter(element); }
    });

   // Event Handlers for Teacher Choice Modal
$('#choice-go-to-attendance, #choice-go-to-scoring, #choice-go-to-characteristics, #choice-go-to-activities, #choice-go-to-values-competencies, #choice-go-to-p5-cover').off('click').on('click', function() {
    let choice = 'attendance'; // default
    const id = $(this).attr('id');
    if (id === 'choice-go-to-scoring') {
        choice = 'scoring';
    } else if (id === 'choice-go-to-characteristics') {
        choice = 'characteristics';
    } else if (id === 'choice-go-to-values-competencies') {
        choice = 'values-competencies';
    } else if (id === 'choice-go-to-activities') {
        choice = 'activities';
    } else if (id === 'choice-go-to-p5-cover') {
        choice = 'p5-cover';
    }
    
    sessionStorage.setItem('teacherChoiceMode', choice);
    
    $('#pre-choice-overlay').hide();
    closeModal('teacher-choice-modal');
    
    initializeNavigation();

    const firstTabOfMode = $('#nav-tabs .nav-tab:first').data('tab');
    loadContentForTab(firstTabOfMode, true);
});

        // --- START: เพิ่ม Event Listener สำหรับปุ่มใหม่ ---
    $('#choice-go-to-characteristics').on('click', function() {
        sessionStorage.setItem('teacherChoiceMode', 'characteristics');
        $('#pre-choice-overlay').hide();
        closeModal('teacher-choice-modal');
        initializeNavigation();
        // โหลดหน้าคุณลักษณะฯ เป็นหน้าแรกของโหมดนี้
        loadContentForTab('characteristics', true);
    });
    // --- END: เพิ่ม Event Listener สำหรับปุ่มใหม่ ---

 // --- เพิ่ม Event Listener สำหรับปุ่มย้อนกลับ ---
    $('#back-to-choice-btn').on('click', function() {
        if (appState.user.role !== 'teacher') return;
        
        Swal.fire({
            title: 'กลับไปหน้าเลือกเมนู?',
            text: "คุณต้องการกลับไปที่หน้าเลือกเมนูหลักใช่หรือไม่?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: 'var(--primary-color)',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ใช่, กลับไป',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                sessionStorage.removeItem('teacherChoiceMode');
                $('#pre-choice-overlay').show();
                showTeacherChoiceModal();
                // ซ่อนเนื้อหาหลักและปุ่มย้อนกลับชั่วคราว
                $('main > .tab-content').removeClass('active');
                $('#back-to-choice-btn').addClass('hidden');
            }
        });
    });

$(document).on('click', '.edit-subject', function() {
    const subjectId = $(this).data('id');
    const subject = appState.subjects.find(s => s.id === subjectId);
    if (subject) {
        $('#subject-modal-title').text('แก้ไขรายวิชา');
        $('#subject-id').val(subject.id);
        $('#subject-code').val(subject.code);
        $('#subject-name').val(subject.name);
        // --- START: ส่วนที่แก้ไข ---
        // แสดงข้อมูลหน่วยกิตเดิมเมื่อแก้ไข
        $('#subject-credits').val(subject.credits || ''); 
        // --- END: ส่วนที่แก้ไข ---
        openModal('subject-modal');
    }
});

$(document).on('click', '.delete-subject', function() { 
    const subjectId = $(this).data('id'); 
    Swal.fire({ 
        title: 'ยืนยันการลบ?', 
        text: "ข้อมูลรายวิชานี้และข้อมูลการเช็คชื่อที่เกี่ยวข้องทั้งหมดจะถูกลบอย่างถาวร!", 
        icon: 'warning', 
        showCancelButton: true, 
        confirmButtonColor: '#d33', 
        cancelButtonColor: '#3085d6', 
        confirmButtonText: 'ใช่, ลบเลย!', 
        cancelButtonText: 'ยกเลิก' 
    }).then(result => { 
        if (result.isConfirmed) { 
            showLoading(); 
            google.script.run
                .withSuccessHandler(() => { 
                    // ลบรายวิชาออกจาก appState.subjects
                    appState.subjects = appState.subjects.filter(s => s.id !== subjectId);
                    // ลบข้อมูลการเช็คชื่อที่เกี่ยวข้อง
                    appState.attendance = appState.attendance.filter(a => a.subjectId !== subjectId);
                    // รีเฟรชตารางรายวิชา
                    loadSubjects();
                    Swal.fire('ลบแล้ว!', 'ข้อมูลรายวิชาถูกลบเรียบร้อยแล้ว.', 'success'); 
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .deleteData('subjects', subjectId); 
        } 
    }); 
});

    $(document).on('click', '.edit-teacher', function() { 
        const teacherId = $(this).data('id'); 
        const teacher = appState.teachers.find(t => t.id === teacherId); 
        if (teacher) { 
            $('#teacher-modal-title').text('แก้ไขครูผู้สอน'); 
            $('#teacher-id').val(teacher.id); 
            $('#teacher-name').val(teacher.name); 
            $('#teacher-username').val(teacher.username); 
            $('#teacher-password').val('').attr('placeholder', 'ปล่อยว่างไว้หากไม่ต้องการเปลี่ยนรหัสผ่าน'); 
            let pairs = []; 
            try { pairs = JSON.parse(teacher.subjectClassPairs || '[]'); } catch(e){} 
            initializeSubjectClassTable(pairs, appState.classLevelSettings.enabledLevels); 
            openModal('teacher-modal'); 
        } 
    });

$(document).on('click', '.delete-teacher', function() { 
    const teacherId = $(this).data('id'); 
    Swal.fire({ 
        title: 'ยืนยันการลบ?', 
        text: "ถ้าลบครูคนนี้ ข้อมูลการเช็คเวลาเรียนของครูคนนี้ถูกลบออกจากระบบด้วย คุณแน่ใจใช่ไหม?", 
        icon: 'warning', 
        showCancelButton: true, 
        confirmButtonColor: '#d33', 
        cancelButtonColor: '#3085d6', 
        confirmButtonText: 'ใช่, ลบเลย!', 
        cancelButtonText: 'ยกเลิก' 
    }).then(result => { 
        if (result.isConfirmed) { 
            showLoading(); 
            google.script.run
                .withSuccessHandler(() => { 
                    // ลบครูออกจาก appState.teachers
                    const teacher = appState.teachers.find(t => t.id === teacherId);
                    appState.teachers = appState.teachers.filter(t => t.id !== teacherId);
                    // ลบข้อมูลการเช็คชื่อที่เกี่ยวข้อง
                    if (teacher) {
                        appState.attendance = appState.attendance.filter(a => a.teacherName !== teacher.name);
                    }
                    // รีเฟรชตารางครู
                    loadTeachers();
                    Swal.fire('ลบแล้ว!', 'ข้อมูลครูถูกลบเรียบร้อยแล้ว.', 'success'); 
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .deleteData('teachers', teacherId); 
        } 
    }); 
});

    $(document).on('click', '.reset-password', function() { 
    const teacherId = $(this).data('id'); 
    Swal.fire({ 
        title: 'รีเซ็ตรหัสผ่าน', 
        text: 'กรุณากรอกรหัสผ่านใหม่สำหรับครูท่านนี้', 
        input: 'password', 
        inputPlaceholder: 'รหัสผ่านใหม่ (อย่างน้อย 6 ตัวอักษร)', 
        showCancelButton: true, 
        confirmButtonColor: 'var(--primary-color)', 
        cancelButtonColor: '#3085d6', 
        confirmButtonText: 'บันทึก', 
        cancelButtonText: 'ยกเลิก', 
        inputValidator: (value) => { 
            if (!value || value.length < 6) { 
                return 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร'; 
            } 
        } 
    }).then(result => { 
        if (result.isConfirmed) { 
            showLoading(); 
            const newPassword = result.value; 
            google.script.run
                .withSuccessHandler(() => { 
                    // อัปเดตสถานะ resetRequested ใน appState.teachers
                    const index = appState.teachers.findIndex(t => t.id === teacherId);
                    if (index !== -1) {
                        appState.teachers[index] = { ...appState.teachers[index], resetRequested: false };
                    }
                    // รีเฟรชตารางครู
                    loadTeachers();
                    Swal.fire('สำเร็จ!', 'รีเซ็ตรหัสผ่านครูเรียบร้อยแล้ว.', 'success'); 
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .resetTeacherPassword(teacherId, newPassword); 
        } 
    }); 
});

    $(document).on('click', '.edit-student', function() { 
        const studentId = $(this).data('id'); 
        const student = appState.students.find(s => s.id === studentId); 
        if (student) { 
            const currentUserRole = appState.user.role; 
            if (currentUserRole === 'admin') { 
                $('#student-modal-title').text('แก้ไขข้อมูลนักเรียน'); 
                $('#student-id').val(student.id); 
                $('#student-code').val(student.code); 
                $('#student-name').val(student.name); 
                const classSelect = document.getElementById('student-class'); 
                classSelect.innerHTML = '<option value="">เลือก</option>'; 
                if(appState.classLevelSettings && appState.classLevelSettings.enabledLevels) { 
                    appState.classLevelSettings.enabledLevels.forEach(level => { 
                        const option = document.createElement('option'); 
                        option.value = level; 
                        option.textContent = level; 
                        if (level === student.class) { option.selected = true; } 
                        classSelect.appendChild(option); 
                    }); 
                } 
                $('#student-classroom').val(student.classroom); 
                openModal('student-modal'); 
            } else if (currentUserRole === 'teacher') { 
                $('#teacher-student-modal-title').text('แก้ไขข้อมูลนักเรียน'); 
                $('#teacher-student-id').val(student.id); 
                $('#teacher-student-code').val(student.code); 
                $('#teacher-student-name').val(student.name); 
                openModal('teacher-student-modal'); 
            } 
        } 
    });

$(document).on('click', '.delete-student', function() { 
    const studentId = $(this).data('id'); 
    Swal.fire({ 
        title: 'ยืนยันการลบ?', 
        text: "ข้อมูลนักเรียนคนนี้จะถูกลบออกจากระบบ!", 
        icon: 'warning', 
        showCancelButton: true, 
        confirmButtonColor: '#d33', 
        cancelButtonColor: '#3085d6', 
        confirmButtonText: 'ใช่, ลบเลย!', 
        cancelButtonText: 'ยกเลิก' 
    }).then(result => { 
        if (result.isConfirmed) { 
            showLoading(); 
            google.script.run
                .withSuccessHandler(() => { 
                    // ลบนักเรียนออกจาก appState.students
                    appState.students = appState.students.filter(s => s.id !== studentId);
                    // ลบข้อมูลการเช็คชื่อที่เกี่ยวข้อง
                    appState.attendance = appState.attendance.filter(a => a.studentId !== studentId);
                    // รีเฟรชตารางนักเรียน
                    loadStudents();
                    // อัปเดต dropdown ห้องเรียน
                    populateClassroomDropdowns(appState.students);
                    Swal.fire('ลบแล้ว!', 'ข้อมูลนักเรียนถูกลบเรียบร้อยแล้ว.', 'success'); 
                    hideLoading();
                })
                .withFailureHandler(handleError)
                .deleteData('students', studentId); 
        } 
    }); 
});

    $(document).on('click', '#attendance-table button', function(e) { 
        const target = e.currentTarget; 
        const row = target.closest('tr'); 
        if (!row || row.dataset.recordIndex === undefined) return; 
        const recordIndex = parseInt(row.dataset.recordIndex, 10); 
        const record = pendingAttendanceRecords[recordIndex]; 
        if (!record) return; 
        let newStatus = record.status; 
        if ($(target).hasClass('mark-present')) newStatus = 'present'; 
        else if ($(target).hasClass('mark-absent')) newStatus = 'absent'; 
        else if ($(target).hasClass('mark-leave')) newStatus = 'leave'; 
        else if ($(target).hasClass('mark-late')) newStatus = 'late'; 
        else return; 
        record.status = newStatus; 
        const statusTextMap = { 'present': 'มา', 'absent': 'ขาด', 'leave': 'ลา', 'late': 'สาย' }; 
        const statusClassMap = { 'present': 'attendance-present', 'absent': 'attendance-absent', 'leave': 'attendance-leave', 'late': 'attendance-late' }; 
        const statusSpan = row.querySelector('td:nth-child(8) span'); 
        if (statusSpan) { 
            statusSpan.textContent = statusTextMap[newStatus] || 'ยังไม่เช็ค'; 
            statusSpan.className = `px-2 py-1 rounded ${statusClassMap[newStatus] || 'attendance-none'}`; 
        } 
        const remarkInput = row.querySelector('.remark-input'); 
        if (remarkInput) { 
            remarkInput.disabled = (newStatus === 'present' || newStatus === 'none'); 
            if (remarkInput.disabled) { 
                remarkInput.value = ''; 
                record.remark = ''; 
            } 
        } 
    });

    $(document).on('input', '.remark-input', function(e) { 
        const row = e.target.closest('tr'); 
        if (!row || row.dataset.recordIndex === undefined) return; 
        const recordIndex = parseInt(row.dataset.recordIndex, 10); 
        if (pendingAttendanceRecords && pendingAttendanceRecords[recordIndex]) { 
            pendingAttendanceRecords[recordIndex].remark = e.target.value; 
        } 
    });

    $('.theme-button').on('click', function() { 
        const selectedColor = $(this).data('color'); 
        applyTheme(selectedColor); 
        $('#theme-color').val(selectedColor); 
        $('.theme-button').removeClass('active'); 
        $(this).addClass('active'); 
    });

    $('#filter-students').on('click', loadStudents);

    $('#start-attendance').on('click', loadAttendanceTable);

  document.getElementById('subject-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!$('#subject-form').valid()) return;
    const subjectId = document.getElementById('subject-id').value;
    const data = {
        code: document.getElementById('subject-code').value,
        name: document.getElementById('subject-name').value,
        // --- START: ส่วนที่แก้ไข ---
        credits: document.getElementById('subject-credits').value // เพิ่มการดึงข้อมูลหน่วยกิต
        // --- END: ส่วนที่แก้ไข ---
    };
    waitForGoogleScriptRun(() => {
        showLoading();
        const timeout = setTimeout(() => {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'การบันทึกล่าช้า',
                text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                confirmButtonColor: 'var(--primary-color)'
            });
        }, 30000);
        const action = subjectId ? 'updateData' : 'addData';
        const params = subjectId ? ['subjects', subjectId, data] : ['subjects', data];
        google.script.run
            .withSuccessHandler((result) => {
                clearTimeout(timeout);
                hideLoading();
                closeModal('subject-modal');
                // อัปเดต appState.subjects
                if (subjectId) {
                    const index = appState.subjects.findIndex(s => s.id === subjectId);
                    if (index !== -1) {
                        appState.subjects[index] = { ...appState.subjects[index], ...data };
                    }
                } else {
                    appState.subjects.push({ id: result.id, ...data });
                }
                loadSubjects();
                Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ!',
                    text: subjectId ? 'อัปเดตรายวิชาเรียบร้อยแล้ว' : 'เพิ่มรายวิชาเรียบร้อยแล้ว',
                    confirmButtonColor: 'var(--primary-color)'
                });
            })
            .withFailureHandler(error => {
                clearTimeout(timeout);
                handleError(error);
            })[action](...params);
    });
});

  document.getElementById('teacher-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!$('#teacher-form').valid()) return;
    const teacherId = document.getElementById('teacher-id').value;
    const rows = document.querySelectorAll('#subject-class-table tbody tr');
    const subjectClassPairs = [];
    let valid = true;
    rows.forEach(row => {
        const subjectId = row.querySelector('.subject-select').value;
        const classLevels = $(row.querySelector('.class-select')).val() || [];
        const classrooms = $(row.querySelector('.classroom-select')).val() || [];
        if (subjectId && classLevels.length > 0 && classrooms.length > 0) {
            subjectClassPairs.push({ subjectId, classLevels, classrooms });
        } else { valid = false; }
    });
    if (!valid || subjectClassPairs.length === 0) { 
        Swal.fire({ 
            icon: 'error', 
            title: 'ข้อมูลไม่ครบถ้วน', 
            text: 'กรุณาเลือกวิชา ระดับชั้น และห้องเรียนให้ครบทุกแถว (อย่างน้อย 1 แถว)', 
            confirmButtonColor: 'var(--primary-color)' 
        }); 
        return; 
    }
    const teacherPassword = document.getElementById('teacher-password').value;
    const data = { 
        name: document.getElementById('teacher-name').value, 
        username: document.getElementById('teacher-username').value, 
        subjectClassPairs: JSON.stringify(subjectClassPairs), 
        subjectIds: [...new Set(subjectClassPairs.map(p => p.subjectId))].join(','), 
        classLevels: [...new Set(subjectClassPairs.flatMap(p => p.classLevels))].join(',') 
    };
    if (teacherPassword) data.password = teacherPassword;
    if (teacherId) data.resetRequested = false;
    waitForGoogleScriptRun(() => {
        showLoading();
        const timeout = setTimeout(() => {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'การบันทึกล่าช้า',
                text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                confirmButtonColor: 'var(--primary-color)'
            });
        }, 30000);
        const action = teacherId ? 'updateData' : 'addData';
        const params = teacherId ? ['teachers', teacherId, data] : ['teachers', data];
        google.script.run
            .withSuccessHandler((result) => { 
                clearTimeout(timeout);
                hideLoading();
                closeModal('teacher-modal'); 
                // อัปเดต appState.teachers
                const teacherData = { 
                    id: teacherId || result.id, 
                    name: data.name, 
                    username: data.username, 
                    subjectIds: data.subjectIds, 
                    classLevels: data.classLevels, 
                    subjectClassPairs: data.subjectClassPairs, 
                    resetRequested: false 
                };
                if (teacherId) {
                    // อัปเดตข้อมูลครูที่มีอยู่
                    const index = appState.teachers.findIndex(t => t.id === teacherId);
                    if (index !== -1) {
                        appState.teachers[index] = teacherData;
                    }
                } else {
                    // เพิ่มครูใหม่
                    appState.teachers.push(teacherData);
                }
                // รีเฟรชตารางครู
                loadTeachers();
                Swal.fire({ 
                    icon: 'success', 
                    title: 'สำเร็จ!', 
                    text: teacherId ? 'อัปเดตครูผู้สอนเรียบร้อยแล้ว' : 'เพิ่มครูผู้สอนเรียบร้อยแล้ว', 
                    confirmButtonColor: 'var(--primary-color)' 
                }); 
            })
            .withFailureHandler(error => {
                clearTimeout(timeout);
                handleError(error);
            })[action](...params);
    });
});

   document.getElementById('student-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!$('#student-form').valid()) return;
    const studentId = document.getElementById('student-id').value;
    const data = { 
        code: document.getElementById('student-code').value, 
        name: document.getElementById('student-name').value, 
        class: document.getElementById('student-class').value, 
        classroom: document.getElementById('student-classroom').value 
    };
    waitForGoogleScriptRun(() => {
        showLoading();
        const timeout = setTimeout(() => {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'การบันทึกล่าช้า',
                text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                confirmButtonColor: 'var(--primary-color)'
            });
        }, 30000);
        const action = studentId ? 'updateData' : 'addData';
        const params = studentId ? ['students', studentId, data] : ['students', data];
        google.script.run
            .withSuccessHandler((result) => { 
                clearTimeout(timeout);
                hideLoading();
                closeModal('student-modal'); 
                // อัปเดต appState.students
                if (studentId) {
                    // อัปเดตข้อมูลนักเรียนที่มีอยู่
                    const index = appState.students.findIndex(s => s.id === studentId);
                    if (index !== -1) {
                        appState.students[index] = { ...appState.students[index], ...data };
                    }
                } else {
                    // เพิ่มนักเรียนใหม่
                    appState.students.push({ id: result.id, ...data });
                }
                // รีเฟรชตารางนักเรียน
                loadStudents();
                // อัปเดต dropdown ห้องเรียน
                populateClassroomDropdowns(appState.students);
                Swal.fire({ 
                    icon: 'success', 
                    title: 'สำเร็จ!', 
                    text: studentId ? 'อัปเดตนักเรียนเรียบร้อยแล้ว' : 'เพิ่มนักเรียนเรียบร้อยแล้ว', 
                    confirmButtonColor: 'var(--primary-color)' 
                }); 
            })
            .withFailureHandler(error => {
                clearTimeout(timeout);
                handleError(error);
            })[action](...params);
    });
});

   document.getElementById('teacher-student-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!$('#teacher-student-form').valid()) return;
    const studentId = document.getElementById('teacher-student-id').value;
    const data = { 
        code: document.getElementById('teacher-student-code').value, 
        name: document.getElementById('teacher-student-name').value 
    };
    waitForGoogleScriptRun(() => {
        showLoading();
        const timeout = setTimeout(() => {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'การบันทึกล่าช้า',
                text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                confirmButtonColor: 'var(--primary-color)'
            });
        }, 30000);
        google.script.run
            .withSuccessHandler(() => { 
                clearTimeout(timeout);
                hideLoading();
                closeModal('teacher-student-modal'); 
                // อัปเดต appState.students
                const index = appState.students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    appState.students[index] = { ...appState.students[index], ...data };
                }
                // รีเฟรชตารางนักเรียน
                loadStudents();
                Swal.fire({ 
                    icon: 'success', 
                    title: 'สำเร็จ!', 
                    text: 'อัปเดตข้อมูลนักเรียนเรียบร้อยแล้ว', 
                    confirmButtonColor: 'var(--primary-color)' 
                }); 
            })
            .withFailureHandler(error => {
                clearTimeout(timeout);
                handleError(error);
            }).updateData('students', studentId, data);
    });
});

  document.getElementById('import-subjects-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('subjects-csv-file');
    if (!fileInput.files.length) { 
        Swal.fire({ icon: 'error', title: 'ไม่พบไฟล์', text: 'กรุณาเลือกไฟล์ CSV' }); 
        return; 
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        waitForGoogleScriptRun(() => {
            showLoading();
            const timeout = setTimeout(() => {
                hideLoading();
                Swal.fire({
                    icon: 'error',
                    title: 'การนำเข้าล่าช้า',
                    text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                    confirmButtonColor: 'var(--primary-color)'
                });
            }, 30000);
            google.script.run
                .withSuccessHandler(result => { 
                    clearTimeout(timeout);
                    hideLoading();
                    closeModal('import-subjects-modal'); 
                    // โหลดข้อมูลรายวิชาใหม่จากเซิร์ฟเวอร์เพื่อความถูกต้อง
                    google.script.run
                        .withSuccessHandler(newSubjects => {
                            appState.subjects = newSubjects;
                            loadSubjects();
                            Swal.fire({ 
                                icon: 'success', 
                                title: 'สำเร็จ!', 
                                text: `นำเข้ารายวิชา ${result.count} รายการเรียบร้อยแล้ว` 
                            }); 
                        })
                        .withFailureHandler(handleError)
                        .getData('subjects');
                })
                .withFailureHandler(error => {
                    clearTimeout(timeout);
                    handleError(error);
                }).importCSV('subjects', e.target.result);
        });
    };
    reader.readAsText(fileInput.files[0], 'UTF-8');
});

document.getElementById('import-students-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('students-csv-file');
    if (!fileInput.files.length) {
        Swal.fire({ icon: 'error', title: 'ไม่พบไฟล์', text: 'กรุณาเลือกไฟล์ CSV' });
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        waitForGoogleScriptRun(() => {
            showLoading(); // แสดง loading
            // --- START: ส่วนที่แก้ไข (ลบ setTimeout และ clearTimeout ออก) ---
            google.script.run
                .withSuccessHandler(result => {
                    hideLoading(); // ซ่อน loading เมื่อสำเร็จ
                    closeModal('import-students-modal');
                    google.script.run
                        .withSuccessHandler(newStudents => {
                            appState.students = newStudents;
                            loadStudents();
                            populateClassroomDropdowns(appState.students);
                            Swal.fire({
                                icon: 'success',
                                title: 'สำเร็จ!',
                                text: `นำเข้านักเรียน ${result.count} รายการเรียบร้อยแล้ว`
                            });
                        })
                        .withFailureHandler(handleError)
                        .getData('students');
                })
                .withFailureHandler(error => {
                    // handleError จะซ่อน loading เอง
                    handleError(error);
                }).importCSV('students', e.target.result);
            // --- END: ส่วนที่แก้ไข ---
        });
    };
    reader.readAsText(fileInput.files[0], 'UTF-8');
});

 document.getElementById('settings-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!$('#settings-form').valid()) return;
    const settingsData = {
        system_name: $('#system-name').val(),
        logo_url: $('#logo-url').val(),
        header_text: $('#header-text').val(),
        footer_text: $('#footer-text').val(),
        // --- START: เพิ่มส่วนนี้ ---
        school_name: $('#school-name').val(), // เพิ่มการดึงค่าจากฟอร์ม
        // --- END: เพิ่มส่วนนี้ ---
        theme_color: $('#theme-color').val(),
        school_area: $('#school-area').val(),
        director_name: $('#director-name').val()
    };
    openModal('settings-modal');
    $('#settings-confirm-form').off('submit').on('submit', function(confirmEvent) {
        confirmEvent.preventDefault();
        const adminPassword = $('#admin-password').val();
        if (!adminPassword) {
            Swal.fire({
                icon: 'error',
                title: 'ข้อมูลไม่ครบถ้วน',
                text: 'กรุณากรอกรหัสผ่านผู้ดูแลระบบ'
            });
            return;
        }
        showLoading();
        const timeout = setTimeout(() => {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'การบันทึกล่าช้า',
                text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                confirmButtonColor: 'var(--primary-color)'
            });
        }, 30000);
        google.script.run
            .withSuccessHandler(result => {
                clearTimeout(timeout);
                hideLoading();
                if (result && result.success) {
                    closeModal('settings-modal');
                    $('#admin-password').val('');
                    // อัปเดต UI ทันที
                    appState.settings = { ...settingsData };
                    $('header h1').text(settingsData.header_text);
                    $('footer p').text(settingsData.footer_text);
                    $('header img').attr('src', settingsData.logo_url);
                    applyTheme(settingsData.theme_color);
                    Swal.fire({
                        icon: 'success',
                        title: 'สำเร็จ!',
                        text: 'บันทึกการตั้งค่าระบบเรียบร้อยแล้ว'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: result.message || 'รหัสผ่านไม่ถูกต้อง'
                    });
                }
            })
            .withFailureHandler(error => {
                clearTimeout(timeout);
                handleError(error);
            }).saveSettings({ ...settingsData,
                admin_password: adminPassword
            });
    });
});

  $('#save-attendance').on('click', function() {
    const recordsToSave = pendingAttendanceRecords.filter(r => r.status !== 'none');
    if (recordsToSave.length === 0) { 
        Swal.fire({ 
            icon: 'info', 
            title: 'ไม่มีข้อมูลให้บันทึก', 
            text: 'กรุณาเช็คชื่อนักเรียนอย่างน้อยหนึ่งรายการ', 
            confirmButtonColor: 'var(--primary-color)' 
        }); 
        return; 
    }
    const date = normalizeDate(document.getElementById('attendance-date').value);
    const currentUser = appState.user;
    const recordsWithTeacherAndDate = recordsToSave.map(r => ({ ...r, teacherName: currentUser.name, date: date }));
    waitForGoogleScriptRun(() => { 
        showLoading(); 
        const timeout = setTimeout(() => {
            hideLoading();
            Swal.fire({
                icon: 'error',
                title: 'การบันทึกล่าช้า',
                text: 'เซิร์ฟเวอร์ใช้เวลานานเกินไป กรุณาลองใหม่',
                confirmButtonColor: 'var(--primary-color)'
            });
        }, 30000);
        google.script.run
            .withSuccessHandler(result => { 
                clearTimeout(timeout);
                hideLoading(); 
                if (result && result.success) { 
                    Swal.fire({ 
                        icon: 'success', 
                        title: 'สำเร็จ!', 
                        text: `บันทึกเวลาเรียน ${result.count || 0} รายการเรียบร้อยแล้ว` 
                    }); 
                    
                    // --- เริ่มส่วนที่แก้ไข ---
                    // อัปเดต appState.attendance จากข้อมูลที่ Server ส่งกลับมา
                    if (result.savedRecords && Array.isArray(result.savedRecords)) {
                        result.savedRecords.forEach(savedRecord => {
                            const normalizedRecord = { ...savedRecord, date: normalizeDate(savedRecord.date) };
                            const index = appState.attendance.findIndex(a => a.id === normalizedRecord.id);
                            if (index !== -1) {
                                // ถ้ามี ID นี้อยู่แล้ว ให้อัปเดต
                                appState.attendance[index] = normalizedRecord;
                            } else {
                                // ถ้าเป็น ID ใหม่ ให้เพิ่มเข้าไป
                                appState.attendance.push(normalizedRecord);
                            }
                        });
                    }
                    
                    // รีเฟรชตาราง attendance เพื่อแสดงผลที่ถูกต้อง
                    loadAttendanceTable();
                    // --- สิ้นสุดส่วนที่แก้ไข ---

                } else { 
                    handleError({ message: (result && result.message) ? result.message : 'การบันทึกล้มเหลว' }); 
                } 
            })
            .withFailureHandler(error => {
                clearTimeout(timeout);
                handleError(error);
            }).saveAllAttendance(recordsWithTeacherAndDate); 
    });
});

    $('#mark-all-present').on('click', function() { 
        if (!pendingAttendanceRecords || pendingAttendanceRecords.length === 0) return; 
        pendingAttendanceRecords.forEach(record => { 
            record.status = 'present'; 
            record.remark = ''; 
        }); 
        const paginationSpan = document.querySelector('#attendance-list .pagination span'); 
        const currentPage = paginationSpan ? parseInt(paginationSpan.textContent.split(' ')[1], 10) : 1; 
        renderAttendancePage(currentPage); 
    });

    $('#reset-attendance').on('click', function() { 
        if (!pendingAttendanceRecords || pendingAttendanceRecords.length === 0) return; 
        pendingAttendanceRecords.forEach(record => { 
            record.status = 'none'; 
            record.remark = ''; 
        }); 
        const paginationSpan = document.querySelector('#attendance-list .pagination span'); 
        const currentPage = paginationSpan ? parseInt(paginationSpan.textContent.split(' ')[1], 10) : 1; 
        renderAttendancePage(currentPage); 
    });
});
</script>
</body>
</html>